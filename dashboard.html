<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productivity</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='4' y='2' width='24' height='28' rx='4' fill='%23faf9f5' stroke='%23D97757' stroke-width='2'/%3E%3Crect x='8' y='0' width='16' height='5' rx='2.5' fill='%23D97757'/%3E%3Cpath d='M9 13l3 3 5-5' fill='none' stroke='%23D97757' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Crect x='20' y='12' width='5' height='2' rx='1' fill='%23c4c4c2'/%3E%3Crect x='9' y='20' width='10' height='2' rx='1' fill='%23c4c4c2'/%3E%3Crect x='9' y='25' width='7' height='2' rx='1' fill='%23c4c4c2'/%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary: #faf9f5;
      --bg-secondary: #F5F4EF;
      --bg-card: #ffffff;
      --text-primary: #141413;
      --text-secondary: #5c5c5a;
      --text-muted: #8c8c8a;
      --accent: #D97757;
      --accent-hover: #c4684a;
      --border: #e5e4df;
      --border-light: #eeeee9;
      --shadow: rgba(20, 20, 19, 0.04);
      --shadow-hover: rgba(20, 20, 19, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      padding: 20px 24px;
      line-height: 1.5;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary); }

    .header-left {
      display: flex;
      align-items: flex-start;
      gap: 0;
    }

    .view-toggle {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 8px;
      margin-left: 16px;
    }

    .view-toggle button {
      background: transparent;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      color: var(--text-muted);
      border-radius: 6px;
    }

    .view-toggle button:hover {
      color: var(--text-primary);
      background: transparent;
    }

    .view-toggle button.active {
      background: var(--bg-card);
      color: var(--text-primary);
      box-shadow: 0 1px 3px var(--shadow);
    }

    .buttons { display: flex; gap: 12px; }

    button {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.15s ease;
    }

    button:hover {
      background: var(--bg-secondary);
      border-color: var(--text-muted);
    }

    button.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    button.primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ===== TASKS STYLES ===== */

    .board {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 24px;
      flex: 1;
      min-height: 0;
    }

    .column {
      background: var(--bg-secondary);
      border-radius: 12px;
      min-width: 340px;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 100%;
    }

    .column-header {
      padding: 16px 18px;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
    }

    .column-header:active {
      cursor: grabbing;
    }

    .column.dragging-column {
      opacity: 0.5;
    }

    .column-drop-indicator {
      width: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 0 -2px;
      min-height: 100px;
    }

    .column-header .count {
      background: var(--bg-card);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .cards {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px 12px;
      min-height: 100px;
    }

    .cards.drag-over {
      background: rgba(217, 119, 87, 0.05);
      border-radius: 8px;
    }

    .task-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 10px;
      cursor: grab;
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px var(--shadow);
      position: relative;
    }

    .task-card:hover {
      box-shadow: 0 4px 12px var(--shadow-hover);
      border-color: var(--border);
    }

    .task-card .add-on-hover {
      display: none;
    }

    .task-card:hover .add-on-hover {
      display: block;
    }

    .task-card .delete-btn {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 6px;
      font-size: 14px;
      line-height: 1;
      border-radius: 4px;
    }

    .task-card:hover .delete-btn {
      display: block;
    }

    .task-card .delete-btn:hover {
      background: var(--bg-secondary);
      color: var(--accent);
    }

    .task-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .card-note {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
      margin-left: 30px;
    }

    .tag-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .tag-VD { background: #EDE9FE; color: #7C3AED; }
    .tag-CQ { background: #FEF3C7; color: #D97706; }
    .tag-AI { background: #DBEAFE; color: #2563EB; }
    .tag-BIZ { background: #FEE2E2; color: #DC2626; }
    .tag-TEAM { background: #D1FAE5; color: #059669; }
    .tag-PERSONAL { background: #F3F4F6; color: #6B7280; }

    @media (prefers-color-scheme: dark) {
      .tag-VD { background: #4C1D95; color: #C4B5FD; }
      .tag-CQ { background: #78350F; color: #FCD34D; }
      .tag-AI { background: #1E3A5F; color: #93C5FD; }
      .tag-BIZ { background: #7F1D1D; color: #FCA5A5; }
      .tag-TEAM { background: #064E3B; color: #6EE7B7; }
      .tag-PERSONAL { background: #374151; color: #9CA3AF; }
    }

    .card-source {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 10px;
      opacity: 0.6;
      transition: opacity 0.15s;
      color: var(--text-muted);
      background: var(--bg-secondary);
    }
    .card-source:hover {
      opacity: 1;
    }
    .card-source svg {
      width: 13px;
      height: 13px;
      flex-shrink: 0;
    }
    .card-source.src-slack { color: #4A154B; background: #F3E8F3; }
    .card-source.src-notion { color: #37352F; background: #F1F1EF; }
    .card-source.src-steam { color: #1B2838; background: #E3E8ED; }
    @media (prefers-color-scheme: dark) {
      .card-source.src-slack { color: #E0B0FF; background: #3A1540; }
      .card-source.src-notion { color: #CFCDC9; background: #2F2F2F; }
      .card-source.src-steam { color: #8FB8D0; background: #1B2838; }
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      margin-left: 30px;
    }

    .tag-badge {
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .tag-badge:hover {
      opacity: 0.7;
    }

    .tag-add-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 12px;
      border: 1.5px dashed var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      transition: all 0.15s;
    }
    .tag-add-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--bg-secondary);
    }

    .tag-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
      margin-left: 30px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }
    .tag-picker .tag-option {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      opacity: 0.4;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    .tag-picker .tag-option.active {
      opacity: 1;
      border-color: currentColor;
    }
    .tag-picker .tag-option:hover {
      opacity: 0.85;
    }

    .card-subtasks {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .subtask {
      padding: 3px 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      min-width: 18px;
      min-height: 18px;
      flex-shrink: 0;
      border: 2px solid var(--border);
      border-radius: 5px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      cursor: pointer;
      transition: all 0.15s ease;
      background: var(--bg-card);
    }

    .checkbox:hover {
      border-color: var(--accent);
    }

    .checkbox.checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .checkbox.checked::after {
      content: '';
      width: 5px;
      height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      margin-bottom: 2px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 40px;
      color: var(--text-muted);
    }

    .empty-state button {
      font-size: 16px;
      padding: 14px 28px;
      background: var(--accent);
      border: none;
      color: white;
    }

    .empty-state button:hover {
      background: var(--accent-hover);
    }

    .status-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.2s ease;
      box-shadow: 0 4px 20px rgba(20, 20, 19, 0.15);
      z-index: 200;
    }

    .status-bar.visible { opacity: 1; }

    .add-card {
      padding: 12px;
    }

    .add-card button {
      width: 100%;
      background: transparent;
      border: 2px dashed var(--border);
      color: var(--text-muted);
      font-weight: 500;
    }

    .add-card button:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: transparent;
    }

    .new-task-input {
      width: 100%;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 12px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: none;
    }

    .new-task-input:focus {
      outline: none;
    }

    .new-task-input::placeholder {
      color: var(--text-muted);
    }

    /* Scrollbar styling */
    .cards::-webkit-scrollbar,
    .list-view::-webkit-scrollbar {
      width: 6px;
    }

    .cards::-webkit-scrollbar-track,
    .list-view::-webkit-scrollbar-track {
      background: transparent;
    }

    .cards::-webkit-scrollbar-thumb,
    .list-view::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .cards::-webkit-scrollbar-thumb:hover,
    .list-view::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* List View Styles */
    .list-view {
      max-width: 800px;
      margin: 0 auto;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
    }

    .list-section {
      margin-bottom: 28px;
    }

    .list-section.drag-over {
      background: rgba(217, 119, 87, 0.05);
      border-radius: 8px;
      margin: 0 -12px 32px;
      padding: 0 12px;
    }

    .list-section-header {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      padding: 4px 0;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-section-header .section-title {
      cursor: pointer;
    }

    .list-section-header .section-title:hover {
      color: var(--text-primary);
    }

    .list-section-header .count {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .list-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 14px;
      margin-bottom: 6px;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      cursor: grab;
      position: relative;
      border-radius: 10px;
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .list-item:active {
      cursor: grabbing;
    }

    .list-item:hover {
      box-shadow: 0 4px 12px var(--shadow-hover);
      border-color: var(--border);
    }

    .list-item.dragging {
      opacity: 0.5;
      background: var(--bg-secondary);
    }

    .list-item .checkbox {
      margin-top: 2px;
      flex-shrink: 0;
    }

    .list-item-content {
      flex: 1;
      min-width: 0;
    }

    .list-item-title {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .list-item-title.checked {
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .list-item-note {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
      cursor: pointer;
    }

    .list-item-note:hover {
      color: var(--text-secondary);
    }

    .list-item-note.add-note {
      font-style: italic;
      display: none;
    }

    .list-item:hover .list-item-note.add-note {
      display: block;
    }

    .list-item-subtasks {
      margin-top: 8px;
      padding-left: 2px;
    }

    .list-item-subtask {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 3px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .list-item-subtask .checkbox {
      width: 16px;
      height: 16px;
      min-width: 16px;
      min-height: 16px;
      margin-top: 1px;
    }

    .list-item-subtask span {
      cursor: pointer;
    }

    .list-item-subtask span:hover {
      color: var(--text-primary);
    }

    .list-item-add-subtask {
      font-size: 13px;
      color: var(--text-muted);
      font-style: italic;
      cursor: pointer;
      padding: 3px 0;
      padding-left: 24px;
      display: none;
    }

    .list-item:hover .list-item-add-subtask {
      display: block;
    }

    .list-item-add-subtask:hover {
      color: var(--accent);
    }

    .list-item-section {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .list-item-actions {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
    }

    .list-item:hover .list-item-actions {
      display: flex;
      gap: 4px;
    }

    .list-item-actions button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 6px;
      font-size: 14px;
      line-height: 1;
      border-radius: 4px;
    }

    .list-item-actions button:hover {
      background: var(--bg-card);
      color: var(--accent);
    }

    .list-drop-indicator {
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 2px -12px;
    }

    .list-add-section {
      margin-top: 16px;
      padding: 16px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
    }

    .list-add-section:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .quick-add {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .quick-add-input {
      flex: 1;
      background: transparent;
      border: none;
      font-size: 15px;
      color: var(--text-primary);
      font-family: inherit;
      outline: none;
    }

    .quick-add-input::placeholder {
      color: var(--text-muted);
    }

    .quick-add-section {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid var(--border);
    }

    .quick-add-section:hover {
      border-color: var(--accent);
    }

    .section-picker {
      position: absolute;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 20px var(--shadow-hover);
      padding: 4px;
      z-index: 100;
    }

    .section-picker button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
      background: transparent;
      border: none;
      border-radius: 6px;
    }

    .section-picker button:hover {
      background: var(--bg-secondary);
    }

    /* ===== MEMORY STYLES ===== */

    .memory-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .memory-tab {
      background: transparent;
      color: var(--text-muted);
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s ease;
      text-transform: capitalize;
    }

    .memory-tab:hover { color: var(--text-primary); }

    .memory-tab.active {
      color: var(--text-primary);
      background: var(--bg-card);
      box-shadow: 0 1px 3px var(--shadow);
    }

    .memory-tab .count {
      background: var(--bg-secondary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 6px;
      color: var(--text-muted);
    }

    .memory-tab.active .count {
      background: var(--border-light);
    }

    .memory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .memory-flat-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .memory-flat-table th {
      text-align: left;
      padding: 10px 16px;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .memory-flat-table td {
      padding: 9px 16px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
      line-height: 1.4;
    }

    .memory-flat-table td:first-child {
      color: var(--text-muted);
      font-weight: 500;
      white-space: nowrap;
      width: 120px;
    }

    .memory-flat-table tr:last-child td {
      border-bottom: none;
    }

    .memory-flat-table tr:hover td {
      background: var(--bg-secondary);
    }

    .memory-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .memory-card:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    .memory-card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .memory-card-meta {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .memory-card-preview {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
    }

    .memory-card-fields {
      margin-top: 10px;
      font-size: 12px;
    }

    .memory-card-field {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }

    .memory-card-field-label {
      color: var(--text-muted);
      min-width: 80px;
    }

    .memory-card-field-value {
      color: var(--text-secondary);
    }

    .file-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .file-card-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .file-card-header:hover {
      background: var(--bg-secondary);
    }

    .file-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .file-card-content {
      padding: 16px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      overflow-y: auto;
      display: none;
      color: var(--text-secondary);
    }

    .file-card-content.expanded {
      display: block;
    }

    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .stat {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 16px 24px;
      min-width: 100px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 600;
      color: var(--accent);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: capitalize;
      margin-top: 4px;
    }

    .search-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-box input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    .add-btn {
      background: transparent;
      border: 2px dashed var(--border);
      color: var(--text-muted);
      padding: 40px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
    }

    .add-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .markdown-content {
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .markdown-content h1 { font-size: 1.4em; margin: 16px 0 8px; color: var(--text-primary); }
    .markdown-content h2 { font-size: 1.2em; margin: 14px 0 6px; color: var(--text-primary); }
    .markdown-content h3 { font-size: 1.1em; margin: 12px 0 4px; color: var(--text-secondary); }
    .markdown-content p { margin: 8px 0; }
    .markdown-content ul, .markdown-content ol { margin: 8px 0 8px 20px; }
    .markdown-content li { margin: 4px 0; }
    .markdown-content code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      color: var(--text-primary);
    }
    .markdown-content pre {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
      border: 1px solid var(--border-light);
    }
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 13px;
    }
    .markdown-content th, .markdown-content td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    .markdown-content th {
      background: var(--bg-secondary);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(20, 20, 19, 0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(20, 20, 19, 0.2);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover { color: var(--text-primary); }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .form-group textarea {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      line-height: 1.5;
      min-height: 300px;
      resize: vertical;
    }

    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Tab panel containers */
    .tab-panel {
      display: none;
      flex: 1;
      min-height: 0;
      flex-direction: column;
    }

    .tab-panel.active {
      display: flex;
    }

    /* Memory panel scrollable area */
    .memory-content-area {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .memory-content-area::-webkit-scrollbar {
      width: 6px;
    }

    .memory-content-area::-webkit-scrollbar-track {
      background: transparent;
    }

    .memory-content-area::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .memory-content-area::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .file-card-content::-webkit-scrollbar,
    .modal-body::-webkit-scrollbar {
      width: 6px;
    }

    .file-card-content::-webkit-scrollbar-track,
    .modal-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .file-card-content::-webkit-scrollbar-thumb,
    .modal-body::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .file-card-content::-webkit-scrollbar-thumb:hover,
    .modal-body::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* File path display */
    .file-path {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }
  
    /* ===== WEEKLY CALENDAR VIEW ===== */
    .week-calendar {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .week-nav {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0 12px;
      flex-shrink: 0;
    }

    .week-nav button {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
    }

    .week-nav .week-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      min-width: 200px;
      text-align: center;
    }

    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .day-column {
      background: var(--bg-secondary);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .day-column.is-today {
      border: 2px solid var(--accent);
    }

    .day-header {
      padding: 10px 12px 6px;
      text-align: center;
      flex-shrink: 0;
    }

    .day-header .day-name {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .day-header .day-num {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-top: 2px;
    }

    .day-column.is-today .day-num {
      color: var(--accent);
    }

    .day-tasks {
      flex: 1;
      overflow-y: auto;
      padding: 6px 8px 8px;
      min-height: 60px;
    }

    .day-tasks.drag-over {
      background: rgba(217, 119, 87, 0.08);
      border-radius: 6px;
    }

    .day-task-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: grab;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      transition: all 0.15s;
      box-shadow: 0 1px 2px var(--shadow);
      position: relative;
    }

    .day-task-card:hover {
      box-shadow: 0 3px 8px var(--shadow-hover);
    }

    .day-task-card.checked-task {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .day-task-card .day-task-section {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .day-task-card .day-task-remove {
      display: none;
      position: absolute;
      top: 4px;
      right: 4px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 3px;
      line-height: 1;
    }

    .day-task-card:hover .day-task-remove {
      display: block;
    }

    .day-task-card .day-task-remove:hover {
      background: var(--bg-secondary);
      color: var(--accent);
    }

    .unscheduled-panel {
      margin-top: 8px;
      flex-shrink: 0;
    }

    .unscheduled-toggle {
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    .unscheduled-toggle:hover {
      background: var(--border-light);
    }

    .unscheduled-toggle .arrow {
      transition: transform 0.2s;
      font-size: 10px;
    }

    .unscheduled-toggle .arrow.open {
      transform: rotate(90deg);
    }

    .unscheduled-list {
      display: none;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .unscheduled-list.open {
      display: flex;
    }

    .unscheduled-chip {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: grab;
      white-space: nowrap;
      color: var(--text-primary);
      transition: all 0.15s;
    }

    .unscheduled-chip:hover {
      border-color: var(--accent);
    }

    .unscheduled-chip.dragging {
      opacity: 0.4;
    }

    /* ===== TIMELINE VIEW ===== */
    .timeline-view {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 0 4px;
    }

    .timeline-section {
      margin-bottom: 24px;
    }

    .timeline-section-header {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timeline-section-header .line {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .timeline-section-header .count {
      background: var(--bg-secondary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .timeline-items {
      position: relative;
      padding-left: 24px;
    }

    .timeline-items::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
      border-radius: 1px;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 6px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .timeline-dot {
      position: absolute;
      left: -20px;
      top: 6px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      border: 2px solid var(--bg-primary);
      flex-shrink: 0;
    }

    .timeline-item.is-checked .timeline-dot {
      background: var(--accent);
    }

    .timeline-item.is-checked .timeline-content {
      opacity: 0.5;
    }

    .timeline-content {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 10px 14px;
      flex: 1;
      max-width: 700px;
    }

    .timeline-content:hover {
      box-shadow: 0 2px 8px var(--shadow-hover);
    }

    .timeline-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .timeline-note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .timeline-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }

    .timeline-subtasks {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    
    /* ===== PLAN VIEW (계획하기) ===== */
    .tag-view {
      flex: 1;
      min-height: 0;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    .plan-left {
      width: 38%;
      min-width: 200px;
      max-width: 70%;
      overflow-y: auto;
      padding: 0 8px 0 4px;
      display: flex;
      flex-direction: column;
    }
    .plan-search-bar {
      position: sticky; top: 0; z-index: 5;
      padding: 6px 4px 8px; background: var(--bg-primary);
      flex-shrink: 0;
    }
    .plan-search-bar input {
      width: 100%; box-sizing: border-box;
      padding: 7px 10px 7px 30px;
      border: 1px solid var(--border); border-radius: 8px;
      background: var(--bg-secondary); color: var(--text-primary);
      font-size: 13px; outline: none;
      transition: border-color 0.15s;
    }
    .plan-search-bar input:focus { border-color: var(--accent); }
    .plan-search-bar input::placeholder { color: var(--text-muted); }
    .plan-search-wrap {
      position: relative;
    }
    .plan-search-icon {
      position: absolute; left: 9px; top: 50%; transform: translateY(-50%);
      color: var(--text-muted); font-size: 13px; pointer-events: none;
    }
    .plan-search-clear {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; font-size: 15px; padding: 0 2px; display: none;
    }
    .plan-search-clear:hover { color: var(--text-primary); }
    .plan-search-count {
      font-size: 11px; color: var(--text-muted); margin-top: 4px; padding-left: 2px;
    }
    .plan-left-scroll {
      flex: 1; overflow-y: auto; min-height: 0;
    }

    .plan-divider {
      width: 5px;
      cursor: col-resize;
      background: var(--border);
      flex-shrink: 0;
      transition: background 0.15s;
      border-radius: 3px;
      margin: 0 2px;
    }

    .plan-divider:hover, .plan-divider.dragging {
      background: var(--accent);
    }

    .plan-right {
      flex: 1;
      min-width: 300px;
      overflow-y: auto;
      padding: 0 4px 0 8px;
    }

    .plan-right-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .plan-right-header h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .plan-week-nav {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .plan-week-nav button {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .plan-week-nav button:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .plan-week-nav .plan-week-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      min-width: 70px;
      text-align: center;
    }

    .plan-cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border-light);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .plan-cal-header {
      background: var(--bg-secondary);
      padding: 6px 4px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .plan-cal-header.is-sun { color: #DC2626; }

    .plan-cal-cell {
      background: var(--bg-card);
      min-height: 90px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      transition: background 0.15s;
    }

    .plan-cal-cell.is-today {
      background: #FFF7ED;
    }

    .plan-cal-cell.is-other-month {
      opacity: 0.4;
    }

    .plan-cal-cell.drag-over {
      background: #FEF3C7;
      box-shadow: inset 0 0 0 2px var(--accent);
    }

    .plan-cal-date {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 4px;
      padding: 2px 4px;
    }

    .plan-cal-cell.is-today .plan-cal-date {
      background: var(--accent);
      color: white;
      border-radius: 10px;
      display: inline-block;
      padding: 1px 7px;
    }

    .plan-cal-cell.is-sun .plan-cal-date { color: #DC2626; }

    .plan-cal-tasks {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      overflow-y: auto;
    }

    .plan-cal-task {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 5px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: grab;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid var(--accent);
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .plan-cal-task .cal-cb {
      width: 12px; height: 12px; min-width: 12px;
      cursor: pointer; accent-color: var(--accent);
      margin: 0;
    }
    .plan-cal-task .cal-title {
      overflow: hidden; text-overflow: ellipsis;
    }

    .plan-cal-task:hover {
      background: var(--border);
    }

    .plan-cal-task.is-checked {
      opacity: 0.4;
      text-decoration: line-through;
    }

    .plan-cal-task.dragging {
      opacity: 0.4;
    }

    /* Left panel - tag groups */
    .tag-group {
      margin-bottom: 20px;
    }

    .tag-group-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--border);
    }

    .tag-group-header .tag-group-badge {
      padding: 4px 14px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .tag-group-header .tag-group-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .tag-group-items {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .tag-group-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: flex-start;
      gap: 6px;
      transition: all 0.15s;
      cursor: pointer;
      max-width: 100%;
      min-width: 210px;
      flex: 1 1 210px;
      position: relative;
    }

    .tag-group-card:hover {
      box-shadow: 0 2px 8px var(--shadow-hover);
      border-color: var(--border);
    }

    .plan-checkbox {
      width: 15px;
      height: 15px;
      min-width: 15px;
      margin-top: 2px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .plan-card-subtasks {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .plan-subtask-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .plan-subtask-item input[type="checkbox"] {
      width: 12px;
      height: 12px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .plan-sub-done {
      text-decoration: line-through;
      opacity: 0.5;
    }

    .plan-card-date {
      font-size: 10px;
      color: var(--accent);
      font-weight: 600;
      background: #FFF7ED;
      padding: 1px 6px;
      border-radius: 4px;
    }

    .tag-group-card.is-checked {
      opacity: 0.45;
    }

    .tag-group-card.dragging {
      opacity: 0.4;
    }

    .tag-group-card .tg-title {
      font-size: 12px;
    }

    .tag-group-card .tg-note {
      font-size: 11px;
    }

    .tag-group-card .tg-meta {
      font-size: 10px;
    }

    /* Bottom 3-panel section in plan view */
    .plan-bucket-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
      min-height: 36px;
      transition: all 0.15s;
    }
    .plan-bucket-panel.drag-over {
      background: #FEF3C7;
      box-shadow: inset 0 0 0 2px var(--accent);
    }
    .plan-bucket-panel.bucket-asap { border-left: 4px solid #EF4444; }
    .plan-bucket-panel.bucket-schedule { border-left: 4px solid #F59E0B; }
    .plan-bucket-panel.bucket-someday { border-left: 4px solid #3B82F6; }
    .plan-bucket-panel.bucket-maybe { border-left: 4px solid #9CA3AF; }
    .plan-bucket-header {
      font-size: 12px; font-weight: 700;
      display: flex; align-items: center; gap: 6px;
      color: var(--text-secondary); cursor: pointer; user-select: none;
    }
    .plan-bucket-header .bucket-icon { font-size: 13px; }
    .plan-bucket-header .bucket-count {
      font-weight: 400; color: var(--text-muted); font-size: 11px;
    }
    .plan-bucket-header .bucket-hint {
      font-weight: 400; color: var(--text-muted); font-size: 10px; margin-left: auto; font-style: italic;
    }
    .plan-bucket-items {
      display: flex; flex-wrap: wrap; gap: 4px;
      margin-top: 6px;
    }
    .plan-bucket-items:empty { margin-top: 0; }

    .tag-group-card .tg-check {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--border);
      flex-shrink: 0;
      margin-top: 1px;
    }

    .tag-group-card.is-checked .tg-check {
      background: var(--accent);
      border-color: var(--accent);
    }

    .tag-group-card .tg-body {
      flex: 1;
      min-width: 0;
    }

    .tag-group-card .tg-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .tag-group-card.is-checked .tg-title {
      text-decoration: line-through;
    }

    .tag-group-card .tg-note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tag-group-card .tg-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 5px;
    }

    .tag-group-card .tg-section {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 1px 8px;
      border-radius: 8px;
    }

    .tag-group-untagged {
      border-color: var(--border);
    }

    .tag-group-untagged .tag-group-badge {
      background: var(--bg-secondary);
      color: var(--text-muted);
    }

    /* ===== TASK DETAIL PANEL ===== */
    .plan-detail-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35); z-index: 9998;
      opacity: 0; transition: opacity 0.2s;
    }
    .plan-detail-overlay.show { opacity: 1; }

    .plan-detail-panel {
      position: fixed; top: 0; right: 0; bottom: 0;
      width: 420px; max-width: 92vw;
      background: var(--bg-primary);
      border-left: 1px solid var(--border);
      box-shadow: -4px 0 24px rgba(0,0,0,0.12);
      z-index: 9999;
      transform: translateX(100%); transition: transform 0.25s ease;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .plan-detail-panel.show { transform: translateX(0); }

    .plan-detail-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 18px; border-bottom: 1px solid var(--border-light);
      flex-shrink: 0;
    }
    .plan-detail-topbar h3 { margin: 0; font-size: 14px; color: var(--text-muted); font-weight: 600; }
    .plan-detail-close {
      background: none; border: none; font-size: 22px; cursor: pointer;
      color: var(--text-muted); line-height: 1; padding: 2px 6px; border-radius: 6px;
    }
    .plan-detail-close:hover { background: var(--bg-secondary); color: var(--text-primary); }

    .plan-detail-body {
      flex: 1; overflow-y: auto; padding: 18px;
      display: flex; flex-direction: column; gap: 16px;
    }

    .plan-detail-title {
      font-size: 18px; font-weight: 700; color: var(--text-primary);
      line-height: 1.35;
    }
    .plan-detail-title.is-checked { text-decoration: line-through; opacity: 0.55; }

    .plan-detail-section-label {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
    }

    .plan-detail-note {
      font-size: 13px; color: var(--text-secondary);
      background: var(--bg-secondary); border-radius: 8px; padding: 10px 12px;
      line-height: 1.5;
    }

    .plan-detail-tags { display: flex; flex-wrap: wrap; gap: 6px; }

    .plan-detail-meta-row {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .plan-detail-meta-chip {
      font-size: 11px; padding: 3px 10px; border-radius: 6px;
      background: var(--bg-secondary); color: var(--text-secondary);
      display: inline-flex; align-items: center; gap: 4px;
    }

    .plan-detail-subtasks {
      display: flex; flex-direction: column; gap: 6px;
    }
    .plan-detail-subtask {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: var(--text-secondary);
    }
    .plan-detail-subtask input[type="checkbox"] {
      width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer;
    }
    .plan-detail-subtask.is-done span { text-decoration: line-through; opacity: 0.5; }

    .plan-detail-src-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; color: var(--accent); text-decoration: none;
      padding: 6px 10px; background: var(--bg-secondary); border-radius: 8px;
    }
    .plan-detail-src-link:hover { text-decoration: underline; }
    .plan-detail-src-link svg { width: 14px; height: 14px; }

    .plan-detail-user-note-area {
      display: flex; flex-direction: column; gap: 6px;
    }
    .plan-detail-user-note {
      width: 100%; box-sizing: border-box;
      min-height: 100px; max-height: 300px; resize: vertical;
      padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 8px; background: var(--bg-card);
      color: var(--text-primary); font-size: 13px; font-family: inherit;
      line-height: 1.6; outline: none;
    }
    .plan-detail-user-note:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(249,115,22,0.15); }
    .plan-detail-user-note::placeholder { color: var(--text-muted); font-style: italic; }

    .plan-detail-actions {
      display: flex; gap: 8px; padding-top: 4px;
    }
    .plan-detail-btn {
      padding: 6px 14px; border-radius: 8px; font-size: 12px;
      font-weight: 600; cursor: pointer; border: 1px solid var(--border);
      background: var(--bg-secondary); color: var(--text-secondary);
      transition: all 0.15s;
    }
    .plan-detail-btn:hover { border-color: var(--accent); color: var(--accent); }
    .plan-detail-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .plan-detail-btn.primary:hover { opacity: 0.9; }

    /* Source mini icon in tag/week views */
    .source-mini {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      font-weight: 500;
      padding: 1px 6px;
      border-radius: 8px;
      text-decoration: none;
      opacity: 0.7;
      transition: opacity 0.15s;
    }
    .source-mini:hover { opacity: 1; }
    .source-mini svg { width: 11px; height: 11px; flex-shrink: 0; }
    .source-mini.sm-slack { color: #4A154B; background: #F3E8F3; }
    .source-mini.sm-notion { color: #37352F; background: #F1F1EF; }
    .source-mini.sm-steam { color: #1B2838; background: #E3E8ED; }
    @media (prefers-color-scheme: dark) {
      .source-mini.sm-slack { color: #E0B0FF; background: #3A1540; }
      .source-mini.sm-notion { color: #CFCDC9; background: #2F2F2F; }
      .source-mini.sm-steam { color: #8FB8D0; background: #1B2838; }
    }

    /* Google Calendar event styles */
    .gcal-event {
      background: #EBF3FE;
      border-left: 3px solid #4285F4;
      border-radius: 6px;
      padding: 5px 8px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #1A73E8;
      font-weight: 500;
      cursor: default;
    }
    .gcal-event .gcal-time {
      font-size: 10px;
      color: #5F6368;
      font-weight: 400;
    }
    .gcal-allday {
      background: #4285F4;
      color: #fff;
      border-radius: 4px;
      padding: 3px 8px;
      margin-bottom: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .week-nav .gcal-connect-btn {
      background: #4285F4 !important;
      color: #fff !important;
      border: none !important;
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
      margin-left: auto;
      white-space: nowrap;
    }
    .week-nav .gcal-connect-btn:hover { background: #3367D6 !important; }
    .week-nav .gcal-connect-btn.disconnect {
      background: var(--bg-secondary) !important;
      color: var(--text-muted) !important;
      border: 1px solid var(--border) !important;
    }
    .week-nav .gcal-connect-btn.disconnect:hover { background: #FEE2E2 !important; color: #DC2626 !important; border-color: #FCA5A5 !important; }
    .gcal-add-event-btn {
      width: 100%;
      background: transparent;
      border: 1px dashed #4285F4;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      color: #4285F4;
      cursor: pointer;
      font-family: inherit;
      margin-top: 4px;
      transition: background 0.15s;
    }
    .gcal-add-event-btn:hover { background: #EBF3FE; }
    .gcal-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .gcal-modal {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      width: 380px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    .gcal-modal h3 {
      margin-bottom: 16px;
      font-size: 16px;
      color: var(--text-primary);
    }
    .gcal-modal label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
      margin-top: 12px;
    }
    .gcal-modal label:first-of-type { margin-top: 0; }
    .gcal-modal input, .gcal-modal select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-primary);
    }
    .gcal-modal input:focus, .gcal-modal select:focus {
      outline: none;
      border-color: #4285F4;
    }
    .gcal-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .gcal-modal-actions button {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      border: none;
    }
    .gcal-modal-actions .gcal-cancel {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    .gcal-modal-actions .gcal-save {
      background: #4285F4;
      color: #fff;
    }
    .gcal-modal-actions .gcal-save:hover { background: #3367D6; }
    .gcal-events-section {
      margin-bottom: 6px;
    }
    .gcal-plan-btn, .gcal-board-btn {
      background: #4285F4 !important;
      color: #fff !important;
      border: none !important;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      margin-left: 8px;
    }
    .gcal-plan-btn:hover, .gcal-board-btn:hover { background: #3367D6 !important; }
    .gcal-plan-btn.disconnect, .gcal-board-btn.disconnect {
      background: var(--bg-secondary) !important;
      color: var(--text-muted) !important;
      border: 1px solid var(--border) !important;
    }
    .gcal-plan-btn.disconnect:hover, .gcal-board-btn.disconnect:hover {
      background: #FEE2E2 !important;
      color: #DC2626 !important;
      border-color: #FCA5A5 !important;
    }
    .board-gcal-bar {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      padding: 0 0 8px;
      flex-shrink: 0;
    }

    /* ===== QUICK ADD PANEL ===== */
    .quick-add-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35); z-index: 9998;
      opacity: 0; transition: opacity 0.2s;
      display: none; pointer-events: none;
    }
    .quick-add-overlay.show { opacity: 1; display: block; pointer-events: auto; }

    .quick-add-panel {
      position: fixed; top: 0; right: 0; bottom: 0;
      width: 360px; max-width: 92vw;
      background: var(--bg-primary);
      border-left: 1px solid var(--border);
      box-shadow: -4px 0 24px rgba(0,0,0,0.12);
      z-index: 9999;
      transform: translateX(100%); transition: transform 0.25s ease;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .quick-add-panel.show { transform: translateX(0); }

    .quick-add-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 18px; border-bottom: 1px solid var(--border-light);
      flex-shrink: 0;
    }
    .quick-add-topbar h3 { margin: 0; font-size: 14px; color: var(--text-muted); font-weight: 600; }
    .quick-add-close {
      background: none; border: none; font-size: 22px; cursor: pointer;
      color: var(--text-muted); line-height: 1; padding: 2px 6px; border-radius: 6px;
    }
    .quick-add-close:hover { background: var(--bg-secondary); color: var(--text-primary); }

    .quick-add-body {
      flex: 1; overflow-y: auto; padding: 18px;
      display: flex; flex-direction: column; gap: 16px;
    }

    .quick-add-textarea {
      width: 100%; box-sizing: border-box;
      min-height: 72px; max-height: 150px; resize: vertical;
      padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 8px; background: var(--bg-card);
      color: var(--text-primary); font-size: 14px; font-family: inherit;
      line-height: 1.6; outline: none;
    }
    .quick-add-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(249,115,22,0.15); }
    .quick-add-textarea::placeholder { color: var(--text-muted); font-style: italic; }

    .quick-add-hint {
      font-size: 11px; color: var(--text-muted); line-height: 1.5;
    }
    .quick-add-hint kbd {
      background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: 3px; padding: 1px 5px; font-size: 10px; font-family: inherit;
    }

    .quick-add-preview {
      display: flex; flex-direction: column; gap: 10px;
      padding: 12px; background: var(--bg-secondary); border-radius: 8px;
      min-height: 40px;
    }
    .quick-add-preview-empty {
      font-size: 12px; color: var(--text-muted); font-style: italic;
    }

    .quick-add-preview-row {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: var(--text-secondary);
    }
    .quick-add-preview-row .label {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
      min-width: 36px;
    }
    .quick-add-preview-row .value {
      font-weight: 500; color: var(--text-primary);
    }

    .quick-add-preview-chips {
      display: flex; flex-wrap: wrap; gap: 6px;
    }
    .quick-add-chip {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 11px; padding: 3px 10px; border-radius: 6px;
      cursor: pointer; transition: opacity 0.15s;
    }
    .quick-add-chip:hover { opacity: 0.7; }
    .quick-add-chip .chip-remove {
      font-size: 13px; line-height: 1; opacity: 0.5; margin-left: 2px;
    }
    .quick-add-chip .chip-remove:hover { opacity: 1; }

    .quick-add-manual {
      display: flex; flex-direction: column; gap: 8px;
    }
    .quick-add-manual-label {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .quick-add-manual-row {
      display: flex; flex-wrap: wrap; gap: 6px;
    }
    .quick-add-manual-btn {
      font-size: 11px; padding: 4px 10px; border-radius: 6px;
      border: 1px solid var(--border); background: var(--bg-card);
      color: var(--text-secondary); cursor: pointer; transition: all 0.15s;
    }
    .quick-add-manual-btn:hover { border-color: var(--accent); color: var(--accent); }
    .quick-add-manual-btn.selected {
      border-color: var(--accent); background: rgba(217,119,87,0.08); color: var(--accent); font-weight: 600;
    }

    .quick-add-actions {
      display: flex; gap: 8px; padding-top: 4px;
    }
    .quick-add-actions button {
      flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
    }
    .quick-add-actions .qa-submit {
      background: var(--accent); color: #fff; border: none;
    }
    .quick-add-actions .qa-submit:hover { background: var(--accent-hover); }
    .quick-add-actions .qa-submit:disabled { opacity: 0.4; cursor: default; }
    .quick-add-actions .qa-cancel {
      background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border);
    }
    .quick-add-actions .qa-cancel:hover { background: var(--bg-secondary); }

    /* ===== STAR / IMPORTANCE TOGGLE ===== */
    .star-toggle {
      background: none; border: none; cursor: pointer; padding: 0 2px;
      font-size: 16px; line-height: 1; color: var(--text-muted); transition: color 0.15s;
      flex-shrink: 0;
    }
    .star-toggle:hover { color: #F59E0B; }
    .star-toggle.starred { color: #F59E0B; }

    .star-toggle-sm {
      font-size: 13px; padding: 0 1px;
    }

    /* ===== DETAIL PANEL EDITABLE FIELDS ===== */
    .plan-detail-title-input {
      font-size: 18px; font-weight: 700; color: var(--text-primary);
      line-height: 1.35; width: 100%; border: none; border-bottom: 2px solid var(--accent);
      background: transparent; outline: none; font-family: inherit; padding: 2px 0;
    }
    .plan-detail-note-input {
      width: 100%; box-sizing: border-box; min-height: 60px; resize: vertical;
      padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px;
      background: var(--bg-card); color: var(--text-primary); font-size: 13px;
      font-family: inherit; line-height: 1.5; outline: none;
    }
    .plan-detail-note-input:focus { border-color: var(--accent); }

    .plan-detail-edit-row {
      display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
    }
    .plan-detail-edit-btn {
      font-size: 11px; padding: 4px 10px; border-radius: 6px;
      border: 1px solid var(--border); background: var(--bg-card);
      color: var(--text-secondary); cursor: pointer; transition: all 0.15s;
    }
    .plan-detail-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
    .plan-detail-edit-btn.selected {
      border-color: var(--accent); background: rgba(217,119,87,0.08); color: var(--accent); font-weight: 600;
    }

    .plan-detail-date-input {
      font-size: 13px; padding: 4px 8px; border: 1px solid var(--border);
      border-radius: 6px; background: var(--bg-card); color: var(--text-primary);
      font-family: inherit; outline: none;
    }
    .plan-detail-date-input:focus { border-color: var(--accent); }

    .quick-add-success {
      font-size: 12px; color: #059669; font-weight: 500;
      padding: 6px 10px; background: #D1FAE5; border-radius: 6px;
      text-align: center; animation: qaFadeIn 0.2s ease;
    }
    @keyframes qaFadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

    /* ===== FOCUS MODE STYLES ===== */
    .focus-view {
      display: flex;
      gap: 0;
      flex: 1;
      min-height: 0;
      height: 100%;
    }
    .focus-left {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      padding: 20px 24px;
    }
    .focus-divider {
      width: 5px;
      cursor: col-resize;
      background: var(--border);
      flex-shrink: 0;
      transition: background 0.15s;
      border-radius: 3px;
      margin: 0 2px;
    }
    .focus-divider:hover, .focus-divider.dragging {
      background: var(--accent);
    }
    .focus-right {
      width: 480px;
      min-width: 280px;
      overflow-y: auto;
      padding: 20px;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
    }
    .focus-week-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    .focus-week-bar .week-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .focus-week-bar .week-nav button {
      background: transparent;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .focus-week-bar .week-nav button:hover {
      background: var(--bg-secondary);
      border-color: var(--text-muted);
    }
    .focus-week-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 8px;
    }
    .focus-days {
      display: flex;
      gap: 4px;
      flex: 1;
    }
    .focus-day {
      flex: 1;
      text-align: center;
      padding: 8px 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .focus-day:hover {
      background: var(--bg-secondary);
    }
    .focus-day.is-today {
      background: var(--accent);
      color: white;
    }
    .focus-day.is-today .focus-day-name,
    .focus-day.is-today .focus-day-date,
    .focus-day.is-today .focus-day-dots {
      color: white;
    }
    .focus-day.is-selected {
      outline: 2px solid var(--accent);
      outline-offset: -2px;
    }
    .focus-day-name {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .focus-day-date {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-top: 2px;
    }
    .focus-day-dots {
      font-size: 10px;
      color: var(--accent);
      margin-top: 2px;
      height: 14px;
    }

    .focus-section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin: 20px 0 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .focus-section-title .count {
      background: var(--bg-secondary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .focus-event-list {
      list-style: none;
    }
    .focus-event-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 4px;
      transition: background 0.15s;
    }
    .focus-event-item:hover {
      background: var(--bg-secondary);
    }
    .focus-event-time {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      white-space: nowrap;
      min-width: 95px;
    }
    .focus-event-title {
      font-size: 13px;
      color: var(--text-primary);
    }
    .focus-event-allday {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      background: #DBEAFE;
      color: #2563EB;
      margin-bottom: 4px;
    }
    @media (prefers-color-scheme: dark) {
      .focus-event-allday { background: #1E3A5F; color: #93C5FD; }
    }

    .focus-task-list {
      list-style: none;
    }
    .focus-task-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 2px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .focus-task-item:hover {
      background: var(--bg-secondary);
    }
    .focus-task-item.is-checked .focus-task-title {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .focus-task-star {
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      flex-shrink: 0;
      width: 18px;
    }
    .focus-task-star.starred {
      color: #F59E0B;
    }
    .focus-task-title {
      font-size: 13px;
      color: var(--text-primary);
      flex: 1;
    }
    .focus-task-tags {
      display: flex;
      gap: 3px;
      margin-left: auto;
    }

    .focus-no-data {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Weekly notes - textarea + preview */
    .weekly-notes-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    .weekly-note-textarea {
      flex: 1;
      width: 100%;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-primary);
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      overflow-y: auto;
    }
    .weekly-note-preview {
      flex: 1;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-primary);
      cursor: text;
    }
    .weekly-note-preview h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin: 16px 0 6px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border-light);
    }
    .weekly-note-preview h2:first-child {
      margin-top: 0;
    }
    .weekly-note-preview h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 12px 0 4px 0;
    }
    .weekly-note-preview p {
      margin: 2px 0;
    }
    .weekly-note-preview ul, .weekly-note-preview ol {
      margin: 4px 0;
      padding-left: 20px;
    }
    .weekly-note-preview li {
      margin: 2px 0;
    }
    .weekly-note-preview li.md-task {
      list-style: none;
      margin-left: -20px;
    }
    .weekly-note-preview li.md-task input[type="checkbox"] {
      margin-right: 6px;
      accent-color: var(--accent);
      pointer-events: auto;
      cursor: pointer;
    }
    .weekly-note-preview code {
      background: var(--bg-card);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }
    .weekly-note-preview pre {
      background: var(--bg-card);
      padding: 10px 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 6px 0;
    }
    .weekly-note-preview pre code {
      background: none;
      padding: 0;
      font-size: 12px;
    }
    .weekly-note-preview blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 12px;
      color: var(--text-secondary);
      margin: 6px 0;
    }
    .weekly-note-preview strong {
      font-weight: 600;
    }
    .weekly-note-preview a {
      color: var(--accent);
      text-decoration: none;
    }
    .weekly-note-preview a:hover {
      text-decoration: underline;
    }
    .weekly-note-preview hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0;
    }

    /* ===== COMPASS MODE STYLES ===== */
    .compass-view {
      display: flex;
      gap: 0;
      flex: 1;
      min-height: 0;
      height: 100%;
    }
    .compass-left {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      padding: 20px 24px;
      border-right: 1px solid var(--border);
    }
    .compass-right {
      width: 320px;
      min-width: 320px;
      overflow-y: auto;
      padding: 20px;
      background: var(--bg-secondary);
    }

    .compass-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .compass-header h2 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }
    .compass-header button {
      background: transparent;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .compass-header button:hover {
      background: var(--bg-secondary);
      border-color: var(--text-muted);
    }

    .compass-timeline {
      position: relative;
      margin-top: 16px;
    }
    .compass-months {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .compass-month {
      flex: 1;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 6px 0 10px;
      text-transform: uppercase;
    }
    .compass-month.is-current {
      color: var(--accent);
    }

    .compass-lane {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      min-height: 44px;
    }
    .compass-lane-label {
      min-width: 64px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding-right: 8px;
    }
    .compass-lane-track {
      flex: 1;
      height: 36px;
      position: relative;
      background: var(--bg-secondary);
      border-radius: 6px;
    }
    .compass-milestone {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      z-index: 2;
      border: 2px solid var(--bg-card);
      box-shadow: 0 1px 3px var(--shadow);
    }
    .compass-milestone:hover {
      transform: translate(-50%, -50%) scale(1.3);
      box-shadow: 0 2px 8px var(--shadow-hover);
    }
    .compass-milestone-label {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: var(--text-secondary);
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .compass-milestone:hover .compass-milestone-label {
      opacity: 1;
    }
    .compass-today-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--accent);
      z-index: 1;
      opacity: 0.6;
    }
    .compass-today-line::before {
      content: 'Today';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
    }

    .compass-add-milestone {
      margin-top: 12px;
    }
    .compass-add-milestone button {
      background: transparent;
      border: 2px dashed var(--border);
      color: var(--text-muted);
      font-size: 12px;
      padding: 6px 14px;
      width: 100%;
    }
    .compass-add-milestone button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Goals panel */
    .compass-goals-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    .compass-category {
      margin-bottom: 16px;
    }
    .compass-category-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      cursor: pointer;
      user-select: none;
    }
    .compass-category-header:hover {
      color: var(--text-primary);
    }
    .compass-category-header .toggle-icon {
      font-size: 10px;
      transition: transform 0.15s;
    }
    .compass-category-header .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }
    .compass-goal-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 4px 0 4px 20px;
    }
    .compass-goal-text {
      flex: 1;
      font-size: 13px;
      color: var(--text-primary);
      border: none;
      background: transparent;
      font-family: inherit;
      padding: 2px 4px;
      border-radius: 4px;
      width: 100%;
    }
    .compass-goal-text:focus {
      outline: none;
      background: var(--bg-card);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .compass-goal-item .checkbox.checked + .compass-goal-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .compass-add-goal {
      padding-left: 20px;
      margin-top: 4px;
    }
    .compass-add-goal button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
    }
    .compass-add-goal button:hover {
      color: var(--accent);
    }

    .compass-okr-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .compass-okr-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      cursor: pointer;
      user-select: none;
    }
    .compass-okr-header:hover {
      color: var(--text-primary);
    }
    .compass-okr-objective {
      padding: 4px 0 4px 12px;
      margin-bottom: 4px;
    }
    .compass-okr-objective-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .compass-okr-kr {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 3px 0 3px 24px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .compass-okr-kr input {
      flex: 1;
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 2px 4px;
      border-radius: 4px;
    }
    .compass-okr-kr input:focus {
      outline: none;
      background: var(--bg-card);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .compass-milestone-tooltip {
      position: fixed;
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      z-index: 100;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      white-space: nowrap;
    }

    /* Milestone edit modal */
    .compass-edit-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      z-index: 300;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      min-width: 320px;
    }
    .compass-edit-modal h3 {
      font-size: 15px;
      margin-bottom: 12px;
    }
    .compass-edit-modal label {
      font-size: 12px;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 4px;
      margin-top: 10px;
    }
    .compass-edit-modal input,
    .compass-edit-modal select {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      background: var(--bg-card);
      color: var(--text-primary);
    }
    .compass-edit-modal input:focus,
    .compass-edit-modal select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .compass-edit-modal .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: flex-end;
    }
    .compass-edit-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 299;
    }

    /* ===== Review Tab ===== */
    .review-view {
      padding: 24px 0;
      max-width: 800px;
      margin: 0 auto;
      overflow-y: auto;
      height: 100%;
    }
    .review-week-nav {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .review-week-nav button {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .review-week-nav button:hover { color: var(--text-primary); }
    .review-week-nav .review-week-label {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .review-summary-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .review-stat {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 18px;
      flex: 1;
      min-width: 120px;
      text-align: center;
    }
    .review-stat .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }
    .review-stat .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .review-section {
      margin-bottom: 20px;
    }
    .review-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .review-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.6;
      resize: vertical;
      background: var(--bg-card);
      color: var(--text-primary);
    }
    .review-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .review-score-row {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .review-score-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--bg-card);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s, transform 0.15s;
    }
    .review-score-btn:hover { transform: scale(1.1); }
    .review-score-btn.active {
      border-color: var(--accent);
      background: rgba(217, 119, 87, 0.08);
    }

    /* ===== Settings Tab ===== */
    .settings-view {
      padding: 24px 0;
      max-width: 700px;
      margin: 0 auto;
      overflow-y: auto;
      height: 100%;
    }
    .settings-section-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      margin-top: 24px;
    }
    .settings-section-header:first-child { margin-top: 0; }
    .notif-permission-banner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .notif-permission-banner.granted {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .notif-permission-banner.denied {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    .notif-permission-banner.default {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .notif-permission-banner button {
      margin-left: auto;
      padding: 4px 12px;
      font-size: 12px;
      border-radius: 6px;
    }
    .routine-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .routine-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .routine-row .routine-emoji {
      font-size: 22px;
      flex-shrink: 0;
    }
    .routine-row .routine-info {
      flex: 1;
      min-width: 0;
    }
    .routine-row .routine-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .routine-row .routine-schedule {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .routine-row .routine-tab-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 20px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      flex-shrink: 0;
    }
    .routine-toggle {
      position: relative;
      width: 40px;
      height: 22px;
      flex-shrink: 0;
      cursor: pointer;
    }
    .routine-toggle input { display: none; }
    .routine-toggle-track {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--border);
      border-radius: 11px;
      transition: background 0.2s;
    }
    .routine-toggle input:checked + .routine-toggle-track {
      background: var(--accent);
    }
    .routine-toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      transition: transform 0.2s;
    }
    .routine-toggle input:checked ~ .routine-toggle-thumb {
      transform: translateX(18px);
    }
    .routine-edit-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      flex-shrink: 0;
    }
    .routine-edit-btn:hover { color: var(--text-primary); border-color: var(--text-muted); }

    </style>
</head>
<body>
  <header>
    <div class="header-left">
      <svg width="28" height="28" viewBox="0 0 32 32" style="margin-right: 12px; flex-shrink: 0;">
        <rect x="4" y="2" width="24" height="28" rx="4" fill="#faf9f5" stroke="#D97757" stroke-width="2"/>
        <rect x="8" y="0" width="16" height="5" rx="2.5" fill="#D97757"/>
        <path d="M9 13l3 3 5-5" fill="none" stroke="#D97757" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="20" y="12" width="5" height="2" rx="1" fill="#c4c4c2"/>
        <rect x="9" y="20" width="10" height="2" rx="1" fill="#c4c4c2"/>
        <rect x="9" y="25" width="7" height="2" rx="1" fill="#c4c4c2"/>
      </svg>
      <div>
        <h1>Productivity</h1>
        <div id="filePath" class="file-path"></div>
      </div>
      <div class="view-toggle" id="mainTabToggle">
        <button id="tasksTabBtn" class="active">Clarify & Plan</button>
        <button id="focusTabBtn">Weekly Focus</button>
        <button id="compassTabBtn">Compass</button>
        <button id="memoryTabBtn">Memory</button>
        <button id="reviewTabBtn">회고</button>
        <button id="settingsTabBtn">설정</button>
      </div>
    </div>
    <div class="buttons">
      <button id="gcalHeaderBtn" style="padding: 6px 14px; font-size: 13px;"></button>
      <button id="quickAddOpenBtn" class="primary" style="padding: 6px 14px; font-size: 13px;">+ Add Task</button>
      <button id="openTaskBtn">Select File</button>
      <button id="openMemoryBtn" style="display: none;">Open Folder</button>
      <button id="saveBtn" class="primary" disabled style="display: none;">Save</button>
    </div>
  </header>

  <!-- TASKS TAB PANEL -->
  <div class="tab-panel active" id="tasksPanel">
    <div class="tag-view" id="tagView" style="display: flex;"></div>
    <div class="week-calendar" id="weekView" style="display: none;"></div>
  </div>

  <!-- FOCUS TAB PANEL -->
  <div class="tab-panel" id="focusPanel">
    <div class="focus-view" id="focusView"></div>
  </div>

  <!-- COMPASS TAB PANEL -->
  <div class="tab-panel" id="compassPanel">
    <div class="compass-view" id="compassView"></div>
  </div>

  <!-- MEMORY TAB PANEL -->
  <div class="tab-panel" id="memoryPanel">
    <div id="memoryEmptyState" class="empty-state">
      <p style="margin-bottom: 24px; font-size: 18px; font-weight: 600; color: var(--text-primary);">Select your project folder</p>
      <button id="openMemoryBtnLarge">Select Folder</button>
    </div>
    <div id="memoryMainContent" style="display: none; flex-direction: column; min-height: 0; flex: 1;">
      <div class="memory-tabs" id="memoryTabsContainer"></div>
      <div class="memory-content-area">
        <div id="memoryContentContainer"></div>
      </div>
    </div>
  </div>

  <!-- REVIEW TAB PANEL -->
  <div class="tab-panel" id="reviewPanel">
    <div class="review-view" id="reviewView"></div>
  </div>

  <!-- SETTINGS TAB PANEL -->
  <div class="tab-panel" id="settingsPanel">
    <div class="settings-view" id="settingsView"></div>
  </div>

  <!-- MODAL (shared for memory) -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Edit</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button id="modalCancel">Cancel</button>
        <button id="modalSave" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- QUICK ADD PANEL -->
  <div class="quick-add-overlay" id="quickAddOverlay"></div>
  <div class="quick-add-panel" id="quickAddPanel">
    <div class="quick-add-topbar">
      <h3>새 태스크</h3>
      <button class="quick-add-close" id="quickAddClose">&times;</button>
    </div>
    <div class="quick-add-body">
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <button class="star-toggle" id="quickAddStar" title="중요" style="font-size:20px;">☆</button>
          <span style="font-size:12px;color:var(--text-muted);">중요</span>
        </div>
        <textarea class="quick-add-textarea" id="quickAddText" placeholder="태스크를 입력하세요... (예: API 문서 작성 #AI !asap @today)" rows="3"></textarea>
        <div class="quick-add-hint" style="margin-top: 6px;">
          <kbd>#태그</kbd> <kbd>!버킷</kbd> <kbd>@날짜</kbd> 또는 자연어로 입력 &middot; <kbd>Enter</kbd> 추가 &middot; <kbd>Esc</kbd> 닫기
        </div>
      </div>
      <div>
        <div class="quick-add-manual-label">인식 결과</div>
        <div class="quick-add-preview" id="quickAddPreview">
          <div class="quick-add-preview-empty">텍스트를 입력하면 자동으로 파싱됩니다</div>
        </div>
      </div>
      <div class="quick-add-manual" id="quickAddManual">
        <div class="quick-add-manual-label">태그</div>
        <div class="quick-add-manual-row" id="quickAddTagBtns"></div>
        <div class="quick-add-manual-label" style="margin-top: 4px;">버킷</div>
        <div class="quick-add-manual-row" id="quickAddBucketBtns"></div>
        <div class="quick-add-manual-label" style="margin-top: 4px;">날짜</div>
        <div class="quick-add-manual-row" id="quickAddDateBtns"></div>
      </div>
      <div id="quickAddSuccessMsg"></div>
      <div class="quick-add-actions">
        <button class="qa-cancel" id="quickAddCancelBtn">취소</button>
        <button class="qa-submit" id="quickAddSubmitBtn" disabled>추가</button>
      </div>
    </div>
  </div>

  <div class="status-bar" id="status"></div>

  <script>
    // ===== SHARED STATE =====
    let activeMainTab = 'tasks'; // 'tasks' or 'memory'
    let focusWeekOffset = 0;
    let focusSelectedDate = null;
    const LS_KEY_WEEKLY_NOTES = 'dashboard_weekly_notes';
    let weeklyNotes = {};

    const statusEl = document.getElementById('status');
    const filePathEl = document.getElementById('filePath');

    function showStatus(msg) {
      statusEl.textContent = msg;
      statusEl.classList.add('visible');
      setTimeout(() => statusEl.classList.remove('visible'), 2000);
    }

    // ===== MAIN TAB SWITCHING =====
    const tasksTabBtn = document.getElementById('tasksTabBtn');
    const focusTabBtn = document.getElementById('focusTabBtn');
    const compassTabBtn = document.getElementById('compassTabBtn');
    const memoryTabBtn = document.getElementById('memoryTabBtn');
    const reviewTabBtn = document.getElementById('reviewTabBtn');
    const settingsTabBtn = document.getElementById('settingsTabBtn');
    const tasksPanel = document.getElementById('tasksPanel');
    const focusPanel = document.getElementById('focusPanel');
    const compassPanel = document.getElementById('compassPanel');
    const memoryPanel = document.getElementById('memoryPanel');
    const reviewPanel = document.getElementById('reviewPanel');
    const settingsPanel = document.getElementById('settingsPanel');
    const openTaskBtn = document.getElementById('openTaskBtn');
    const openMemoryBtn = document.getElementById('openMemoryBtn');
    const saveBtn = document.getElementById('saveBtn');
    const gcalHeaderBtn = document.getElementById('gcalHeaderBtn');

    function updateGcalHeaderBtn() {
      if (!gcalHeaderBtn) return;
      if (typeof isGcalConnected === 'function' && isGcalConnected()) {
        gcalHeaderBtn.textContent = 'Disconnect Calendar';
        gcalHeaderBtn.style.display = 'inline-flex';
        gcalHeaderBtn.onclick = () => { if (typeof disconnectGoogleCalendar === 'function') { disconnectGoogleCalendar(); updateGcalHeaderBtn(); } };
      } else {
        gcalHeaderBtn.textContent = 'Connect Calendar';
        gcalHeaderBtn.style.display = 'inline-flex';
        gcalHeaderBtn.onclick = () => { if (typeof connectGoogleCalendar === 'function') connectGoogleCalendar(); };
      }
    }

    function switchMainTab(tab) {
      activeMainTab = tab;
      try { localStorage.setItem('dashboard_active_tab', tab); } catch(e) {}

      tasksTabBtn.classList.toggle('active', tab === 'tasks');
      focusTabBtn.classList.toggle('active', tab === 'focus');
      compassTabBtn.classList.toggle('active', tab === 'compass');
      memoryTabBtn.classList.toggle('active', tab === 'memory');
      reviewTabBtn.classList.toggle('active', tab === 'review');
      settingsTabBtn.classList.toggle('active', tab === 'settings');

      tasksPanel.classList.toggle('active', tab === 'tasks');
      focusPanel.classList.toggle('active', tab === 'focus');
      compassPanel.classList.toggle('active', tab === 'compass');
      memoryPanel.classList.toggle('active', tab === 'memory');
      reviewPanel.classList.toggle('active', tab === 'review');
      settingsPanel.classList.toggle('active', tab === 'settings');

      // Show/hide appropriate buttons
      openTaskBtn.style.display = tab === 'tasks' ? 'inline-flex' : 'none';
      openMemoryBtn.style.display = tab === 'memory' ? 'inline-flex' : 'none';
      saveBtn.style.display = tab === 'tasks' ? 'inline-flex' : 'none';
      document.getElementById('quickAddOpenBtn').style.display = (tab === 'tasks' || tab === 'focus') ? 'inline-flex' : 'none';

      // Update file path display
      if (tab === 'tasks') {
        filePathEl.textContent = taskFileHandle ? taskFileName : '';
      } else if (tab === 'memory') {
        filePathEl.textContent = memoryDirHandle ? memoryDirHandle.name : '';
      } else {
        filePathEl.textContent = '';
      }

      // Update gcal button
      updateGcalHeaderBtn();

      // Render focus/compass/review/settings on switch
      if (tab === 'focus') renderFocusView();
      if (tab === 'compass') renderCompassView();
      if (tab === 'review') renderReviewView();
      if (tab === 'settings') renderSettingsView();
    }

    tasksTabBtn.addEventListener('click', () => switchMainTab('tasks'));
    focusTabBtn.addEventListener('click', () => switchMainTab('focus'));
    compassTabBtn.addEventListener('click', () => switchMainTab('compass'));
    memoryTabBtn.addEventListener('click', () => switchMainTab('memory'));
    reviewTabBtn.addEventListener('click', () => switchMainTab('review'));
    settingsTabBtn.addEventListener('click', () => switchMainTab('settings'));

    // Restore last active tab
    try {
      const savedTab = localStorage.getItem('dashboard_active_tab');
      if (savedTab && ['tasks', 'focus', 'compass', 'memory', 'review', 'settings'].includes(savedTab)) {
        switchMainTab(savedTab);
      }
    } catch(e) {}

    // ============================================================
    // ===== TASKS FUNCTIONALITY =====
    // ============================================================

    let taskFileHandle = null;
    let taskFileName = '';
    let sections = [];
    let tasks = {};
    let hasChanges = false;
    let currentView = 'tags';
    let quickAddSection = null;
    let weekOffset = 0;  // 0 = this week, -1 = last week, etc.

    // ============================================================
    // SUPABASE SETUP
    // ============================================================
    const SUPABASE_URL = 'https://cuqvmtpmubawuedfcmyd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1cXZtdHBtdWJhd3VlZGZjbXlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NjAxMDcsImV4cCI6MjA4NzEzNjEwN30.u6ai_HWzGo5SHeHHb96bZDVwcvyMz9yxqft3ZnvRTqo';
    let sb = null;
    try { sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null; }
    catch(e) { console.log('Supabase init failed:', e); }
    let supabaseSaveTimeout = null;

    async function saveToSupabase() {
      if (!sb) return;
      try {
        // 1) sections 저장 (upsert)
        const sectionRows = sections.map((s, i) => ({ id: s.id, name: s.name, position: i }));
        if (sectionRows.length > 0) {
          await sb.from('sections').upsert(sectionRows, { onConflict: 'id' });
        }
        // DB에 있지만 현재 sections에 없는 것 삭제
        const currentIds = sections.map(s => s.id);
        const { data: dbSections } = await sb.from('sections').select('id');
        if (dbSections) {
          const toDelete = dbSections.filter(s => !currentIds.includes(s.id)).map(s => s.id);
          if (toDelete.length > 0) {
            await sb.from('tasks').delete().in('section', toDelete);
            await sb.from('sections').delete().in('id', toDelete);
          }
        }

        // 2) tasks + subtasks 저장
        const allTasks = [];
        const allSubtasks = [];
        for (const secId of Object.keys(tasks)) {
          (tasks[secId] || []).forEach((t, i) => {
            allTasks.push({
              id: Math.round(t.id),
              title: t.title || '',
              section: t.section || secId,
              checked: !!t.checked,
              note: t.note || '',
              user_note: t.userNote || '',
              tags: t.tags || [],
              url: t.url || '',
              scheduled_date: t.scheduledDate || null,
              plan_bucket: t.planBucket || null,
              position: i
            });
            (t.subtasks || []).forEach((st, si) => {
              allSubtasks.push({
                task_id: Math.round(t.id),
                text: st.text,
                checked: !!st.checked,
                position: si
              });
            });
          });
        }

        // 기존 데이터 삭제 후 삽입 (깔끔한 동기화)
        await sb.from('subtasks').delete().gte('id', 0);
        await sb.from('tasks').delete().gte('id', 0);
        if (allTasks.length > 0) {
          await sb.from('tasks').insert(allTasks);
        }
        if (allSubtasks.length > 0) {
          await sb.from('subtasks').insert(allSubtasks);
        }

        console.log('Supabase synced');
      } catch (e) { console.log('Supabase save error:', e); }
    }

    function scheduleSyncToSupabase() {
      if (supabaseSaveTimeout) clearTimeout(supabaseSaveTimeout);
      supabaseSaveTimeout = setTimeout(saveToSupabase, 2000);
    }

    async function loadFromSupabase() {
      if (!sb) return false;
      try {
        const { data: dbSections, error: secErr } = await sb
          .from('sections').select('*').order('position');
        if (secErr || !dbSections || dbSections.length === 0) return false;

        const { data: dbTasks, error: taskErr } = await sb
          .from('tasks').select('*').order('position');
        if (taskErr) return false;

        const { data: dbSubtasks } = await sb
          .from('subtasks').select('*').order('position');

        // subtasks를 task_id로 그룹핑
        const subtaskMap = {};
        (dbSubtasks || []).forEach(st => {
          if (!subtaskMap[st.task_id]) subtaskMap[st.task_id] = [];
          subtaskMap[st.task_id].push({ text: st.text, checked: st.checked });
        });

        // sections 복원
        sections = dbSections.map(s => ({ id: s.id, name: s.name }));

        // tasks 복원
        tasks = {};
        sections.forEach(s => tasks[s.id] = []);
        (dbTasks || []).forEach(t => {
          const task = {
            id: t.id,
            title: t.title,
            section: t.section,
            checked: t.checked,
            note: t.note || '',
            userNote: t.user_note || '',
            tags: t.tags || [],
            url: t.url || '',
            scheduledDate: t.scheduled_date || '',
            planBucket: t.plan_bucket || '',
            subtasks: subtaskMap[t.id] || []
          };
          if (!tasks[t.section]) tasks[t.section] = [];
          tasks[t.section].push(task);
        });

        filePathEl.textContent = 'Supabase (cloud)';
        return true;
      } catch (e) { console.log('Supabase load error:', e); return false; }
    }

    // ============================================================
    // LOCAL STORAGE PERSISTENCE
    // ============================================================
    const LS_KEY_SECTIONS = 'dashboard_sections';
    const LS_KEY_TASKS = 'dashboard_tasks';
    const LS_KEY_FILENAME = 'dashboard_filename';
    const LS_KEY_VIEW = 'dashboard_view';

    function saveToLocalStorage() {
      try {
        localStorage.setItem(LS_KEY_SECTIONS, JSON.stringify(sections));
        localStorage.setItem(LS_KEY_TASKS, JSON.stringify(tasks));
        if (taskFileName) localStorage.setItem(LS_KEY_FILENAME, taskFileName);
        localStorage.setItem(LS_KEY_VIEW, currentView);
      } catch (e) { console.log('localStorage save error:', e); }
    }

    function loadFromLocalStorage() {
      try {
        const savedSections = localStorage.getItem(LS_KEY_SECTIONS);
        const savedTasks = localStorage.getItem(LS_KEY_TASKS);
        if (savedSections && savedTasks) {
          sections = JSON.parse(savedSections);
          tasks = JSON.parse(savedTasks);
          const savedName = localStorage.getItem(LS_KEY_FILENAME);
          if (savedName) {
            taskFileName = savedName;
            filePathEl.textContent = savedName + ' (cached)';
          }
          const savedView = localStorage.getItem(LS_KEY_VIEW);
          if (savedView) currentView = savedView;
          return true;
        }
      } catch (e) { console.log('localStorage load error:', e); }
      return false;
    }

    const weekView = document.getElementById('weekView');
    const tagView = document.getElementById('tagView');
    const tagViewBtn = document.getElementById('tagViewBtn'); // may be null

    function taskSectionId(name) {
      return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }

    function parseTaskMarkdown(content) {
      const resultSections = [];
      const resultTasks = {};
      let currentSection = null;
      let currentSectionId = null;

      const lines = content.split('\n');
      let currentTask = null;

      for (const line of lines) {
        const headerMatch = line.match(/^## \*{0,2}(.+?)\*{0,2}$/);
        if (headerMatch) {
          if (currentTask && currentSectionId) {
            resultTasks[currentSectionId].push(currentTask);
            currentTask = null;
          }

          const sectionName = headerMatch[1].trim();
          currentSectionId = taskSectionId(sectionName);
          currentSection = sectionName;

          if (!resultTasks[currentSectionId]) {
            resultSections.push({ id: currentSectionId, name: sectionName });
            resultTasks[currentSectionId] = [];
          }
        } else if (currentSectionId && line.match(/^- \[[ xX]\]/)) {
          if (currentTask) {
            resultTasks[currentSectionId].push(currentTask);
          }
          const checked = line.match(/\[[xX]\]/) !== null;
          let text = line.replace(/^- \[[ xX]\]\s*/, '');
          let title = text;
          let note = '';

          // Extract userNote like @@...@@
          let userNote = '';
          const userNoteMatch = text.match(/@@([\s\S]*?)@@/);
          if (userNoteMatch) {
            userNote = userNoteMatch[1].replace(/\\n/g, '\n');
            text = text.replace(/@@[\s\S]*?@@/, '').trim();
          }

          // Extract planBucket like [[schedule]] from full text first
          let planBucket = '';
          const bucketMatch = text.match(/\[\[(asap|schedule|someday|maybe)\]\]/);
          if (bucketMatch) {
            planBucket = bucketMatch[1];
            text = text.replace(/\[\[(asap|schedule|someday|maybe)\]\]/, '').trim();
          }

          // Extract scheduled date like <<2026-02-19>> from full text first
          let scheduledDate = '';
          const dateMatchFull = text.match(/<<(\d{4}-\d{2}-\d{2})>>/);
          if (dateMatchFull) {
            scheduledDate = dateMatchFull[1];
            text = text.replace(/<<\d{4}-\d{2}-\d{2}>>/, '').trim();
          }

          // Extract URL like {{https://...}} from full text
          let url = '';
          const urlMatchFull = text.match(/\{\{(https?:\/\/[^\}]+)\}\}/);
          if (urlMatchFull) {
            url = urlMatchFull[1];
            text = text.replace(/\{\{https?:\/\/[^\}]+\}\}/, '').trim();
          }

          // Extract tags like #VD #CQ #AI #BIZ #TEAM #PERSONAL from full text
          const tagRegex = /#(VD|CQ|AI|BIZ|TEAM|PERSONAL)\b/g;
          const tags = [];
          let tagMatch;
          while ((tagMatch = tagRegex.exec(text)) !== null) {
            tags.push(tagMatch[1]);
          }
          text = text.replace(/#(VD|CQ|AI|BIZ|TEAM|PERSONAL)\b/g, '').trim();

          // Now split title and note
          title = text;
          const boldMatch = text.match(/^\*\*(.+?)\*\*(.*)$/);
          if (boldMatch) {
            title = boldMatch[1];
            note = boldMatch[2].replace(/^\s*-\s*/, '').trim();
          }

          currentTask = {
            id: Date.now() + Math.random(),
            title,
            note,
            userNote,
            url,
            scheduledDate,
            planBucket,
            checked,
            tags,
            subtasks: [],
            section: currentSectionId
          };
        } else if (currentTask && line.match(/^\s+- \[[ xX]\]/)) {
          const checked = line.match(/\[[xX]\]/) !== null;
          const text = line.replace(/^\s+- \[[ xX]\]\s*/, '');
          currentTask.subtasks.push({ text, checked });
        }
      }

      if (currentTask && currentSectionId) {
        resultTasks[currentSectionId].push(currentTask);
      }

      return { sections: resultSections, tasks: resultTasks };
    }

    function toMarkdown() {
      let md = '# Tasks\n';

      sections.forEach((section, idx) => {
        md += `\n## ${section.name}\n`;
        const sectionTasks = tasks[section.id] || [];
        sectionTasks.forEach(t => {
          const checkbox = t.checked ? '[x]' : '[ ]';
          const tagStr = t.tags && t.tags.length > 0 ? ' ' + t.tags.map(t => '#' + t).join(' ') : '';
          const urlStr = t.url ? ` {{${t.url}}}` : '';
          const dateStr = t.scheduledDate ? ` <<${t.scheduledDate}>>` : '';
          const bucketStr = t.planBucket ? ` [[${t.planBucket}]]` : '';
          const userNoteStr = t.userNote ? ` @@${t.userNote.replace(/\n/g, '\\n')}@@` : '';
          const note = t.note ? ` - ${t.note}` : '';
          md += `- ${checkbox} **${t.title}**${note}${tagStr}${urlStr}${dateStr}${bucketStr}${userNoteStr}\n`;
          t.subtasks.forEach(st => {
            const stCheckbox = st.checked ? '[x]' : '[ ]';
            md += `  - ${stCheckbox} ${st.text}\n`;
          });
        });
      });

      return md.trimEnd() + '\n';
    }

    function createCard(task) {
      const card = document.createElement('div');
      card.className = 'task-card';
      card.draggable = true;
      card.dataset.id = task.id;

      let html = `
        <div style="display: flex; align-items: flex-start; gap: 8px;">
          <button class="delete-btn" data-action="delete" title="Delete task">&times;</button>
          <span class="checkbox ${task.checked ? 'checked' : ''}" data-action="toggle"></span>
          <button class="star-toggle star-toggle-sm${task.starred ? ' starred' : ''}" data-action="star" title="중요">${task.starred ? '★' : '☆'}</button>
          <div class="card-title" data-action="edit-title">${task.title}</div>
        </div>
      `;

      if (task.note) {
        html += `<div class="card-note" data-action="edit-note" style="cursor: pointer; margin-left: 30px;">${task.note}</div>`;
      } else {
        html += `<div class="card-note add-on-hover" data-action="edit-note" style="cursor: pointer; margin-left: 30px; font-style: italic;">+ Add note</div>`;
      }

      // Source icon + Tags in meta row
      const tagLabels = { VD: 'VOID DIVER', CQ: 'CQ', AI: 'AI', BIZ: 'BIZ', TEAM: 'TEAM', PERSONAL: 'PERSONAL' };
      const slackSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zm10.124 2.521a2.528 2.528 0 0 1 2.52-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.52V8.834zm-1.271 0a2.528 2.528 0 0 1-2.521 2.521 2.528 2.528 0 0 1-2.521-2.521V2.522A2.528 2.528 0 0 1 15.166 0a2.528 2.528 0 0 1 2.521 2.522v6.312zm-2.521 10.124a2.528 2.528 0 0 1 2.521 2.52A2.528 2.528 0 0 1 15.166 24a2.528 2.528 0 0 1-2.521-2.522v-2.52h2.521zm0-1.271a2.528 2.528 0 0 1-2.521-2.521 2.528 2.528 0 0 1 2.521-2.521h6.312A2.528 2.528 0 0 1 24 15.166a2.528 2.528 0 0 1-2.522 2.521h-6.312z"/></svg>';
      const notionSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L18.11 2.168c-.42-.326-.98-.7-2.055-.607L3.01 2.788c-.466.046-.56.28-.374.466l1.823.954zm.793 3.358v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.84-.046.933-.56.933-1.167V6.612c0-.606-.233-.933-.746-.886l-15.177.886c-.56.047-.747.327-.747.954zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.747 0-.933-.234-1.494-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.513.28-.886.747-.933l3.222-.186zM1.936 1.035L15.326.14c1.635-.14 2.055-.047 3.082.7l4.25 2.986c.7.513.933.653.933 1.213V21.14c0 1.027-.373 1.634-1.68 1.727l-15.458.933c-.98.047-1.448-.093-1.962-.747l-3.13-4.06c-.56-.746-.793-1.306-.793-1.96V2.948c0-.84.373-1.54 1.368-1.913z"/></svg>';
      const steamSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0-3.016-1.173-3.331-2.727L.436 15.27C1.862 20.307 6.486 24 11.979 24c6.627 0 11.999-5.373 11.999-12S18.605 0 11.979 0z"/></svg>';

      let sourceHtml = '';
      if (task.url) {
        let srcClass = '';
        let srcIcon = '';
        let srcLabel = '';
        if (task.url.includes('slack.com')) {
          srcClass = 'src-slack'; srcIcon = slackSvg; srcLabel = 'Slack';
        } else if (task.url.includes('notion.so')) {
          srcClass = 'src-notion'; srcIcon = notionSvg; srcLabel = 'Notion';
        } else if (task.url.includes('steampowered.com') || task.url.includes('steam')) {
          srcClass = 'src-steam'; srcIcon = steamSvg; srcLabel = 'Steam';
        } else {
          srcLabel = 'Link'; srcIcon = '&#x1F517;';
        }
        sourceHtml = `<a href="${task.url}" target="_blank" rel="noopener" class="card-source ${srcClass}" title="${task.url}" onclick="event.stopPropagation()">${srcIcon} ${srcLabel}</a>`;
      }

      html += '<div class="card-meta">';
      if (sourceHtml) html += sourceHtml;
      html += '<div class="card-tags" data-action="edit-tags" style="display:flex;flex-wrap:wrap;gap:4px;margin:0;">';
      if (task.tags && task.tags.length > 0) {
        task.tags.forEach(tag => {
          html += `<span class="tag-badge tag-${tag}" data-action="edit-tags">${tagLabels[tag] || tag}</span>`;
        });
      }
      html += `<button class="tag-add-btn add-on-hover" data-action="edit-tags" title="Edit tags">+</button>`;
      html += '</div></div>';

      if (task.subtasks.length > 0) {
        html += '<div class="card-subtasks" style="margin-left: 30px;">';
        task.subtasks.forEach((st, idx) => {
          html += `<div class="subtask">
            <span class="checkbox ${st.checked ? 'checked' : ''}" data-action="toggle-sub" data-idx="${idx}" style="width: 16px; height: 16px; min-width: 16px; min-height: 16px;"></span>
            <span data-action="edit-subtask" data-idx="${idx}" style="cursor: pointer;">${st.text}</span>
          </div>`;
        });
        html += `<div class="subtask add-on-hover" data-action="add-subtask" style="color: var(--text-muted); cursor: pointer; font-style: italic; padding-left: 24px;">+ Add subtask</div>`;
        html += '</div>';
      } else {
        html += `<div class="card-subtasks add-on-hover" style="margin-left: 30px;">
          <div class="subtask" data-action="add-subtask" style="color: var(--text-muted); cursor: pointer; font-style: italic;">+ Add subtask</div>
        </div>`;
      }

      card.innerHTML = html;

      card.addEventListener('dragstart', (e) => {
        card.classList.add('dragging');
        e.dataTransfer.setData('text/plain', task.id);
      });

      card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
      });

      card.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (action === 'toggle') {
          task.checked = !task.checked;
          markChanged();
          renderTasks();
        } else if (action === 'toggle-sub') {
          const idx = parseInt(e.target.dataset.idx);
          task.subtasks[idx].checked = !task.subtasks[idx].checked;
          markChanged();
          renderTasks();
        } else if (action === 'edit-title') {
          startEditingTitle(e.target, task);
        } else if (action === 'edit-note') {
          startEditingNote(e.target, task);
        } else if (action === 'edit-subtask') {
          const idx = parseInt(e.target.dataset.idx);
          startEditingSubtask(e.target, task, idx);
        } else if (action === 'add-subtask') {
          startAddingSubtask(e.target, task);
        } else if (action === 'delete') {
          deleteTask(task);
        } else if (action === 'edit-tags') {
          openTagPicker(card, task);
        } else if (action === 'star') {
          task.starred = !task.starred;
          e.target.classList.toggle('starred', task.starred);
          e.target.textContent = task.starred ? '★' : '☆';
          markChanged();
        }
      });

      return card;
    }

    function openTagPicker(card, task) {
      // Close any existing tag picker
      const existing = card.querySelector('.tag-picker');
      if (existing) { existing.remove(); return; }
      document.querySelectorAll('.tag-picker').forEach(p => p.remove());

      const allTags = ['VD', 'CQ', 'AI', 'BIZ', 'TEAM', 'PERSONAL'];
      const tagLabels = { VD: 'VOID DIVER', CQ: 'CQ', AI: 'AI', BIZ: 'BIZ', TEAM: 'TEAM', PERSONAL: 'PERSONAL' };
      if (!task.tags) task.tags = [];

      const picker = document.createElement('div');
      picker.className = 'tag-picker';
      allTags.forEach(tag => {
        const opt = document.createElement('span');
        opt.className = `tag-option tag-${tag}${task.tags.includes(tag) ? ' active' : ''}`;
        opt.textContent = tagLabels[tag];
        opt.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = task.tags.indexOf(tag);
          if (idx >= 0) {
            task.tags.splice(idx, 1);
            opt.classList.remove('active');
          } else {
            task.tags.push(tag);
            opt.classList.add('active');
          }
          // Update the tags display in the card
          const tagsDiv = card.querySelector('.card-tags');
          if (tagsDiv) {
            let badgesHtml = '';
            task.tags.forEach(t => {
              badgesHtml += `<span class="tag-badge tag-${t}" data-action="edit-tags">${tagLabels[t] || t}</span>`;
            });
            badgesHtml += `<button class="tag-add-btn" data-action="edit-tags" title="Edit tags">+</button>`;
            tagsDiv.innerHTML = badgesHtml;
          }
          markChanged();
        });
        picker.appendChild(opt);
      });

      // Insert picker after tags div
      const tagsDiv = card.querySelector('.card-tags');
      if (tagsDiv) {
        tagsDiv.after(picker);
      }

      // Close picker when clicking outside
      const closePicker = (e) => {
        if (!picker.contains(e.target) && !e.target.closest('[data-action="edit-tags"]')) {
          picker.remove();
          document.removeEventListener('click', closePicker);
        }
      };
      setTimeout(() => document.addEventListener('click', closePicker), 10);
    }

    function startEditingTitle(titleEl, task) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = task.title;
      input.style.cssText = 'width: 100%; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 6px; padding: 6px 10px; color: var(--text-primary); font-size: 14px; font-family: inherit; outline: none;';

      titleEl.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== task.title) {
          task.title = newTitle;
          markChanged();
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startEditingNote(noteEl, task) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = task.note || '';
      input.placeholder = 'Add a note...';
      input.style.cssText = 'width: 100%; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 6px; padding: 4px 8px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none;';

      noteEl.replaceWith(input);
      input.focus();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        task.note = input.value.trim();
        markChanged();
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startEditingSubtask(subtaskEl, task, idx) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = task.subtasks[idx].text;
      input.style.cssText = 'width: calc(100% - 30px); background: var(--bg-card); border: 2px solid var(--accent); border-radius: 4px; padding: 2px 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none;';

      subtaskEl.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const newText = input.value.trim();
        if (newText) { task.subtasks[idx].text = newText; }
        else { task.subtasks.splice(idx, 1); }
        markChanged();
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startAddingSubtask(el, task) {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'New subtask...';
      input.style.cssText = 'width: calc(100% - 10px); background: var(--bg-card); border: 2px solid var(--accent); border-radius: 4px; padding: 2px 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none;';

      el.replaceWith(input);
      input.focus();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const text = input.value.trim();
        if (text) { task.subtasks.push({ text, checked: false }); markChanged(); }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startEditingColumnTitle(titleEl, colId) {
      const section = sections.find(s => s.id === colId);
      if (!section) return;

      const input = document.createElement('input');
      input.type = 'text';
      input.value = section.name;
      input.style.cssText = 'width: 180px; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 6px; padding: 4px 10px; color: var(--text-primary); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-family: inherit; outline: none;';

      titleEl.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const newName = input.value.trim();
        if (newName && newName !== section.name) {
          const oldId = section.id;
          section.name = newName;
          const newId = taskSectionId(newName);
          if (newId !== oldId) {
            tasks[newId] = tasks[oldId] || [];
            delete tasks[oldId];
            tasks[newId].forEach(t => t.section = newId);
            section.id = newId;
          }
          markChanged();
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function createColumn(id, title, items) {
      const col = document.createElement('div');
      col.className = 'column';
      col.innerHTML = `
        <div class="column-header">
          <span class="column-title" data-section-id="${id}" style="cursor: pointer;">${title}</span>
          <span class="count">${items.length}</span>
        </div>
        <div class="cards" data-column="${id}"></div>
        <div class="add-card">
          <button data-add="${id}">+ Add task</button>
        </div>
      `;

      col.querySelector('.column-title').addEventListener('click', (e) => {
        if (!col.dragging) { startEditingColumnTitle(e.target, id); }
      });

      const header = col.querySelector('.column-header');
      header.draggable = true;

      header.addEventListener('dragstart', (e) => {
        e.stopPropagation();
        col.classList.add('dragging-column');
        e.dataTransfer.setData('text/column', id);
        e.dataTransfer.effectAllowed = 'move';
      });

      header.addEventListener('dragend', () => {
        col.classList.remove('dragging-column');
        board.querySelectorAll('.column-drop-indicator').forEach(el => el.remove());
      });

      col.addEventListener('dragover', (e) => {
        if (e.dataTransfer.types.includes('text/column')) {
          e.preventDefault();
          e.stopPropagation();
          board.querySelectorAll('.column-drop-indicator').forEach(el => el.remove());
          const indicator = document.createElement('div');
          indicator.className = 'column-drop-indicator';
          const rect = col.getBoundingClientRect();
          if (e.clientX < rect.left + rect.width / 2) { col.before(indicator); }
          else { col.after(indicator); }
        }
      });

      col.addEventListener('drop', (e) => {
        if (e.dataTransfer.types.includes('text/column')) {
          e.preventDefault();
          e.stopPropagation();
          const fromId = e.dataTransfer.getData('text/column');
          const toId = id;
          if (fromId !== toId) {
            const rect = col.getBoundingClientRect();
            const insertBefore = e.clientX < rect.left + rect.width / 2;
            moveSection(fromId, toId, insertBefore);
          }
          board.querySelectorAll('.column-drop-indicator').forEach(el => el.remove());
        }
      });

      const cardsContainer = col.querySelector('.cards');
      items.forEach(task => { cardsContainer.appendChild(createCard(task)); });

      const getDropPosition = (e) => {
        const allCards = [...cardsContainer.querySelectorAll('.task-card')];
        const visibleCards = allCards.filter(c => !c.classList.contains('dragging'));
        let insertBeforeCard = null;
        let dropIndex = visibleCards.length;
        for (let i = 0; i < visibleCards.length; i++) {
          const rect = visibleCards[i].getBoundingClientRect();
          if (e.clientY < rect.top + rect.height / 2) {
            insertBeforeCard = visibleCards[i];
            dropIndex = i;
            break;
          }
        }
        return { insertBeforeCard, dropIndex };
      };

      const showDropIndicator = (e) => {
        col.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        const { insertBeforeCard } = getDropPosition(e);
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator';
        indicator.style.cssText = 'height: 3px; background: var(--accent); border-radius: 2px; margin: 5px 0;';
        if (insertBeforeCard) { cardsContainer.insertBefore(indicator, insertBeforeCard); }
        else { cardsContainer.appendChild(indicator); }
      };

      col.addEventListener('dragover', (e) => {
        e.preventDefault();
        cardsContainer.classList.add('drag-over');
        showDropIndicator(e);
      });

      col.addEventListener('dragleave', (e) => {
        if (!col.contains(e.relatedTarget)) {
          cardsContainer.classList.remove('drag-over');
          col.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        }
      });

      col.addEventListener('drop', (e) => {
        e.preventDefault();
        cardsContainer.classList.remove('drag-over');
        col.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        const taskId = parseFloat(e.dataTransfer.getData('text/plain'));
        const { dropIndex } = getDropPosition(e);
        moveTask(taskId, id, dropIndex);
      });

      col.querySelector(`[data-add="${id}"]`).addEventListener('click', () => {
        addNewTask(id, col.querySelector('.cards'));
      });

      return col;
    }

    function addNewTask(sectionId, container) {
      const existing = container.querySelector('.new-task-input');
      if (existing) return;

      const input = document.createElement('textarea');
      input.className = 'new-task-input';
      input.placeholder = 'What needs to be done?';
      input.rows = 2;
      container.appendChild(input);
      input.focus();

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const title = input.value.trim();
          if (title) {
            if (!tasks[sectionId]) tasks[sectionId] = [];
            tasks[sectionId].push({
              id: Date.now() + Math.random(),
              title,
              note: '',
              checked: false,
              subtasks: [],
              section: sectionId
            });
            markChanged();
            renderTasks();
          } else { input.remove(); }
        } else if (e.key === 'Escape') { input.remove(); }
      });

      input.addEventListener('blur', () => { setTimeout(() => input.remove(), 100); });
    }

    function moveSection(fromId, toId, insertBefore) {
      const fromIdx = sections.findIndex(s => s.id === fromId);
      const toIdx = sections.findIndex(s => s.id === toId);
      if (fromIdx === -1 || toIdx === -1) return;
      const [section] = sections.splice(fromIdx, 1);
      let newIdx = sections.findIndex(s => s.id === toId);
      if (!insertBefore) newIdx++;
      sections.splice(newIdx, 0, section);
      markChanged();
      renderTasks();
    }

    function moveTask(taskId, toSectionId, dropIndex = -1) {
      let task = null;
      for (const section of sections) {
        const sectionTasks = tasks[section.id] || [];
        const idx = sectionTasks.findIndex(t => t.id === taskId);
        if (idx !== -1) {
          task = sectionTasks.splice(idx, 1)[0];
          break;
        }
      }
      if (!task) return;
      task.section = toSectionId;
      if (!tasks[toSectionId]) tasks[toSectionId] = [];
      if (dropIndex >= 0 && dropIndex <= tasks[toSectionId].length) {
        tasks[toSectionId].splice(dropIndex, 0, task);
      } else {
        tasks[toSectionId].push(task);
      }
      markChanged();
      renderTasks();
    }

    function deleteTask(task) {
      if (!confirm(`Delete "${task.title}"?`)) return;
      for (const section of sections) {
        const sectionTasks = tasks[section.id] || [];
        const idx = sectionTasks.findIndex(t => t.id === task.id);
        if (idx !== -1) { sectionTasks.splice(idx, 1); break; }
      }
      markChanged();
      renderTasks();
    }

    let saveTimeout = null;
    let lastModified = 0;
    let watchInterval = null;
    let isSaving = false;

    function markChanged() {
      hasChanges = true;
      saveBtn.disabled = false;
      saveToLocalStorage();
      scheduleSyncToSupabase();
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(autoSave, 500);
    }

    async function autoSave() {
      if (!hasChanges || isSaving) return;
      isSaving = true;
      saveToLocalStorage();
      if (taskFileHandle) {
        try {
          const writable = await taskFileHandle.createWritable();
          const content = toMarkdown();
          await writable.write(content);
          await writable.close();
          const file = await taskFileHandle.getFile();
          lastModified = file.lastModified;
          hasChanges = false;
          saveBtn.disabled = true;
          showStatus('Saved');
        } catch (e) {
          showStatus('Save failed: ' + e.message);
        }
      } else {
        hasChanges = false;
        saveBtn.disabled = true;
        showStatus('Cached');
      }
      isSaving = false;
    }

    async function checkForExternalChanges() {
      if (!taskFileHandle || hasChanges || isSaving) return;
      try {
        const file = await taskFileHandle.getFile();
        if (file.lastModified > lastModified) {
          lastModified = file.lastModified;
          const content = await file.text();
          const result = parseTaskMarkdown(content);
          sections = result.sections;
          tasks = result.tasks;
          saveToLocalStorage();
          renderTasks();
          showStatus('Reloaded');
        }
      } catch (e) { console.log('Watch error:', e); }
    }

    function startWatching() {
      if (watchInterval) clearInterval(watchInterval);
      watchInterval = setInterval(checkForExternalChanges, 1000);
    }

    function stopWatching() {
      if (watchInterval) { clearInterval(watchInterval); watchInterval = null; }
    }

    function renderTasks() {
      if (currentView === 'week') { renderWeekCalendar(); }
      else { renderTagView(); }
    }

    function renderList() { }
    function _renderList_unused() {
      var listView = document.createElement('div');
      listView.innerHTML = '';

      if (!quickAddSection && sections.length > 0) {
        quickAddSection = sections[0].id;
      }

      // Quick add at top
      const quickAdd = document.createElement('div');
      quickAdd.className = 'quick-add';
      quickAdd.style.cssText = 'border-bottom: 2px solid var(--border); margin-bottom: 24px; padding-bottom: 16px;';

      const sectionName = sections.find(s => s.id === quickAddSection)?.name || 'Select section';
      quickAdd.innerHTML = `
        <span class="checkbox" style="opacity: 0.3;"></span>
        <input type="text" class="quick-add-input" placeholder="Add a task..." id="quickAddInput">
        <span class="quick-add-section" id="quickAddSectionBtn">${sectionName}</span>
      `;
      listView.appendChild(quickAdd);

      const quickInput = document.getElementById('quickAddInput');
      const sectionBtn = document.getElementById('quickAddSectionBtn');

      quickInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && quickInput.value.trim()) {
          const title = quickInput.value.trim();
          if (!tasks[quickAddSection]) tasks[quickAddSection] = [];
          tasks[quickAddSection].unshift({
            id: Date.now() + Math.random(),
            title,
            note: '',
            checked: false,
            subtasks: [],
            section: quickAddSection
          });
          quickInput.value = '';
          markChanged();
          renderTasks();
          setTimeout(() => document.getElementById('quickAddInput')?.focus(), 10);
        }
      });

      sectionBtn.addEventListener('click', (e) => { showSectionPicker(e.target); });

      // Render each section
      sections.forEach(section => {
        const sectionTasks = tasks[section.id] || [];
        const sectionEl = document.createElement('div');
        sectionEl.className = 'list-section';
        sectionEl.dataset.sectionId = section.id;

        const header = document.createElement('div');
        header.className = 'list-section-header';
        header.innerHTML = `
          <span class="section-title" data-section-id="${section.id}">${section.name}</span>
          <span class="count">${sectionTasks.length}</span>
        `;

        header.querySelector('.section-title').addEventListener('click', (e) => {
          startEditingListSectionTitle(e.target, section);
        });

        sectionEl.appendChild(header);

        const tasksContainer = document.createElement('div');
        tasksContainer.className = 'list-tasks-container';
        tasksContainer.dataset.sectionId = section.id;

        sectionTasks.forEach(task => {
          tasksContainer.appendChild(createListItem(task, section));
        });

        sectionEl.appendChild(tasksContainer);

        // Drag-and-drop handlers for section
        const getDropPosition = (e, container) => {
          const items = [...container.querySelectorAll('.list-item:not(.dragging)')];
          let insertBeforeEl = null;
          let dropIndex = items.length;
          for (let i = 0; i < items.length; i++) {
            const rect = items[i].getBoundingClientRect();
            if (e.clientY < rect.top + rect.height / 2) {
              insertBeforeEl = items[i];
              dropIndex = i;
              break;
            }
          }
          return { insertBeforeEl, dropIndex };
        };

        const showDropIndicator = (e) => {
          tasksContainer.querySelectorAll('.list-drop-indicator').forEach(el => el.remove());
          const { insertBeforeEl } = getDropPosition(e, tasksContainer);
          const indicator = document.createElement('div');
          indicator.className = 'list-drop-indicator';
          if (insertBeforeEl) { tasksContainer.insertBefore(indicator, insertBeforeEl); }
          else { tasksContainer.appendChild(indicator); }
        };

        sectionEl.addEventListener('dragover', (e) => {
          e.preventDefault();
          sectionEl.classList.add('drag-over');
          showDropIndicator(e);
        });

        sectionEl.addEventListener('dragleave', (e) => {
          if (!sectionEl.contains(e.relatedTarget)) {
            sectionEl.classList.remove('drag-over');
            tasksContainer.querySelectorAll('.list-drop-indicator').forEach(el => el.remove());
          }
        });

        sectionEl.addEventListener('drop', (e) => {
          e.preventDefault();
          sectionEl.classList.remove('drag-over');
          tasksContainer.querySelectorAll('.list-drop-indicator').forEach(el => el.remove());
          const taskId = parseFloat(e.dataTransfer.getData('text/plain'));
          if (!taskId) return;
          const { dropIndex } = getDropPosition(e, tasksContainer);
          moveTask(taskId, section.id, dropIndex);
        });

        listView.appendChild(sectionEl);
      });

      // Add Section button
      const addSectionBtn = document.createElement('div');
      addSectionBtn.className = 'list-add-section';
      addSectionBtn.textContent = '+ Add Section';
      addSectionBtn.addEventListener('click', () => { startAddingListSection(addSectionBtn); });
      listView.appendChild(addSectionBtn);
    }

    function startEditingListSectionTitle(titleEl, section) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = section.name;
      input.style.cssText = 'width: 200px; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 6px; padding: 4px 10px; color: var(--text-primary); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-family: inherit; outline: none;';

      titleEl.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const newName = input.value.trim();
        if (newName && newName !== section.name) {
          const oldId = section.id;
          section.name = newName;
          const newId = taskSectionId(newName);
          if (newId !== oldId) {
            tasks[newId] = tasks[oldId] || [];
            delete tasks[oldId];
            tasks[newId].forEach(t => t.section = newId);
            section.id = newId;
          }
          markChanged();
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startAddingListSection(btn) {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Section name...';
      input.style.cssText = 'width: 100%; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 8px; padding: 12px 16px; color: var(--text-primary); font-size: 14px; font-family: inherit; outline: none; text-align: left;';

      btn.innerHTML = '';
      btn.style.border = '2px solid var(--accent)';
      btn.style.cursor = 'default';
      btn.appendChild(input);
      input.focus();

      let saved = false;
      const saveSection = () => {
        if (saved) return;
        saved = true;
        const name = input.value.trim();
        if (name) {
          const id = taskSectionId(name);
          if (!tasks[id]) {
            sections.push({ id, name });
            tasks[id] = [];
            markChanged();
          }
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveSection(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveSection);
    }

    function createListItem(task, section) {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.draggable = true;
      item.dataset.taskId = task.id;

      item.addEventListener('dragstart', (e) => {
        item.classList.add('dragging');
        e.dataTransfer.setData('text/plain', task.id);
        e.dataTransfer.effectAllowed = 'move';
      });

      item.addEventListener('dragend', () => {
        item.classList.remove('dragging');
        document.querySelectorAll('.list-drop-indicator').forEach(el => el.remove());
        document.querySelectorAll('.list-section.drag-over').forEach(el => el.classList.remove('drag-over'));
      });

      const checkbox = document.createElement('span');
      checkbox.className = `checkbox ${task.checked ? 'checked' : ''}`;
      checkbox.addEventListener('click', (e) => {
        e.stopPropagation();
        task.checked = !task.checked;
        markChanged();
        renderTasks();
      });

      const content = document.createElement('div');
      content.className = 'list-item-content';

      const title = document.createElement('div');
      title.className = `list-item-title ${task.checked ? 'checked' : ''}`;
      title.textContent = task.title;
      title.addEventListener('click', (e) => {
        e.stopPropagation();
        startEditingListItem(title, task);
      });
      content.appendChild(title);

      if (task.note) {
        const note = document.createElement('div');
        note.className = 'list-item-note';
        note.textContent = task.note;
        note.addEventListener('click', (e) => {
          e.stopPropagation();
          startEditingListNote(note, task);
        });
        content.appendChild(note);
      } else {
        const addNote = document.createElement('div');
        addNote.className = 'list-item-note add-note';
        addNote.textContent = '+ Add note';
        addNote.addEventListener('click', (e) => {
          e.stopPropagation();
          startEditingListNote(addNote, task);
        });
        content.appendChild(addNote);
      }

      if (task.subtasks && task.subtasks.length > 0) {
        const subtasksContainer = document.createElement('div');
        subtasksContainer.className = 'list-item-subtasks';

        task.subtasks.forEach((st, idx) => {
          const subtaskEl = document.createElement('div');
          subtaskEl.className = 'list-item-subtask';

          const stCheckbox = document.createElement('span');
          stCheckbox.className = `checkbox ${st.checked ? 'checked' : ''}`;
          stCheckbox.addEventListener('click', (e) => {
            e.stopPropagation();
            st.checked = !st.checked;
            markChanged();
            renderTasks();
          });

          const stText = document.createElement('span');
          stText.textContent = st.text;
          if (st.checked) {
            stText.style.textDecoration = 'line-through';
            stText.style.color = 'var(--text-muted)';
          }
          stText.addEventListener('click', (e) => {
            e.stopPropagation();
            startEditingListSubtask(stText, task, idx);
          });

          subtaskEl.appendChild(stCheckbox);
          subtaskEl.appendChild(stText);
          subtasksContainer.appendChild(subtaskEl);
        });

        content.appendChild(subtasksContainer);
      }

      const addSubtask = document.createElement('div');
      addSubtask.className = 'list-item-add-subtask';
      addSubtask.textContent = '+ Add subtask';
      addSubtask.addEventListener('click', (e) => {
        e.stopPropagation();
        startAddingListSubtask(addSubtask, task);
      });
      content.appendChild(addSubtask);

      const actions = document.createElement('div');
      actions.className = 'list-item-actions';
      actions.innerHTML = '<button title="Delete task">&times;</button>';
      actions.querySelector('button').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteTask(task);
      });

      // Star toggle
      const star = document.createElement('button');
      star.className = 'star-toggle' + (task.starred ? ' starred' : '');
      star.innerHTML = task.starred ? '★' : '☆';
      star.title = '중요';
      star.addEventListener('click', (e) => {
        e.stopPropagation();
        task.starred = !task.starred;
        star.classList.toggle('starred', task.starred);
        star.innerHTML = task.starred ? '★' : '☆';
        markChanged();
      });

      item.appendChild(checkbox);
      item.appendChild(star);
      item.appendChild(content);
      item.appendChild(actions);

      return item;
    }

    function startEditingListNote(noteEl, task) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = task.note || '';
      input.placeholder = 'Add a note...';
      input.style.cssText = 'width: 100%; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 6px; padding: 4px 8px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none;';

      noteEl.replaceWith(input);
      input.focus();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        task.note = input.value.trim();
        markChanged();
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startEditingListSubtask(subtaskEl, task, idx) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = task.subtasks[idx].text;
      input.style.cssText = 'width: calc(100% - 30px); background: var(--bg-card); border: 2px solid var(--accent); border-radius: 4px; padding: 2px 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none;';

      subtaskEl.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const newText = input.value.trim();
        if (newText) { task.subtasks[idx].text = newText; }
        else { task.subtasks.splice(idx, 1); }
        markChanged();
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startAddingListSubtask(el, task) {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'New subtask...';
      input.style.cssText = 'width: calc(100% - 10px); background: var(--bg-card); border: 2px solid var(--accent); border-radius: 4px; padding: 2px 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none;';

      el.replaceWith(input);
      input.focus();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const text = input.value.trim();
        if (text) {
          if (!task.subtasks) task.subtasks = [];
          task.subtasks.push({ text, checked: false });
          markChanged();
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function startEditingListItem(titleEl, task) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = task.title;
      input.style.cssText = 'width: 100%; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 6px; padding: 8px 12px; color: var(--text-primary); font-size: 15px; font-family: inherit; outline: none;';

      titleEl.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;
      const saveEdit = () => {
        if (saved) return;
        saved = true;
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== task.title) {
          task.title = newTitle;
          markChanged();
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveEdit);
    }

    function showSectionPicker(anchorEl) {
      document.querySelectorAll('.section-picker').forEach(el => el.remove());
      const picker = document.createElement('div');
      picker.className = 'section-picker';
      const rect = anchorEl.getBoundingClientRect();
      picker.style.top = (rect.bottom + 4) + 'px';
      picker.style.right = (window.innerWidth - rect.right) + 'px';

      sections.forEach(section => {
        const btn = document.createElement('button');
        btn.textContent = section.name;
        btn.addEventListener('click', () => {
          quickAddSection = section.id;
          picker.remove();
          renderTasks();
          setTimeout(() => document.getElementById('quickAddInput')?.focus(), 10);
        });
        picker.appendChild(btn);
      });

      document.body.appendChild(picker);
      setTimeout(() => {
        document.addEventListener('click', function closeHandler(e) {
          if (!picker.contains(e.target)) {
            picker.remove();
            document.removeEventListener('click', closeHandler);
          }
        });
      }, 10);
    }

    function switchTaskView(view) {
      if (view === 'board' || view === 'list' || view === 'timeline') view = 'tags';
      currentView = view;
      const views = { week: weekView, tags: tagView };
      const btns = { tags: tagViewBtn };
      Object.entries(views).forEach(([k, el]) => {
        if (view === k) {
          el.style.display = (k === 'week' || k === 'tags') ? 'flex' : 'block';
        } else {
          el.style.display = 'none';
        }
      });
      Object.values(btns).forEach(b => { if (b) b.classList.remove('active'); });
      if (btns[view]) btns[view].classList.add('active');
      renderTasks();
    }

    if (tagViewBtn) tagViewBtn.addEventListener('click', () => switchTaskView('tags'));

    // ============================================================
    // SHARED SOURCE ICON HELPER
    // ============================================================

    const _slackSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zm10.124 2.521a2.528 2.528 0 0 1 2.52-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.52V8.834zm-1.271 0a2.528 2.528 0 0 1-2.521 2.521 2.528 2.528 0 0 1-2.521-2.521V2.522A2.528 2.528 0 0 1 15.166 0a2.528 2.528 0 0 1 2.521 2.522v6.312zm-2.521 10.124a2.528 2.528 0 0 1 2.521 2.52A2.528 2.528 0 0 1 15.166 24a2.528 2.528 0 0 1-2.521-2.522v-2.52h2.521zm0-1.271a2.528 2.528 0 0 1-2.521-2.521 2.528 2.528 0 0 1 2.521-2.521h6.312A2.528 2.528 0 0 1 24 15.166a2.528 2.528 0 0 1-2.522 2.521h-6.312z"/></svg>';
    const _notionSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L18.11 2.168c-.42-.326-.98-.7-2.055-.607L3.01 2.788c-.466.046-.56.28-.374.466l1.823.954zm.793 3.358v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.84-.046.933-.56.933-1.167V6.612c0-.606-.233-.933-.746-.886l-15.177.886c-.56.047-.747.327-.747.954zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.747 0-.933-.234-1.494-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.513.28-.886.747-.933l3.222-.186zM1.936 1.035L15.326.14c1.635-.14 2.055-.047 3.082.7l4.25 2.986c.7.513.933.653.933 1.213V21.14c0 1.027-.373 1.634-1.68 1.727l-15.458.933c-.98.047-1.448-.093-1.962-.747l-3.13-4.06c-.56-.746-.793-1.306-.793-1.96V2.948c0-.84.373-1.54 1.368-1.913z"/></svg>';
    const _steamSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0-3.016-1.173-3.331-2.727L.436 15.27C1.862 20.307 6.486 24 11.979 24c6.627 0 11.999-5.373 11.999-12S18.605 0 11.979 0z"/></svg>';

    function sourceIconHtml(url, size) {
      if (!url) return '';
      size = size || 'mini'; // 'mini' or 'normal'
      let cls = '', icon = '', label = '';
      if (url.includes('slack.com')) { cls = 'sm-slack'; icon = _slackSvg; label = 'Slack'; }
      else if (url.includes('notion.so')) { cls = 'sm-notion'; icon = _notionSvg; label = 'Notion'; }
      else if (url.includes('steam')) { cls = 'sm-steam'; icon = _steamSvg; label = 'Steam'; }
      else { label = 'Link'; icon = '&#x1F517;'; }
      return `<a href="${url}" target="_blank" rel="noopener" class="source-mini ${cls}" title="${url}" onclick="event.stopPropagation()">${icon} ${label}</a>`;
    }

    // ============================================================
    // TAG VIEW
    // ============================================================

    const tagColors = {
      VD: { bg: '#EDE9FE', color: '#7C3AED', label: 'VOID DIVER' },
      CQ: { bg: '#FEF3C7', color: '#D97706', label: 'CQ' },
      AI: { bg: '#DBEAFE', color: '#2563EB', label: 'AI' },
      BIZ: { bg: '#FEE2E2', color: '#DC2626', label: 'BIZ' },
      TEAM: { bg: '#D1FAE5', color: '#059669', label: 'TEAM' },
      PERSONAL: { bg: '#F3F4F6', color: '#6B7280', label: 'PERSONAL' },
    };

    let planWeekOffset = 0; // 0 = centered on current week (shows prev/current/next)

    function getPlanWeeks(offset) {
      const now = new Date();
      const dayOfWeek = now.getDay();
      // Sunday of current week
      const sunday = new Date(now);
      sunday.setDate(now.getDate() - dayOfWeek);
      sunday.setHours(0,0,0,0);
      // Shift by offset weeks, then go back 1 week for "previous week"
      const startSunday = new Date(sunday);
      startSunday.setDate(sunday.getDate() + (offset * 3 - 1) * 7);
      const days = [];
      for (let i = 0; i < 21; i++) { // 3 weeks = 21 days
        const d = new Date(startSunday);
        d.setDate(startSunday.getDate() + i);
        days.push(d);
      }
      return days;
    }

    function formatDateStr(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    function renderTagView() {
      tagView.innerHTML = '';
      // Exclude Ideas & References sections
      const planExclude = ['ideas', 'references'];
      const allTasks = getAllTasks().filter(t => !planExclude.includes(t.sectionId));
      const allTags = ['VD', 'CQ', 'AI', 'BIZ', 'TEAM', 'PERSONAL'];

      // Helper: create a draggable card with checkbox
      function makePlanCard(t) {
        const card = document.createElement('div');
        card.className = 'tag-group-card' + (t.checked ? ' is-checked' : '');
        card.draggable = true;
        card.dataset.taskId = t.id;
        card.dataset.sectionId = t.sectionId;

        // Source link
        let srcHtml = '';
        if (t.url) srcHtml = sourceIconHtml(t.url);

        // Tags
        const tagLabels = { VD: 'VD', CQ: 'CQ', AI: 'AI', BIZ: 'BIZ', TEAM: 'TEAM', PERSONAL: 'PERSONAL' };
        let tagsHtml = '';
        if (t.tags && t.tags.length > 0) {
          tagsHtml = t.tags.map(tag => `<span class="tag-badge tag-${tag}" style="font-size:10px;padding:1px 6px;">${tagLabels[tag]}</span>`).join('');
        }

        // Subtasks
        let subtasksHtml = '';
        if (t.subtasks && t.subtasks.length > 0) {
          const done = t.subtasks.filter(s => s.checked).length;
          subtasksHtml = `<div class="plan-card-subtasks">`;
          t.subtasks.forEach((st, idx) => {
            subtasksHtml += `<div class="plan-subtask-item"><input type="checkbox" class="plan-sub-cb" data-idx="${idx}" ${st.checked ? 'checked' : ''}><span class="${st.checked ? 'plan-sub-done' : ''}">${st.text}</span></div>`;
          });
          subtasksHtml += `</div>`;
        }

        // Schedule date
        let dateHtml = '';
        if (t.scheduledDate) dateHtml = `<span class="plan-card-date">${t.scheduledDate}</span>`;

        card.innerHTML = `
          <input type="checkbox" class="plan-checkbox" ${t.checked ? 'checked' : ''} title="완료 표시">
          <button class="star-toggle star-toggle-sm${t.starred ? ' starred' : ''}" title="중요">${t.starred ? '★' : '☆'}</button>
          <div class="tg-body">
            <div class="tg-title">${t.title}</div>
            ${t.note ? `<div class="tg-note">${t.note}</div>` : ''}
            ${subtasksHtml}
            <div class="tg-meta">
              <span class="tg-section">${t.sectionName}</span>
              ${srcHtml}${tagsHtml}${dateHtml}
            </div>
          </div>
        `;

        // Star toggle
        const starBtn = card.querySelector('.star-toggle');
        starBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const ref = findTaskRef(t.id);
          if (ref) {
            ref.starred = !ref.starred;
            starBtn.classList.toggle('starred', ref.starred);
            starBtn.textContent = ref.starred ? '★' : '☆';
            markChanged();
          }
        });

        // Main checkbox toggle
        const cb = card.querySelector('.plan-checkbox');
        cb.addEventListener('click', (e) => {
          e.stopPropagation();
          const ref = findTaskRef(t.id);
          if (ref) {
            ref.checked = cb.checked;
            card.classList.toggle('is-checked', cb.checked);
            markChanged();
            setTimeout(() => renderTasks(), 150);
          }
        });

        // Subtask checkboxes
        card.querySelectorAll('.plan-sub-cb').forEach(scb => {
          scb.addEventListener('click', (e) => {
            e.stopPropagation();
            const ref = findTaskRef(t.id);
            if (ref && ref.subtasks) {
              const idx = parseInt(scb.dataset.idx);
              ref.subtasks[idx].checked = scb.checked;
              scb.nextElementSibling.classList.toggle('plan-sub-done', scb.checked);
              markChanged();
            }
          });
        });

        // Drag
        let _dragStarted = false;
        card.addEventListener('dragstart', (e) => {
          _dragStarted = true;
          e.dataTransfer.setData('text/plain', JSON.stringify({ taskId: t.id, sectionId: t.sectionId }));
          card.classList.add('dragging');
        });
        card.addEventListener('dragend', () => { card.classList.remove('dragging'); });

        // Click to open detail (only if not dragging)
        card.addEventListener('click', (e) => {
          if (_dragStarted) { _dragStarted = false; return; }
          if (e.target.closest('input[type="checkbox"]') || e.target.closest('a')) return;
          openTaskDetail(t.id);
        });

        // Visual hint: memo icon if userNote exists
        if (t.userNote) {
          const memoIcon = document.createElement('span');
          memoIcon.textContent = '📝';
          memoIcon.style.cssText = 'font-size:10px;position:absolute;top:3px;right:5px;';
          card.style.position = 'relative';
          card.appendChild(memoIcon);
        }

        return card;
      }

      // ===== LEFT PANEL: tag-grouped items =====
      const leftPanel = document.createElement('div');
      leftPanel.className = 'plan-left';

      // Search bar
      const searchBar = document.createElement('div');
      searchBar.className = 'plan-search-bar';
      searchBar.innerHTML = `
        <div class="plan-search-wrap">
          <span class="plan-search-icon">🔍</span>
          <input type="text" id="planSearchInput" placeholder="태스크 검색... (제목, 노트, 태그)" value="${window._planSearchQuery || ''}">
          <button class="plan-search-clear" id="planSearchClear">&times;</button>
        </div>
        <div class="plan-search-count" id="planSearchCount"></div>
      `;
      leftPanel.appendChild(searchBar);

      const scrollArea = document.createElement('div');
      scrollArea.className = 'plan-left-scroll';

      // Left panel only shows tasks NOT scheduled and NOT in any bucket
      const unscheduledTasks = allTasks.filter(t => !t.scheduledDate && !t.planBucket);

      // Filter by search query
      const query = (window._planSearchQuery || '').trim().toLowerCase();
      const matchTask = (t) => {
        if (!query) return true;
        const terms = query.split(/\s+/);
        const haystack = [t.title, t.note || '', t.sectionName || '', ...(t.tags || []), ...(t.subtasks || []).map(s => s.text)].join(' ').toLowerCase();
        return terms.every(term => haystack.includes(term));
      };
      const filteredTasks = unscheduledTasks.filter(matchTask);

      const tagGroups = {};
      allTags.forEach(t => tagGroups[t] = []);
      const untagged = [];

      filteredTasks.forEach(t => {
        if (t.tags && t.tags.length > 0) {
          t.tags.forEach(tag => { if (tagGroups[tag]) tagGroups[tag].push(t); });
        } else {
          untagged.push(t);
        }
      });

      // Search count
      if (query) {
        setTimeout(() => {
          const countEl = document.getElementById('planSearchCount');
          if (countEl) countEl.textContent = `${filteredTasks.length}건 / ${unscheduledTasks.length}건`;
        }, 0);
      }

      allTags.forEach(tag => {
        const items = tagGroups[tag];
        if (items.length === 0) return;
        const tc = tagColors[tag];
        const group = document.createElement('div');
        group.className = 'tag-group';

        const hdr = document.createElement('div');
        hdr.className = 'tag-group-header';
        hdr.innerHTML = `<span class="tag-group-badge tag-${tag}">${tc.label}</span><span class="tag-group-count">${items.length}</span>`;
        group.appendChild(hdr);

        const list = document.createElement('div');
        list.className = 'tag-group-items';
        items.forEach(t => list.appendChild(makePlanCard(t)));
        group.appendChild(list);
        scrollArea.appendChild(group);
      });

      if (untagged.length > 0) {
        const group = document.createElement('div');
        group.className = 'tag-group';
        const hdr = document.createElement('div');
        hdr.className = 'tag-group-header';
        hdr.innerHTML = `<span class="tag-group-badge" style="background:var(--bg-secondary);color:var(--text-muted);">UNTAGGED</span><span class="tag-group-count">${untagged.length}</span>`;
        group.appendChild(hdr);

        const list = document.createElement('div');
        list.className = 'tag-group-items';
        untagged.forEach(t => list.appendChild(makePlanCard(t)));
        group.appendChild(list);
        scrollArea.appendChild(group);
      }

      leftPanel.appendChild(scrollArea);

      // ===== RIGHT PANEL: 3-week calendar =====
      const rightPanel = document.createElement('div');
      rightPanel.className = 'plan-right';

      const header = document.createElement('div');
      header.className = 'plan-right-header';

      const days = getPlanWeeks(planWeekOffset);
      const firstDay = days[0];
      const lastDay = days[days.length - 1];
      const monthNames = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
      const rangeLabel = firstDay.getMonth() === lastDay.getMonth()
        ? `${firstDay.getFullYear()}년 ${monthNames[firstDay.getMonth()]}`
        : `${monthNames[firstDay.getMonth()]} ~ ${monthNames[lastDay.getMonth()]}`;

      const gcalPlanBtnHtml = isGcalConnected()
        ? `<button class="gcal-connect-btn disconnect gcal-plan-btn" id="gcalDisconnectPlan">Disconnect</button>`
        : `<button class="gcal-connect-btn gcal-plan-btn" id="gcalConnectPlan">Connect Google Calendar</button>`;
      header.innerHTML = `
        <h3>📆 ${rangeLabel}</h3>
        <div class="plan-week-nav">
          <button id="planWeekPrev">◀</button>
          <span class="plan-week-label">${planWeekOffset === 0 ? '이번 주 기준' : (planWeekOffset > 0 ? `+${planWeekOffset*3}주` : `${planWeekOffset*3}주`)}</span>
          <button id="planWeekNext">▶</button>
          <button id="planWeekToday" style="margin-left:4px;">오늘</button>
          ${gcalPlanBtnHtml}
        </div>
      `;
      rightPanel.appendChild(header);

      // ===== ASAP PANEL (above calendar) =====
      const asapTasks = allTasks.filter(t => t.planBucket === 'asap' && !t.scheduledDate);
      const asapPanel = makeBucketPanel('asap', '⚡', 'ASAP', asapTasks, '드롭 시 오늘 배정 후 사라짐');
      asapPanel.addEventListener('dragover', (e) => { e.preventDefault(); asapPanel.classList.add('drag-over'); });
      asapPanel.addEventListener('dragleave', () => asapPanel.classList.remove('drag-over'));
      asapPanel.addEventListener('drop', (e) => {
        e.preventDefault();
        asapPanel.classList.remove('drag-over');
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const ref = findTaskRef(data.taskId);
          if (ref) {
            ref.planBucket = 'asap';
            ref.scheduledDate = formatDateStr(new Date());
            markChanged();
            renderTasks();
            showStatus('ASAP → 오늘 배정됨');
          }
        } catch(err) { console.log('Drop error', err); }
      });
      rightPanel.appendChild(asapPanel);

      // Day headers (Mon-Sun)
      const grid = document.createElement('div');
      grid.className = 'plan-cal-grid';
      const dayNames = ['일','월','화','수','목','금','토'];
      dayNames.forEach((dn, i) => {
        const dh = document.createElement('div');
        dh.className = 'plan-cal-header' + (i === 0 ? ' is-sun' : '');
        dh.textContent = dn;
        grid.appendChild(dh);
      });

      // Week label rows + day cells for 3 weeks
      const todayStr = formatDateStr(new Date());

      for (let w = 0; w < 3; w++) {
        const weekDays = days.slice(w * 7, w * 7 + 7);
        weekDays.forEach((day, di) => {
          const ds = formatDateStr(day);
          const cell = document.createElement('div');
          const isSun = di === 0;
          cell.className = 'plan-cal-cell' + (ds === todayStr ? ' is-today' : '') + (isSun ? ' is-sun' : '');
          cell.dataset.date = ds;

          const dateLabel = document.createElement('div');
          dateLabel.className = 'plan-cal-date';
          dateLabel.textContent = day.getDate();
          cell.appendChild(dateLabel);

          const tasksContainer = document.createElement('div');
          tasksContainer.className = 'plan-cal-tasks';

          // Render Google Calendar events for this day
          const dayGcalEvents = gcalEvents[ds] || [];
          dayGcalEvents.forEach(ev => {
            const el = document.createElement('div');
            if (ev.isAllDay) {
              el.className = 'gcal-allday';
              el.textContent = ev.summary;
            } else {
              el.className = 'gcal-event';
              const startTime = new Date(ev.start.dateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
              el.innerHTML = `<span class="gcal-time">${startTime}</span> ${ev.summary}`;
            }
            if (ev.htmlLink) {
              el.style.cursor = 'pointer';
              el.addEventListener('click', () => window.open(ev.htmlLink, '_blank'));
            }
            tasksContainer.appendChild(el);
          });

          // Add "+ Event" button if connected
          if (isGcalConnected()) {
            const addBtn = document.createElement('button');
            addBtn.className = 'gcal-add-event-btn';
            addBtn.textContent = '+';
            addBtn.title = '새 Google Calendar 일정';
            addBtn.style.cssText = 'padding:2px 4px;font-size:10px;margin-bottom:2px;';
            addBtn.addEventListener('click', (e) => { e.stopPropagation(); showNewEventModal(ds); });
            tasksContainer.appendChild(addBtn);
          }

          // Find tasks for this day
          const dayTasks = allTasks.filter(t => t.scheduledDate === ds);
          dayTasks.forEach(t => {
            const chip = document.createElement('div');
            chip.className = 'plan-cal-task' + (t.checked ? ' is-checked' : '');
            chip.title = t.title + (t.note ? '\n' + t.note : '');

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'cal-cb';
            cb.checked = !!t.checked;
            cb.addEventListener('click', (e) => {
              e.stopPropagation();
              t.checked = cb.checked;
              chip.classList.toggle('is-checked', cb.checked);
              markChanged();
            });
            chip.appendChild(cb);

            const span = document.createElement('span');
            span.className = 'cal-title';
            span.textContent = t.title;
            chip.appendChild(span);
            chip.draggable = true;
            chip.dataset.taskId = t.id;
            chip.dataset.sectionId = t.sectionId;

            // Color by first tag
            if (t.tags && t.tags.length > 0) {
              const tc = tagColors[t.tags[0]];
              if (tc) {
                chip.style.borderLeftColor = tc.color;
                chip.style.background = tc.bg;
              }
            }

            let _chipDragged = false;
            chip.addEventListener('dragstart', (e) => {
              _chipDragged = true;
              e.dataTransfer.setData('text/plain', JSON.stringify({ taskId: t.id, sectionId: t.sectionId }));
              chip.classList.add('dragging');
            });
            chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
            chip.addEventListener('click', (e) => {
              if (_chipDragged) { _chipDragged = false; return; }
              if (e.target.closest('input[type="checkbox"]')) return;
              openTaskDetail(t.id);
            });
            chip.style.cursor = 'pointer';

            tasksContainer.appendChild(chip);
          });

          cell.appendChild(tasksContainer);

          // Drop handlers
          cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drag-over'); });
          cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
          cell.addEventListener('drop', (e) => {
            e.preventDefault();
            cell.classList.remove('drag-over');
            try {
              const data = JSON.parse(e.dataTransfer.getData('text/plain'));
              const ref = findTaskRef(data.taskId);
              if (ref) {
                ref.scheduledDate = ds;
                // Clear bucket when moved to calendar (e.g. from Schedule)
                if (ref.planBucket === 'schedule') ref.planBucket = '';
                markChanged();
                renderTasks();
                showStatus('일정 변경됨');
              }
            } catch(err) { console.log('Drop error', err); }
          });

          grid.appendChild(cell);
        });
      }

      rightPanel.appendChild(grid);

      // ===== Bucket panels below calendar: Schedule, Someday, Maybe =====
      function makeDraggableChip(t) {
        const chip = document.createElement('div');
        chip.className = 'plan-cal-task';
        chip.title = t.title + (t.note ? '\n' + t.note : '');
        chip.draggable = true;
        chip.dataset.taskId = t.id;
        chip.dataset.sectionId = t.sectionId;

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'cal-cb';
        cb.checked = !!t.checked;
        cb.addEventListener('click', (e) => {
          e.stopPropagation();
          t.checked = cb.checked;
          chip.classList.toggle('is-checked', cb.checked);
          markChanged();
        });
        chip.appendChild(cb);
        const span = document.createElement('span');
        span.className = 'cal-title';
        span.textContent = t.title;
        chip.appendChild(span);

        if (t.tags && t.tags.length > 0) {
          const tc = tagColors[t.tags[0]];
          if (tc) { chip.style.borderLeftColor = tc.color; chip.style.background = tc.bg; }
        }
        let _bChipDrag = false;
        chip.addEventListener('dragstart', (e) => {
          _bChipDrag = true;
          e.dataTransfer.setData('text/plain', JSON.stringify({ taskId: t.id, sectionId: t.sectionId }));
          chip.classList.add('dragging');
        });
        chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
        chip.addEventListener('click', (e) => {
          if (_bChipDrag) { _bChipDrag = false; return; }
          if (e.target.closest('input[type="checkbox"]')) return;
          openTaskDetail(t.id);
        });
        chip.style.cursor = 'pointer';
        return chip;
      }

      function makeBucketPanel(bucket, icon, title, taskList, hint) {
        const panel = document.createElement('div');
        panel.className = `plan-bucket-panel bucket-${bucket}`;

        const hdr = document.createElement('div');
        hdr.className = 'plan-bucket-header';
        hdr.innerHTML = `<span class="bucket-icon">${icon}</span> ${title} <span class="bucket-count">${taskList.length}</span>${hint ? `<span class="bucket-hint">${hint}</span>` : ''}`;
        panel.appendChild(hdr);

        const items = document.createElement('div');
        items.className = 'plan-bucket-items';
        taskList.forEach(t => items.appendChild(makeDraggableChip(t)));
        panel.appendChild(items);

        return panel;
      }

      function attachBucketDrop(panel, bucketName, statusMsg) {
        panel.addEventListener('dragover', (e) => { e.preventDefault(); panel.classList.add('drag-over'); });
        panel.addEventListener('dragleave', () => panel.classList.remove('drag-over'));
        panel.addEventListener('drop', (e) => {
          e.preventDefault();
          panel.classList.remove('drag-over');
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const ref = findTaskRef(data.taskId);
            if (ref) {
              ref.planBucket = bucketName;
              // Moving to a bucket clears any calendar date (unless it's ASAP which sets today)
              if (bucketName !== 'asap') ref.scheduledDate = '';
              markChanged();
              renderTasks();
              showStatus(statusMsg);
            }
          } catch(err) { console.log('Drop error', err); }
        });
      }

      const scheduleTasks = allTasks.filter(t => t.planBucket === 'schedule' && !t.scheduledDate);
      const schedulePanel = makeBucketPanel('schedule', '📅', 'Schedule', scheduleTasks, '이후 캘린더로 이동');
      attachBucketDrop(schedulePanel, 'schedule', 'Schedule에 추가됨');
      rightPanel.appendChild(schedulePanel);

      const somedayTasks = allTasks.filter(t => t.planBucket === 'someday');
      const somedayPanel = makeBucketPanel('someday', '🌤️', 'Someday', somedayTasks);
      attachBucketDrop(somedayPanel, 'someday', 'Someday에 추가됨');
      rightPanel.appendChild(somedayPanel);

      const maybeTasks = allTasks.filter(t => t.planBucket === 'maybe');
      const maybePanel = makeBucketPanel('maybe', '💭', 'Maybe', maybeTasks);
      attachBucketDrop(maybePanel, 'maybe', 'Maybe에 추가됨');
      rightPanel.appendChild(maybePanel);

      // Resizable divider
      const divider = document.createElement('div');
      divider.className = 'plan-divider';

      tagView.appendChild(leftPanel);
      tagView.appendChild(divider);
      tagView.appendChild(rightPanel);

      // Divider drag logic
      let isDragging = false;
      divider.addEventListener('mousedown', (e) => {
        isDragging = true;
        divider.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = tagView.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = Math.max(15, Math.min(70, (x / rect.width) * 100));
        leftPanel.style.width = pct + '%';
      });
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          divider.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Week navigation events
      document.getElementById('planWeekPrev')?.addEventListener('click', async () => {
        planWeekOffset--;
        if (isGcalConnected()) await fetchGcalForPlanView();
        renderTagView();
      });
      document.getElementById('planWeekNext')?.addEventListener('click', async () => {
        planWeekOffset++;
        if (isGcalConnected()) await fetchGcalForPlanView();
        renderTagView();
      });
      document.getElementById('planWeekToday')?.addEventListener('click', async () => {
        planWeekOffset = 0;
        if (isGcalConnected()) await fetchGcalForPlanView();
        renderTagView();
      });

      // Google Calendar connect/disconnect in Plan view
      document.getElementById('gcalConnectPlan')?.addEventListener('click', connectGoogleCalendar);
      document.getElementById('gcalDisconnectPlan')?.addEventListener('click', disconnectGoogleCalendar);

      // Search events
      let _planSearchTimer = null;
      const searchInput = document.getElementById('planSearchInput');
      const searchClear = document.getElementById('planSearchClear');
      if (searchInput) {
        searchInput.focus();
        // Place cursor at end if value exists
        if (searchInput.value) {
          searchInput.selectionStart = searchInput.selectionEnd = searchInput.value.length;
          searchClear.style.display = 'block';
        }
        searchInput.addEventListener('input', () => {
          clearTimeout(_planSearchTimer);
          searchClear.style.display = searchInput.value ? 'block' : 'none';
          _planSearchTimer = setTimeout(() => {
            window._planSearchQuery = searchInput.value;
            renderTagView();
          }, 250);
        });
      }
      if (searchClear) {
        searchClear.addEventListener('click', () => {
          window._planSearchQuery = '';
          renderTagView();
        });
      }
    }

    // ===== TASK DETAIL PANEL =====
    function openTaskDetail(taskId) {
      const ref = findTaskRef(taskId);
      if (!ref) return;
      let refSectionId = null;
      if (!ref.sectionName) {
        for (const s of sections) {
          if ((tasks[s.id] || []).includes(ref)) { ref.sectionName = s.name; refSectionId = s.id; break; }
        }
      } else {
        for (const s of sections) {
          if ((tasks[s.id] || []).includes(ref)) { refSectionId = s.id; break; }
        }
      }

      document.querySelector('.plan-detail-overlay')?.remove();
      document.querySelector('.plan-detail-panel')?.remove();

      const overlay = document.createElement('div');
      overlay.className = 'plan-detail-overlay';
      const panel = document.createElement('div');
      panel.className = 'plan-detail-panel';

      const topbar = document.createElement('div');
      topbar.className = 'plan-detail-topbar';
      topbar.innerHTML = `<h3>태스크 편집</h3><button class="plan-detail-close">&times;</button>`;
      panel.appendChild(topbar);

      const body = document.createElement('div');
      body.className = 'plan-detail-body';

      const titleRow = document.createElement('div');
      titleRow.style.cssText = 'display:flex;align-items:flex-start;gap:10px;';
      const mainCb = document.createElement('input');
      mainCb.type = 'checkbox'; mainCb.checked = !!ref.checked;
      mainCb.style.cssText = 'width:18px;height:18px;min-width:18px;margin-top:5px;accent-color:var(--accent);cursor:pointer;';
      const starBtn = document.createElement('button');
      starBtn.className = 'star-toggle' + (ref.starred ? ' starred' : '');
      starBtn.innerHTML = ref.starred ? '★' : '☆';
      starBtn.style.cssText = 'margin-top:2px;font-size:18px;';
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.className = 'plan-detail-title-input';
      titleInput.value = ref.title;

      mainCb.addEventListener('change', () => { ref.checked = mainCb.checked; markChanged(); });
      starBtn.addEventListener('click', () => {
        ref.starred = !ref.starred;
        starBtn.classList.toggle('starred', ref.starred);
        starBtn.innerHTML = ref.starred ? '★' : '☆';
        markChanged();
      });
      titleInput.addEventListener('input', () => { ref.title = titleInput.value; markChanged(); });

      titleRow.appendChild(mainCb);
      titleRow.appendChild(starBtn);
      titleRow.appendChild(titleInput);
      body.appendChild(titleRow);

      const noteBlock = document.createElement('div');
      noteBlock.innerHTML = `<div class="plan-detail-section-label">설명</div>`;
      const noteInput = document.createElement('textarea');
      noteInput.className = 'plan-detail-note-input';
      noteInput.placeholder = '설명을 입력하세요...';
      noteInput.value = ref.note || '';
      noteInput.addEventListener('input', () => { ref.note = noteInput.value; markChanged(); });
      noteBlock.appendChild(noteInput);
      body.appendChild(noteBlock);

      const tagsBlock = document.createElement('div');
      tagsBlock.innerHTML = `<div class="plan-detail-section-label">태그</div>`;
      const tagsRow = document.createElement('div');
      tagsRow.className = 'plan-detail-edit-row';
      if (!ref.tags) ref.tags = [];
      function renderDetailTags() {
        tagsRow.innerHTML = Object.entries(tagColors).map(([tag, tc]) => {
          const sel = ref.tags.includes(tag) ? ' selected' : '';
          return `<button class="plan-detail-edit-btn${sel}" data-tag="${tag}" style="${sel ? `background:${tc.bg};color:${tc.color};border-color:${tc.color};` : ''}">${tc.label}</button>`;
        }).join('');
        tagsRow.querySelectorAll('[data-tag]').forEach(btn => {
          btn.addEventListener('click', () => {
            const tag = btn.dataset.tag;
            const idx = ref.tags.indexOf(tag);
            if (idx >= 0) ref.tags.splice(idx, 1); else ref.tags.push(tag);
            markChanged(); renderDetailTags();
          });
        });
      }
      renderDetailTags();
      tagsBlock.appendChild(tagsRow);
      body.appendChild(tagsBlock);

      const bucketBlock = document.createElement('div');
      bucketBlock.innerHTML = `<div class="plan-detail-section-label">우선순위</div>`;
      const bucketRow = document.createElement('div');
      bucketRow.className = 'plan-detail-edit-row';
      const bucketOptions = { asap: '⚡ ASAP', schedule: '📋 Schedule', someday: '💭 Someday', maybe: '🤔 Maybe' };
      function renderDetailBucket() {
        bucketRow.innerHTML = Object.entries(bucketOptions).map(([bkt, label]) => {
          const sel = ref.planBucket === bkt ? ' selected' : '';
          return `<button class="plan-detail-edit-btn${sel}" data-bucket="${bkt}">${label}</button>`;
        }).join('');
        bucketRow.querySelectorAll('[data-bucket]').forEach(btn => {
          btn.addEventListener('click', () => {
            ref.planBucket = ref.planBucket === btn.dataset.bucket ? '' : btn.dataset.bucket;
            markChanged(); renderDetailBucket();
          });
        });
      }
      renderDetailBucket();
      bucketBlock.appendChild(bucketRow);
      body.appendChild(bucketBlock);

      const dateBlock = document.createElement('div');
      dateBlock.innerHTML = `<div class="plan-detail-section-label">날짜</div>`;
      const dateRow = document.createElement('div');
      dateRow.style.cssText = 'display:flex;gap:8px;align-items:center;';
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.className = 'plan-detail-date-input';
      dateInput.value = ref.scheduledDate || '';
      dateInput.addEventListener('change', () => { ref.scheduledDate = dateInput.value; markChanged(); });
      const dateClearBtn = document.createElement('button');
      dateClearBtn.className = 'plan-detail-edit-btn';
      dateClearBtn.textContent = '날짜 해제';
      dateClearBtn.addEventListener('click', () => { ref.scheduledDate = ''; dateInput.value = ''; markChanged(); });
      dateRow.appendChild(dateInput);
      dateRow.appendChild(dateClearBtn);
      dateBlock.appendChild(dateRow);
      body.appendChild(dateBlock);

      const secBlock = document.createElement('div');
      secBlock.innerHTML = `<div class="plan-detail-section-label">섹션</div>`;
      const secSelect = document.createElement('select');
      secSelect.style.cssText = 'font-size:13px;padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-family:inherit;outline:none;';
      sections.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.name;
        if (s.id === refSectionId) opt.selected = true;
        secSelect.appendChild(opt);
      });
      secSelect.addEventListener('change', () => {
        const newSecId = secSelect.value;
        if (newSecId !== refSectionId) {
          const oldArr = tasks[refSectionId] || [];
          const idx = oldArr.indexOf(ref);
          if (idx >= 0) oldArr.splice(idx, 1);
          if (!tasks[newSecId]) tasks[newSecId] = [];
          tasks[newSecId].unshift(ref);
          refSectionId = newSecId;
          ref.sectionName = sections.find(s => s.id === newSecId)?.name || '';
          markChanged();
        }
      });
      secBlock.appendChild(secSelect);
      body.appendChild(secBlock);

      if (ref.url) {
        const srcBlock = document.createElement('div');
        srcBlock.innerHTML = `<div class="plan-detail-section-label">출처</div>`;
        let srcLabel = 'Link', srcSvg = '🔗';
        if (ref.url.includes('slack.com')) { srcLabel = 'Slack에서 보기'; srcSvg = _slackSvg; }
        else if (ref.url.includes('notion.so')) { srcLabel = 'Notion에서 보기'; srcSvg = _notionSvg; }
        else if (ref.url.includes('steam')) { srcLabel = 'Steam에서 보기'; srcSvg = _steamSvg; }
        srcBlock.innerHTML += `<a href="${ref.url}" target="_blank" rel="noopener" class="plan-detail-src-link">${srcSvg} ${srcLabel}</a>`;
        body.appendChild(srcBlock);
      }

      if (ref.subtasks && ref.subtasks.length > 0) {
        const stBlock = document.createElement('div');
        stBlock.innerHTML = `<div class="plan-detail-section-label">하위 작업 (${ref.subtasks.filter(s=>s.checked).length}/${ref.subtasks.length})</div>`;
        const stList = document.createElement('div');
        stList.className = 'plan-detail-subtasks';
        ref.subtasks.forEach((st, idx) => {
          const stItem = document.createElement('div');
          stItem.className = 'plan-detail-subtask' + (st.checked ? ' is-done' : '');
          stItem.innerHTML = `<input type="checkbox" ${st.checked ? 'checked' : ''}><span>${st.text}</span>`;
          stItem.querySelector('input').addEventListener('change', (e) => {
            ref.subtasks[idx].checked = e.target.checked;
            stItem.classList.toggle('is-done', e.target.checked);
            stBlock.querySelector('.plan-detail-section-label').textContent = `하위 작업 (${ref.subtasks.filter(s=>s.checked).length}/${ref.subtasks.length})`;
            markChanged();
          });
          stList.appendChild(stItem);
        });
        stBlock.appendChild(stList);
        body.appendChild(stBlock);
      }

      const noteArea = document.createElement('div');
      noteArea.className = 'plan-detail-user-note-area';
      noteArea.innerHTML = `<div class="plan-detail-section-label">내 메모</div>`;
      const textarea = document.createElement('textarea');
      textarea.className = 'plan-detail-user-note';
      textarea.placeholder = '이 태스크에 대한 메모를 남겨보세요...';
      textarea.value = ref.userNote || '';
      let _noteTimer = null;
      textarea.addEventListener('input', () => {
        clearTimeout(_noteTimer);
        _noteTimer = setTimeout(() => { ref.userNote = textarea.value; markChanged(); }, 400);
      });
      noteArea.appendChild(textarea);
      body.appendChild(noteArea);

      const deleteBlock = document.createElement('div');
      deleteBlock.style.cssText = 'margin-top: 8px; padding-top: 16px; border-top: 1px solid var(--border-light);';
      const deleteBtn = document.createElement('button');
      deleteBtn.style.cssText = 'width:100%;padding:10px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;background:#FEE2E2;color:#DC2626;border:1px solid #FCA5A5;transition:all 0.15s;';
      deleteBtn.textContent = '태스크 삭제';
      deleteBtn.addEventListener('mouseenter', () => { deleteBtn.style.background = '#FECACA'; });
      deleteBtn.addEventListener('mouseleave', () => { deleteBtn.style.background = '#FEE2E2'; });
      deleteBtn.addEventListener('click', () => {
        if (!confirm(`"${ref.title}" 을(를) 삭제하시겠습니까?`)) return;
        for (const section of sections) {
          const arr = tasks[section.id] || [];
          const idx = arr.findIndex(t => t.id === ref.id);
          if (idx !== -1) { arr.splice(idx, 1); break; }
        }
        markChanged(); renderTasks();
        panel.classList.remove('show'); overlay.classList.remove('show');
        setTimeout(() => { overlay.remove(); panel.remove(); }, 250);
      });
      deleteBlock.appendChild(deleteBtn);
      body.appendChild(deleteBlock);

      panel.appendChild(body);
      document.body.appendChild(overlay);
      document.body.appendChild(panel);

      requestAnimationFrame(() => { overlay.classList.add('show'); panel.classList.add('show'); });

      function closeDetail() {
        ref.userNote = textarea.value;
        ref.title = titleInput.value;
        ref.note = noteInput.value;
        markChanged(); renderTasks();
        if (activeMainTab === 'focus') renderFocusView();
        panel.classList.remove('show'); overlay.classList.remove('show');
        setTimeout(() => { overlay.remove(); panel.remove(); }, 250);
      }

      overlay.addEventListener('click', closeDetail);
      topbar.querySelector('.plan-detail-close').addEventListener('click', closeDetail);
      const escHandler = (e) => {
        if (e.key === 'Escape') { closeDetail(); document.removeEventListener('keydown', escHandler); }
      };
      document.addEventListener('keydown', escHandler);
    }

    // ============================================================
    // WEEKLY CALENDAR VIEW
    // ============================================================

    function getWeekDays(offset) {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const sunday = new Date(now);
      sunday.setDate(now.getDate() - dayOfWeek + (offset * 7));
      sunday.setHours(0,0,0,0);
      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(sunday);
        d.setDate(sunday.getDate() + i);
        days.push(d);
      }
      return days;
    }

    function dateStr(d) {
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    function getAllTasks() {
      const all = [];
      sections.forEach(s => {
        (tasks[s.id] || []).forEach(t => {
          all.push({ ...t, sectionId: s.id, sectionName: s.name });
        });
      });
      return all;
    }

    function findTaskRef(taskId) {
      for (const s of sections) {
        const arr = tasks[s.id] || [];
        const t = arr.find(x => String(x.id) === String(taskId));
        if (t) return t;
      }
      return null;
    }

    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const dayNamesFull = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // ============================================================
    // GOOGLE CALENDAR INTEGRATION
    // ============================================================

    const GCAL_CLIENT_ID = '642729758803-5pkg75rbpabrsql8gvsd2pj2leo17o8b.apps.googleusercontent.com';
    const GCAL_SCOPES = 'https://www.googleapis.com/auth/calendar';
    let gcalAccessToken = localStorage.getItem('gcal_access_token') || '';
    let gcalTokenExpiry = parseInt(localStorage.getItem('gcal_token_expiry') || '0');
    let gcalEvents = {}; // keyed by date string
    let gcalTokenClient = null;

    function isGcalConnected() {
      return gcalAccessToken && Date.now() < gcalTokenExpiry;
    }

    function initGoogleAuth() {
      if (!GCAL_CLIENT_ID || typeof google === 'undefined') return;
      gcalTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GCAL_CLIENT_ID,
        scope: GCAL_SCOPES,
        callback: (response) => {
          if (response.error) {
            console.error('Google auth error:', response);
            return;
          }
          gcalAccessToken = response.access_token;
          gcalTokenExpiry = Date.now() + (response.expires_in * 1000);
          localStorage.setItem('gcal_access_token', gcalAccessToken);
          localStorage.setItem('gcal_token_expiry', String(gcalTokenExpiry));
          localStorage.setItem('gcal_connected', 'true');
          console.log('Google Calendar connected, fetching events...');
          updateGcalHeaderBtn();
          fetchGoogleCalendarEvents(getPlanWeeks(planWeekOffset)).then(() => {
            console.log('Events fetched:', gcalEvents);
            renderTasks();
          });
        },
      });
    }

    function connectGoogleCalendar() {
      if (!gcalTokenClient) {
        initGoogleAuth();
      }
      if (gcalTokenClient) {
        gcalTokenClient.requestAccessToken();
      } else {
        // GIS not loaded yet, retry after short delay
        setTimeout(() => {
          initGoogleAuth();
          if (gcalTokenClient) gcalTokenClient.requestAccessToken();
          else alert('Google Identity Services 로딩 실패. 페이지를 새로고침해주세요.');
        }, 1000);
      }
    }

    function disconnectGoogleCalendar() {
      if (gcalAccessToken) {
        google.accounts.oauth2.revoke(gcalAccessToken);
      }
      gcalAccessToken = '';
      gcalTokenExpiry = 0;
      gcalEvents = {};
      localStorage.removeItem('gcal_access_token');
      localStorage.removeItem('gcal_token_expiry');
      localStorage.removeItem('gcal_connected');
      gcalTokenClient = null;
      updateGcalHeaderBtn();
      renderWeekCalendar();
    }

    async function fetchGoogleCalendarEvents(days) {
      if (!isGcalConnected()) return;
      const timeMin = new Date(days[0]);
      timeMin.setHours(0,0,0,0);
      const timeMax = new Date(days[days.length - 1]);
      timeMax.setHours(23,59,59,999);

      const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
        `timeMin=${timeMin.toISOString()}&timeMax=${timeMax.toISOString()}` +
        `&singleEvents=true&orderBy=startTime&maxResults=100`;

      try {
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${gcalAccessToken}` }
        });
        if (res.status === 401) {
          // Token expired → try silent re-auth
          gcalAccessToken = '';
          gcalTokenExpiry = 0;
          localStorage.removeItem('gcal_access_token');
          localStorage.removeItem('gcal_token_expiry');
          if (localStorage.getItem('gcal_connected') && gcalTokenClient) {
            gcalTokenClient.requestAccessToken({prompt: ''});
          }
          updateGcalHeaderBtn();
          return;
        }
        const data = await res.json();
        console.log('Google Calendar API response:', data);
        console.log('Events count:', (data.items || []).length);
        gcalEvents = {};
        (data.items || []).forEach(ev => {
          const isAllDay = !!ev.start.date;
          const startStr = isAllDay ? ev.start.date : ev.start.dateTime.slice(0, 10);
          console.log('Event:', ev.summary, 'date:', startStr, 'allDay:', isAllDay);
          if (!gcalEvents[startStr]) gcalEvents[startStr] = [];
          gcalEvents[startStr].push({
            id: ev.id,
            summary: ev.summary || '(No title)',
            start: ev.start,
            end: ev.end,
            isAllDay,
            htmlLink: ev.htmlLink,
          });
        });
        console.log('gcalEvents by date:', JSON.stringify(Object.keys(gcalEvents)));
      } catch(err) {
        console.error('Failed to fetch Google Calendar events:', err);
      }
    }

    async function createGoogleCalendarEvent(eventData) {
      if (!isGcalConnected()) return null;
      try {
        const res = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gcalAccessToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(eventData),
        });
        if (!res.ok) {
          const err = await res.json();
          console.error('Failed to create event:', err);
          alert('일정 생성 실패: ' + (err.error?.message || 'Unknown error'));
          return null;
        }
        return await res.json();
      } catch(err) {
        console.error('Create event error:', err);
        return null;
      }
    }

    function showNewEventModal(dateStr) {
      const overlay = document.createElement('div');
      overlay.className = 'gcal-modal-overlay';
      overlay.innerHTML = `
        <div class="gcal-modal">
          <h3>New Google Calendar Event</h3>
          <label>Title</label>
          <input type="text" id="gcalEvTitle" placeholder="Event title">
          <label>Date</label>
          <input type="date" id="gcalEvDate" value="${dateStr}">
          <label>All-day event?</label>
          <select id="gcalEvAllDay">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
          <div id="gcalTimeFields">
            <label>Start Time</label>
            <input type="time" id="gcalEvStart" value="09:00">
            <label>End Time</label>
            <input type="time" id="gcalEvEnd" value="10:00">
          </div>
          <div class="gcal-modal-actions">
            <button class="gcal-cancel" id="gcalCancel">Cancel</button>
            <button class="gcal-save" id="gcalSave">Create</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const allDaySelect = overlay.querySelector('#gcalEvAllDay');
      const timeFields = overlay.querySelector('#gcalTimeFields');
      allDaySelect.addEventListener('change', () => {
        timeFields.style.display = allDaySelect.value === 'yes' ? 'none' : 'block';
      });

      overlay.querySelector('#gcalCancel').addEventListener('click', () => overlay.remove());
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });

      overlay.querySelector('#gcalSave').addEventListener('click', async () => {
        const title = overlay.querySelector('#gcalEvTitle').value.trim();
        if (!title) { alert('제목을 입력하세요.'); return; }
        const date = overlay.querySelector('#gcalEvDate').value;
        const isAllDay = allDaySelect.value === 'yes';

        let eventData;
        if (isAllDay) {
          const nextDay = new Date(date);
          nextDay.setDate(nextDay.getDate() + 1);
          const endDate = nextDay.toISOString().slice(0, 10);
          eventData = {
            summary: title,
            start: { date },
            end: { date: endDate },
          };
        } else {
          const startTime = overlay.querySelector('#gcalEvStart').value;
          const endTime = overlay.querySelector('#gcalEvEnd').value;
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
          eventData = {
            summary: title,
            start: { dateTime: `${date}T${startTime}:00`, timeZone: tz },
            end: { dateTime: `${date}T${endTime}:00`, timeZone: tz },
          };
        }

        const result = await createGoogleCalendarEvent(eventData);
        if (result) {
          overlay.remove();
          await fetchGoogleCalendarEvents(getWeekDays(weekOffset));
          renderWeekCalendar();
          showStatus('Google Calendar 일정 생성됨');
        }
      });

      overlay.querySelector('#gcalEvTitle').focus();
    }

    async function fetchGcalForPlanView() {
      if (!isGcalConnected()) return;
      const days = getPlanWeeks(planWeekOffset);
      await fetchGoogleCalendarEvents(days);
    }

    // Initialize Google Auth on load
    window.addEventListener('load', () => {
      setTimeout(() => {
        initGoogleAuth();
        updateGcalHeaderBtn();
        if (isGcalConnected()) {
          // Token still valid → fetch events
          fetchGoogleCalendarEvents(getPlanWeeks(planWeekOffset)).then(() => renderTasks());
        } else if (localStorage.getItem('gcal_connected')) {
          // User previously connected but token expired → silent re-auth
          if (gcalTokenClient) {
            gcalTokenClient.requestAccessToken({prompt: ''});
          }
        }
      }, 500);
    });

    function renderWeekCalendar() {
      const days = getWeekDays(weekOffset);
      const todayStr = dateStr(new Date());
      const startDate = days[0];
      const endDate = days[6];

      weekView.innerHTML = '';

      // Navigation
      const nav = document.createElement('div');
      nav.className = 'week-nav';
      const gcalBtnHtml = isGcalConnected()
        ? `<button class="gcal-connect-btn disconnect" id="gcalDisconnect">Disconnect Calendar</button>`
        : `<button class="gcal-connect-btn" id="gcalConnect">Connect Google Calendar</button>`;
      nav.innerHTML = `
        <button id="weekPrev">&larr;</button>
        <button id="weekToday">Today</button>
        <span class="week-label">${monthNames[startDate.getMonth()]} ${startDate.getDate()} &ndash; ${monthNames[endDate.getMonth()]} ${endDate.getDate()}, ${endDate.getFullYear()}</span>
        <button id="weekNext">&rarr;</button>
        ${gcalBtnHtml}
      `;
      weekView.appendChild(nav);

      nav.querySelector('#weekPrev').addEventListener('click', async () => {
        weekOffset--;
        if (isGcalConnected()) await fetchGoogleCalendarEvents(getWeekDays(weekOffset));
        renderWeekCalendar();
      });
      nav.querySelector('#weekNext').addEventListener('click', async () => {
        weekOffset++;
        if (isGcalConnected()) await fetchGoogleCalendarEvents(getWeekDays(weekOffset));
        renderWeekCalendar();
      });
      nav.querySelector('#weekToday').addEventListener('click', async () => {
        weekOffset = 0;
        if (isGcalConnected()) await fetchGoogleCalendarEvents(getWeekDays(weekOffset));
        renderWeekCalendar();
      });
      const gcalConnectBtn = nav.querySelector('#gcalConnect');
      const gcalDisconnectBtn = nav.querySelector('#gcalDisconnect');
      if (gcalConnectBtn) gcalConnectBtn.addEventListener('click', connectGoogleCalendar);
      if (gcalDisconnectBtn) gcalDisconnectBtn.addEventListener('click', disconnectGoogleCalendar);

      // Day grid
      const grid = document.createElement('div');
      grid.className = 'week-grid';
      weekView.appendChild(grid);

      const allTasks = getAllTasks();

      days.forEach((day, idx) => {
        const ds = dateStr(day);
        const isToday = ds === todayStr;
        const col = document.createElement('div');
        col.className = 'day-column' + (isToday ? ' is-today' : '');

        const hdr = document.createElement('div');
        hdr.className = 'day-header';
        hdr.innerHTML = `<div class="day-name">${dayNames[idx]}</div><div class="day-num">${day.getDate()}</div>`;
        col.appendChild(hdr);

        const tasksContainer = document.createElement('div');
        tasksContainer.className = 'day-tasks';
        tasksContainer.dataset.date = ds;

        // Drop handling
        tasksContainer.addEventListener('dragover', (e) => { e.preventDefault(); tasksContainer.classList.add('drag-over'); });
        tasksContainer.addEventListener('dragleave', () => { tasksContainer.classList.remove('drag-over'); });
        tasksContainer.addEventListener('drop', (e) => {
          e.preventDefault();
          tasksContainer.classList.remove('drag-over');
          const taskId = parseFloat(e.dataTransfer.getData('text/plain'));
          const task = findTaskRef(taskId);
          if (task) {
            task.scheduledDate = ds;
            markChanged();
            renderWeekCalendar();
          }
        });

        // Render Google Calendar events for this day
        const dayGcalEvents = gcalEvents[ds] || [];
        if (dayGcalEvents.length > 0) {
          const gcalSection = document.createElement('div');
          gcalSection.className = 'gcal-events-section';
          dayGcalEvents.forEach(ev => {
            const el = document.createElement('div');
            if (ev.isAllDay) {
              el.className = 'gcal-allday';
              el.textContent = ev.summary;
            } else {
              el.className = 'gcal-event';
              const startTime = new Date(ev.start.dateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
              const endTime = new Date(ev.end.dateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
              el.innerHTML = `<div class="gcal-time">${startTime}–${endTime}</div><div>${ev.summary}</div>`;
            }
            if (ev.htmlLink) {
              el.style.cursor = 'pointer';
              el.addEventListener('click', () => window.open(ev.htmlLink, '_blank'));
            }
            gcalSection.appendChild(el);
          });
          tasksContainer.appendChild(gcalSection);
        }

        // Render scheduled tasks for this day
        const dayTasks = allTasks.filter(t => t.scheduledDate === ds);
        dayTasks.forEach(t => {
          const chip = document.createElement('div');
          chip.className = 'day-task-card' + (t.checked ? ' checked-task' : '');
          chip.draggable = true;
          chip.innerHTML = `
            <button class="day-task-remove" title="Unschedule">&times;</button>
            <div>${t.title}</div>
            <div class="day-task-section">${t.sectionName}</div>
          `;
          chip.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', String(t.id));
            chip.style.opacity = '0.4';
          });
          chip.addEventListener('dragend', () => { chip.style.opacity = ''; });
          chip.querySelector('.day-task-remove').addEventListener('click', (e) => {
            e.stopPropagation();
            const ref = findTaskRef(t.id);
            if (ref) {
              ref.scheduledDate = '';
              markChanged();
              renderWeekCalendar();
            }
          });
          tasksContainer.appendChild(chip);
        });

        // Add "+ Event" button if Google Calendar is connected
        if (isGcalConnected()) {
          const addBtn = document.createElement('button');
          addBtn.className = 'gcal-add-event-btn';
          addBtn.textContent = '+ Event';
          addBtn.addEventListener('click', () => showNewEventModal(ds));
          tasksContainer.appendChild(addBtn);
        }

        col.appendChild(tasksContainer);
        grid.appendChild(col);
      });

      // Unscheduled tasks panel — exclude Ideas & References, group by tag, show source
      const excludeSections = ['ideas', 'references'];
      const unscheduled = allTasks.filter(t => !t.scheduledDate && !t.checked && !excludeSections.includes(t.sectionId));

      const panel = document.createElement('div');
      panel.className = 'unscheduled-panel';
      const toggle = document.createElement('div');
      toggle.className = 'unscheduled-toggle';
      toggle.innerHTML = `<span class="arrow">&#9654;</span> Unscheduled tasks (${unscheduled.length})`;
      panel.appendChild(toggle);

      const list = document.createElement('div');
      list.className = 'unscheduled-list';
      list.style.flexDirection = 'column';
      list.style.gap = '10px';

      // Group by tag
      const unschedByTag = {};
      const unschedNoTag = [];
      const orderedTags = ['VD', 'CQ', 'AI', 'BIZ', 'TEAM', 'PERSONAL'];
      orderedTags.forEach(t => unschedByTag[t] = []);

      unscheduled.forEach(t => {
        if (t.tags && t.tags.length > 0) {
          const primaryTag = orderedTags.find(tag => t.tags.includes(tag)) || t.tags[0];
          if (unschedByTag[primaryTag]) unschedByTag[primaryTag].push(t);
          else unschedNoTag.push(t);
        } else {
          unschedNoTag.push(t);
        }
      });

      function renderUnschedGroup(label, tagClass, items, container) {
        if (items.length === 0) return;
        const grp = document.createElement('div');
        grp.style.cssText = 'display:flex;flex-direction:column;gap:4px;';
        const lbl = document.createElement('div');
        lbl.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:2px;';
        lbl.innerHTML = `<span class="tag-badge tag-${tagClass}" style="font-size:10px;padding:1px 8px;">${label}</span><span style="font-size:11px;color:var(--text-muted);">${items.length}</span>`;
        grp.appendChild(lbl);

        const row = document.createElement('div');
        row.style.cssText = 'display:flex;flex-wrap:wrap;gap:5px;';

        items.forEach(t => {
          const chip = document.createElement('div');
          chip.className = 'unscheduled-chip';
          chip.draggable = true;
          chip.style.cssText = 'display:flex;align-items:center;gap:5px;';
          let srcHtml = '';
          if (t.url) {
            let srcEmoji = '';
            if (t.url.includes('slack.com')) srcEmoji = '<span style="font-size:10px;opacity:0.6;">S</span>';
            else if (t.url.includes('notion.so')) srcEmoji = '<span style="font-size:10px;opacity:0.6;">N</span>';
            else if (t.url.includes('steam')) srcEmoji = '<span style="font-size:10px;opacity:0.6;">St</span>';
            srcHtml = srcEmoji;
          }
          chip.innerHTML = `${srcHtml}<span>${t.title}</span>`;
          chip.title = t.sectionName + (t.note ? ': ' + t.note : '');
          chip.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', String(t.id));
            chip.classList.add('dragging');
          });
          chip.addEventListener('dragend', () => { chip.classList.remove('dragging'); });
          row.appendChild(chip);
        });

        grp.appendChild(row);
        container.appendChild(grp);
      }

      orderedTags.forEach(tag => {
        const tc = tagColors[tag] || { label: tag };
        renderUnschedGroup(tc.label || tag, tag, unschedByTag[tag], list);
      });
      if (unschedNoTag.length > 0) {
        const noTagGrp = document.createElement('div');
        noTagGrp.style.cssText = 'display:flex;flex-direction:column;gap:4px;';
        const lbl = document.createElement('div');
        lbl.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:2px;';
        lbl.innerHTML = `<span style="font-size:10px;padding:1px 8px;background:var(--bg-secondary);color:var(--text-muted);border-radius:8px;font-weight:600;">UNTAGGED</span><span style="font-size:11px;color:var(--text-muted);">${unschedNoTag.length}</span>`;
        noTagGrp.appendChild(lbl);
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;flex-wrap:wrap;gap:5px;';
        unschedNoTag.forEach(t => {
          const chip = document.createElement('div');
          chip.className = 'unscheduled-chip';
          chip.draggable = true;
          chip.textContent = t.title;
          chip.title = t.sectionName + (t.note ? ': ' + t.note : '');
          chip.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', String(t.id));
            chip.classList.add('dragging');
          });
          chip.addEventListener('dragend', () => { chip.classList.remove('dragging'); });
          row.appendChild(chip);
        });
        noTagGrp.appendChild(row);
        list.appendChild(noTagGrp);
      }

      panel.appendChild(list);

      toggle.addEventListener('click', () => {
        list.classList.toggle('open');
        toggle.querySelector('.arrow').classList.toggle('open');
      });

      weekView.appendChild(panel);
    }

    // ============================================================
    // TIMELINE VIEW
    // ============================================================

    function renderTimeline() { }
    function _renderTimeline_unused() {
      var timelineView = document.createElement('div');
      timelineView.innerHTML = '';
      const tagLabels = { VD: 'VOID DIVER', CQ: 'CQ', AI: 'AI', BIZ: 'BIZ', TEAM: 'TEAM', PERSONAL: 'PERSONAL' };

      sections.forEach(section => {
        const sectionTasks = tasks[section.id] || [];
        if (sectionTasks.length === 0) return;

        const sec = document.createElement('div');
        sec.className = 'timeline-section';

        const hdr = document.createElement('div');
        hdr.className = 'timeline-section-header';
        hdr.innerHTML = `
          <span>${section.name}</span>
          <span class="line"></span>
          <span class="count">${sectionTasks.length}</span>
        `;
        sec.appendChild(hdr);

        const items = document.createElement('div');
        items.className = 'timeline-items';

        sectionTasks.forEach(t => {
          const item = document.createElement('div');
          item.className = 'timeline-item' + (t.checked ? ' is-checked' : '');

          const dot = document.createElement('div');
          dot.className = 'timeline-dot';
          item.appendChild(dot);

          const contentEl = document.createElement('div');
          contentEl.className = 'timeline-content';

          let titleHtml = `<div class="timeline-title">${t.title}</div>`;
          if (t.note) {
            titleHtml += `<div class="timeline-note">${t.note}</div>`;
          }

          let metaHtml = '';
          if ((t.tags && t.tags.length) || t.url || t.scheduledDate) {
            metaHtml = '<div class="timeline-meta">';
            if (t.tags) {
              t.tags.forEach(tag => {
                metaHtml += `<span class="tag-badge tag-${tag}" style="font-size:10px;padding:1px 6px;">${tagLabels[tag] || tag}</span>`;
              });
            }
            if (t.scheduledDate) {
              metaHtml += `<span style="font-size:11px;color:var(--accent);font-weight:500;">${t.scheduledDate}</span>`;
            }
            if (t.url) {
              const srcLabel = t.url.includes('slack.com') ? 'Slack' : t.url.includes('notion.so') ? 'Notion' : t.url.includes('steam') ? 'Steam' : 'Link';
              metaHtml += `<a href="${t.url}" target="_blank" rel="noopener" style="font-size:11px;color:var(--accent);text-decoration:none;">${srcLabel} &rarr;</a>`;
            }
            metaHtml += '</div>';
          }

          let subHtml = '';
          if (t.subtasks && t.subtasks.length > 0) {
            const done = t.subtasks.filter(s => s.checked).length;
            subHtml = `<div class="timeline-subtasks">${done}/${t.subtasks.length} subtasks done</div>`;
          }

          contentEl.innerHTML = titleHtml + metaHtml + subHtml;
          item.appendChild(contentEl);
          items.appendChild(item);
        });

        sec.appendChild(items);
        timelineView.appendChild(sec);
      });

      if (timelineView.innerHTML === '') {
        timelineView.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No tasks to display</div>';
      }
    }

        function startAddingSection(btn) {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Section name...';
      input.style.cssText = 'width: 220px; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 14px; font-family: inherit; outline: none;';

      btn.innerHTML = '';
      btn.style.cssText = 'background: var(--bg-secondary); border: 2px dashed var(--accent); display: flex; align-items: center; justify-content: center; cursor: default; min-height: 120px; min-width: 340px; border-radius: 12px;';
      btn.appendChild(input);
      input.focus();

      let saved = false;
      const saveSection = () => {
        if (saved) return;
        saved = true;
        const name = input.value.trim();
        if (name) {
          const id = taskSectionId(name);
          if (!tasks[id]) {
            sections.push({ id, name });
            tasks[id] = [];
            markChanged();
          }
        }
        renderTasks();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); saveSection(); }
        else if (e.key === 'Escape') { saved = true; renderTasks(); }
      });
      input.addEventListener('blur', saveSection);
    }

    async function openTaskFile() {
      try {
        [taskFileHandle] = await window.showOpenFilePicker({
          types: [{ description: 'Markdown', accept: { 'text/markdown': ['.md'] } }]
        });
        const file = await taskFileHandle.getFile();
        const content = await file.text();
        lastModified = file.lastModified;
        const result = parseTaskMarkdown(content);
        sections = result.sections;
        tasks = result.tasks;
        taskFileName = file.name;
        saveToLocalStorage();
        switchTaskView('tags');
        startWatching();
        filePathEl.textContent = file.name;
        showStatus('Loaded ' + file.name);
      } catch (e) {
        if (e.name !== 'AbortError') { showStatus('Error: ' + e.message); }
      }
    }

    openTaskBtn.addEventListener('click', openTaskFile);
    document.getElementById('openBtnLarge')?.addEventListener('click', openTaskFile);

    // 임베딩/localStorage 로드 후, Supabase에서 최신 데이터 비동기 로드
    (async () => {
      if (!sb) return;
      try {
        const loaded = await loadFromSupabase();
        if (loaded) {
          saveToLocalStorage();
          renderTasks();
          switchTaskView(currentView);
          showStatus('Loaded from cloud');
        }
      } catch(e) { console.log('Supabase auto-load error:', e); }
    })();

    saveBtn.addEventListener('click', async () => {
      if (!taskFileHandle) return;
      try {
        const writable = await taskFileHandle.createWritable();
        await writable.write(toMarkdown());
        await writable.close();
        hasChanges = false;
        saveBtn.disabled = true;
        showStatus('Saved');
      } catch (e) { showStatus('Error: ' + e.message); }
    });

    window.addEventListener('beforeunload', (e) => {
      if (hasChanges) { e.preventDefault(); e.returnValue = ''; }
    });

    // ============================================================
    // ===== MEMORY FUNCTIONALITY =====
    // ============================================================

    let memoryDirHandle = null;
    let memoryData = {
      claudeMd: null,
      memoryFiles: [],
      memoryDirs: {}
    };

    const memoryEmptyState = document.getElementById('memoryEmptyState');
    const memoryMainContent = document.getElementById('memoryMainContent');
    const memoryTabsContainer = document.getElementById('memoryTabsContainer');
    const memoryContentContainer = document.getElementById('memoryContentContainer');
    const modalOverlay = document.getElementById('modalOverlay');

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function parseMemoryMarkdown(content) {
      const parsed = {
        title: '',
        fields: {},
        sections: {},
        tables: [],
        rawContent: content
      };

      const lines = content.split('\n');
      let currentSection = '_intro';
      parsed.sections[currentSection] = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (line.match(/^# /)) {
          parsed.title = line.replace(/^# /, '').trim();
          continue;
        }

        if (line.match(/^## /)) {
          currentSection = line.replace(/^## /, '').trim();
          parsed.sections[currentSection] = [];
          continue;
        }

        const kvMatch = line.match(/^\*\*(.+?):\*\*\s*(.*)$/);
        if (kvMatch) {
          parsed.fields[kvMatch[1]] = kvMatch[2];
          continue;
        }

        parsed.sections[currentSection].push(line);
      }

      for (const key in parsed.sections) {
        parsed.sections[key] = parsed.sections[key].join('\n').trim();
      }

      const tableRegex = /\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)+)/g;
      let match;
      while ((match = tableRegex.exec(content)) !== null) {
        const headers = match[1].split('|').map(h => h.trim()).filter(h => h);
        const rowLines = match[2].trim().split('\n');
        const rows = rowLines.map(row => row.split('|').map(c => c.trim()).filter(c => c));
        parsed.tables.push({ headers, rows });
      }

      return parsed;
    }

    function getPreview(content, maxLength = 150) {
      let preview = content
        .replace(/^#+ .+$/gm, '')
        .replace(/\*\*(.+?):\*\*.*/g, '')
        .replace(/\|.+\|/g, '')
        .replace(/[-=]{3,}/g, '')
        .trim()
        .substring(0, maxLength);
      if (content.length > maxLength) preview += '...';
      return preview;
    }

    function getDisplayName(filename) {
      return filename
        .replace('.md', '')
        .split(/[-_]/)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }

    async function loadMemoryDirectory() {
      try {
        memoryDirHandle = await window.showDirectoryPicker();

        memoryData = { claudeMd: null, memoryFiles: [], memoryDirs: {} };

        try {
          const claudeFileHandle = await memoryDirHandle.getFileHandle('CLAUDE.md');
          const file = await claudeFileHandle.getFile();
          memoryData.claudeMd = { content: await file.text(), fileHandle: claudeFileHandle };
        } catch (e) { console.log('No CLAUDE.md found'); }

        try {
          const memoryDir = await memoryDirHandle.getDirectoryHandle('memory');
          for await (const entry of memoryDir.values()) {
            if (entry.kind === 'file' && entry.name.endsWith('.md')) {
              const file = await entry.getFile();
              memoryData.memoryFiles.push({
                name: entry.name,
                content: await file.text(),
                fileHandle: entry
              });
            } else if (entry.kind === 'directory') {
              memoryData.memoryDirs[entry.name] = [];
              const subDirHandle = entry;
              for await (const subEntry of subDirHandle.values()) {
                if (subEntry.kind === 'file' && subEntry.name.endsWith('.md')) {
                  const file = await subEntry.getFile();
                  const content = await file.text();
                  memoryData.memoryDirs[entry.name].push({
                    name: subEntry.name,
                    content: content,
                    fileHandle: subEntry,
                    dirHandle: subDirHandle,
                    parsed: parseMemoryMarkdown(content)
                  });
                }
              }
            }
          }
        } catch (e) { console.log('No memory/ directory found'); }

        renderMemory();
        memoryEmptyState.style.display = 'none';
        memoryMainContent.style.display = 'flex';
        filePathEl.textContent = memoryDirHandle.name;
        showStatus('Loaded memory from ' + memoryDirHandle.name);

      } catch (e) {
        if (e.name !== 'AbortError') { showStatus('Error: ' + e.message); }
      }
    }

    function renderMemory() {
      renderMemoryTabs();
      renderMemoryContent();
    }

    function renderMemoryTabs() {
      let html = '';

      if (memoryData.claudeMd) {
        html += `<button class="memory-tab active" data-tab="overview">Overview</button>`;
      }

      for (const file of memoryData.memoryFiles) {
        const name = file.name.replace('.md', '');
        html += `<button class="memory-tab${!memoryData.claudeMd && memoryData.memoryFiles[0] === file ? ' active' : ''}" data-tab="file-${name}">${name}</button>`;
      }

      for (const dirName of Object.keys(memoryData.memoryDirs).sort()) {
        const files = memoryData.memoryDirs[dirName];
        let count;
        if (dirName === 'context') {
          count = 0;
          for (const file of files) {
            const p = file.parsed;
            count += Object.keys(p.fields).length;
            for (const table of p.tables) {
              count += table.rows.length;
            }
            for (const [sName, sContent] of Object.entries(p.sections)) {
              if (sContent && sName !== '_intro') {
                count += sContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('|')).length;
              }
            }
          }
        } else {
          count = files.length;
        }
        html += `<button class="memory-tab" data-tab="dir-${dirName}">${dirName} <span class="count">${count}</span></button>`;
      }

      memoryTabsContainer.innerHTML = html;

      memoryTabsContainer.querySelectorAll('.memory-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          memoryTabsContainer.querySelectorAll('.memory-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          renderMemoryContent();
        });
      });
    }

    function renderMemoryContent() {
      const activeTab = memoryTabsContainer.querySelector('.memory-tab.active');
      if (!activeTab) return;

      const tabId = activeTab.dataset.tab;

      if (tabId === 'overview') { renderMemoryOverview(); }
      else if (tabId.startsWith('file-')) {
        const fileName = tabId.replace('file-', '') + '.md';
        renderMemoryFile(fileName);
      } else if (tabId.startsWith('dir-')) {
        const dirName = tabId.replace('dir-', '');
        renderMemoryDirectory(dirName);
      }
    }

    function renderMemoryOverview() {
      if (!memoryData.claudeMd) return;

      let statsHtml = '<div class="stats">';
      for (const [dirName, files] of Object.entries(memoryData.memoryDirs)) {
        let count;
        if (dirName === 'context') {
          count = 0;
          for (const file of files) {
            const p = file.parsed;
            count += Object.keys(p.fields).length;
            for (const table of p.tables) { count += table.rows.length; }
            for (const [sName, sContent] of Object.entries(p.sections)) {
              if (sContent && sName !== '_intro') {
                count += sContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('|')).length;
              }
            }
          }
        } else {
          count = files.length;
        }
        statsHtml += `
          <div class="stat">
            <div class="stat-value">${count}</div>
            <div class="stat-label">${dirName}</div>
          </div>
        `;
      }
      statsHtml += '</div>';

      const claudeContent = renderMarkdownToHtml(memoryData.claudeMd.content);

      memoryContentContainer.innerHTML = `
        ${statsHtml}
        <div class="file-card">
          <div class="file-card-header" onclick="this.nextElementSibling.classList.toggle('expanded'); this.querySelector('.toggle').textContent = this.nextElementSibling.classList.contains('expanded') ? '\u2212' : '+'">
            <span class="file-card-title">CLAUDE.md</span>
            <span class="toggle" style="color: var(--text-muted);">&minus;</span>
          </div>
          <div class="file-card-content expanded markdown-content">${claudeContent}</div>
        </div>
        <button onclick="openEditModal('CLAUDE.md', 'claudeMd')" style="margin-top: 10px;">Edit CLAUDE.md</button>
      `;
    }

    function renderMemoryFile(fileName) {
      const file = memoryData.memoryFiles.find(f => f.name === fileName);
      if (!file) return;

      const content = renderMarkdownToHtml(file.content);

      memoryContentContainer.innerHTML = `
        <div class="file-card">
          <div class="file-card-header">
            <span class="file-card-title">${fileName}</span>
          </div>
          <div class="file-card-content expanded markdown-content">${content}</div>
        </div>
        <button onclick="openEditModal('${fileName}', 'memoryFile')" style="margin-top: 10px;">Edit ${fileName}</button>
      `;
    }

    function renderMemoryDirectory(dirName) {
      const files = memoryData.memoryDirs[dirName] || [];

      // Context directory uses flat list view
      if (dirName === 'context') {
        renderMemoryDirectoryFlat(dirName, files);
        return;
      }

      // All other directories use card grid view
      let html = `
        <div class="search-box">
          <span style="color: var(--text-muted);">&#128269;</span>
          <input type="text" placeholder="Search ${dirName}..." id="dirSearch" oninput="filterMemoryDirectory('${dirName}', this.value)">
        </div>
        <div class="memory-grid" id="dirGrid">
      `;

      for (const file of files) {
        const p = file.parsed;
        const title = p.title || getDisplayName(file.name);

        let fieldsHtml = '';
        const fieldEntries = Object.entries(p.fields).slice(0, 3);
        if (fieldEntries.length > 0) {
          fieldsHtml = '<div class="memory-card-fields">';
          for (const [key, value] of fieldEntries) {
            fieldsHtml += `
              <div class="memory-card-field">
                <span class="memory-card-field-label">${escapeHtml(key)}</span>
                <span class="memory-card-field-value">${escapeHtml(value)}</span>
              </div>
            `;
          }
          fieldsHtml += '</div>';
        }

        let preview = '';
        for (const [sectionName, sectionContent] of Object.entries(p.sections)) {
          if (sectionContent && sectionName !== '_intro') {
            preview = getPreview(sectionContent, 100);
            break;
          }
        }
        if (!preview) preview = getPreview(p.rawContent, 100);

        html += `
          <div class="memory-card" onclick="openFileModal('${dirName}', '${file.name}')" data-search="${escapeHtml((title + ' ' + JSON.stringify(p.fields) + ' ' + p.rawContent).toLowerCase())}">
            <div class="memory-card-title">${escapeHtml(title)}</div>
            ${fieldsHtml}
            <div class="memory-card-preview">${escapeHtml(preview)}</div>
          </div>
        `;
      }

      html += `
        <div class="add-btn" onclick="openNewFileModal('${dirName}')">
          + Add to ${dirName}
        </div>
      </div>`;

      memoryContentContainer.innerHTML = html;
    }

    function renderMemoryDirectoryFlat(dirName, files) {
      let html = `
        <div class="search-box">
          <span style="color: var(--text-muted);">&#128269;</span>
          <input type="text" placeholder="Search ${dirName}..." id="dirSearch" oninput="filterMemoryDirectory('${dirName}', this.value)">
        </div>
        <div id="dirGrid">
      `;

      for (const file of files) {
        const p = file.parsed;

        // Render fields as a key-value table
        const fieldEntries = Object.entries(p.fields);
        if (fieldEntries.length > 0) {
          html += `<div class="file-card" style="margin-bottom: 16px;"><table class="memory-flat-table"><tbody>`;
          for (const [key, value] of fieldEntries) {
            html += `<tr data-search="${escapeHtml((key + ' ' + value).toLowerCase())}"><td>${escapeHtml(key)}</td><td>${escapeHtml(value)}</td></tr>`;
          }
          html += `</tbody></table></div>`;
        }

        // Render parsed tables (teams, tools, etc.) as proper HTML tables
        for (const table of p.tables) {
          html += `<div class="file-card" style="margin-bottom: 16px;"><table class="memory-flat-table"><thead><tr>`;
          for (const h of table.headers) {
            html += `<th>${escapeHtml(h)}</th>`;
          }
          html += `</tr></thead><tbody>`;
          for (const row of table.rows) {
            const searchData = row.join(' ').toLowerCase();
            html += `<tr data-search="${escapeHtml(searchData)}">`;
            for (const cell of row) {
              html += `<td>${escapeHtml(cell)}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table></div>`;
        }

        // Render non-table section content as list items
        for (const [sectionName, sectionContent] of Object.entries(p.sections)) {
          if (!sectionContent || sectionName === '_intro') continue;
          const lines = sectionContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('|'));
          if (lines.length === 0) continue;
          html += `<div class="file-card" style="margin-bottom: 16px;"><table class="memory-flat-table"><thead><tr><th colspan="2">${escapeHtml(sectionName)}</th></tr></thead><tbody>`;
          for (const line of lines) {
            const cleanLine = line.replace(/^[-*]\s*/, '').replace(/\*\*(.+?)\*\*/g, '$1').trim();
            if (!cleanLine) continue;
            html += `<tr data-search="${escapeHtml((sectionName + ' ' + cleanLine).toLowerCase())}"><td colspan="2">${escapeHtml(cleanLine)}</td></tr>`;
          }
          html += `</tbody></table></div>`;
        }
      }

      html += `</div>`;
      memoryContentContainer.innerHTML = html;
    }

    function filterMemoryDirectory(dirName, searchTerm) {
      const grid = document.getElementById('dirGrid');
      const items = grid.querySelectorAll('.memory-card, tr[data-search]');
      const search = searchTerm.toLowerCase();
      items.forEach(item => {
        const searchData = item.dataset.search || '';
        item.style.display = (!search || searchData.includes(search)) ? '' : 'none';
      });
    }

    function renderMarkdownToHtml(md) {
      let html = escapeHtml(md);

      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/```[\s\S]*?```/g, match => {
        const code = match.replace(/```\w*\n?/g, '');
        return '<pre><code>' + code + '</code></pre>';
      });
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      html = html.replace(/(\|.+\|\n\|[-| ]+\|\n(?:\|.+\|\n?)+)/g, match => {
        const lines = match.trim().split('\n');
        const headers = lines[0].split('|').filter(c => c.trim());
        const rows = lines.slice(2).map(row => row.split('|').filter(c => c.trim()));
        let table = '<table><thead><tr>';
        headers.forEach(h => table += `<th>${h.trim()}</th>`);
        table += '</tr></thead><tbody>';
        rows.forEach(row => {
          table += '<tr>';
          row.forEach(cell => table += `<td>${cell.trim()}</td>`);
          table += '</tr>';
        });
        table += '</tbody></table>';
        return table;
      });
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
      html = html.replace(/^(?!<[hupol]|<li|<table|<pre)(.+)$/gm, '<p>$1</p>');
      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p>\s*<\/p>/g, '');

      return html;
    }

    // Modal functions
    function openFileModal(dirName, fileName) {
      const files = memoryData.memoryDirs[dirName];
      const file = files.find(f => f.name === fileName);
      if (!file) return;

      document.getElementById('modalTitle').textContent = getDisplayName(fileName);
      document.getElementById('modalBody').innerHTML = `
        <div class="markdown-content" style="margin-bottom: 20px;">
          ${renderMarkdownToHtml(file.content)}
        </div>
        <div class="form-group">
          <label>Edit Raw Markdown</label>
          <textarea id="editContent">${escapeHtml(file.content)}</textarea>
        </div>
      `;

      modalOverlay.classList.add('visible');
      modalOverlay.dataset.type = 'dirFile';
      modalOverlay.dataset.dirName = dirName;
      modalOverlay.dataset.fileName = fileName;
    }

    function openNewFileModal(dirName) {
      document.getElementById('modalTitle').textContent = `Add to ${dirName}`;

      let template = '# New Entry\n\n';
      const existingFiles = memoryData.memoryDirs[dirName];
      if (existingFiles && existingFiles.length > 0) {
        const sample = existingFiles[0].parsed;
        for (const key of Object.keys(sample.fields)) {
          template += `**${key}:** \n`;
        }
        template += '\n';
        for (const section of Object.keys(sample.sections)) {
          if (section !== '_intro') {
            template += `## ${section}\n\n`;
          }
        }
      }

      document.getElementById('modalBody').innerHTML = `
        <div class="form-group">
          <label>Filename (without .md)</label>
          <input type="text" id="newFileName" placeholder="my-new-entry" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; color: var(--text-primary); font-size: 14px; font-family: inherit; margin-bottom: 16px;">
        </div>
        <div class="form-group">
          <label>Content</label>
          <textarea id="editContent">${escapeHtml(template)}</textarea>
        </div>
      `;

      modalOverlay.classList.add('visible');
      modalOverlay.dataset.type = 'newDirFile';
      modalOverlay.dataset.dirName = dirName;
    }

    function openEditModal(fileName, type) {
      let content = '';
      if (type === 'claudeMd') {
        content = memoryData.claudeMd.content;
      } else if (type === 'memoryFile') {
        const file = memoryData.memoryFiles.find(f => f.name === fileName);
        if (file) content = file.content;
      }

      document.getElementById('modalTitle').textContent = `Edit ${fileName}`;
      document.getElementById('modalBody').innerHTML = `
        <div class="form-group">
          <label>Content</label>
          <textarea id="editContent" style="min-height: 400px;">${escapeHtml(content)}</textarea>
        </div>
      `;

      modalOverlay.classList.add('visible');
      modalOverlay.dataset.type = type;
      modalOverlay.dataset.fileName = fileName;
    }

    function closeModal() {
      modalOverlay.classList.remove('visible');
    }

    async function saveModal() {
      const type = modalOverlay.dataset.type;
      const content = document.getElementById('editContent').value;

      try {
        if (type === 'claudeMd') {
          memoryData.claudeMd.content = content;
          const writable = await memoryData.claudeMd.fileHandle.createWritable();
          await writable.write(content);
          await writable.close();
          showStatus('Saved CLAUDE.md');

        } else if (type === 'memoryFile') {
          const fileName = modalOverlay.dataset.fileName;
          const file = memoryData.memoryFiles.find(f => f.name === fileName);
          if (file) {
            file.content = content;
            const writable = await file.fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            showStatus('Saved ' + fileName);
          }

        } else if (type === 'dirFile') {
          const dirName = modalOverlay.dataset.dirName;
          const fileName = modalOverlay.dataset.fileName;
          const files = memoryData.memoryDirs[dirName];
          const file = files.find(f => f.name === fileName);
          if (file) {
            file.content = content;
            file.parsed = parseMemoryMarkdown(content);
            const writable = await file.fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            showStatus('Saved ' + fileName);
          }

        } else if (type === 'newDirFile') {
          const dirName = modalOverlay.dataset.dirName;
          let fileName = document.getElementById('newFileName').value.trim();
          if (!fileName) { showStatus('Please enter a filename'); return; }
          if (!fileName.endsWith('.md')) fileName += '.md';

          const memoryDir = await memoryDirHandle.getDirectoryHandle('memory');
          const subDir = await memoryDir.getDirectoryHandle(dirName, { create: true });
          const fileHandle = await subDir.getFileHandle(fileName, { create: true });

          const writable = await fileHandle.createWritable();
          await writable.write(content);
          await writable.close();

          memoryData.memoryDirs[dirName].push({
            name: fileName,
            content: content,
            fileHandle: fileHandle,
            dirHandle: subDir,
            parsed: parseMemoryMarkdown(content)
          });

          showStatus('Created ' + fileName);
        }

        closeModal();
        renderMemory();

      } catch (e) {
        showStatus('Error saving: ' + e.message);
      }
    }

    // Memory event listeners
    openMemoryBtn.addEventListener('click', loadMemoryDirectory);
    document.getElementById('openMemoryBtnLarge').addEventListener('click', loadMemoryDirectory);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalCancel').addEventListener('click', closeModal);
    document.getElementById('modalSave').addEventListener('click', saveModal);

    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Expose functions to onclick handlers
    window.openFileModal = openFileModal;
    window.openNewFileModal = openNewFileModal;
    window.openEditModal = openEditModal;
    window.filterMemoryDirectory = filterMemoryDirectory;

    // ============================================================
    // ===== AUTO-LOAD EMBEDDED TASKS =====
    // ============================================================
    (function autoLoadTasks() {
      // Skip embedded data if localStorage already has data
      if (sections.length > 0) return;

      const embeddedContent = `# Tasks

## DELAYED (3mo+ repeat)
- [ ] **퍼블리셔 대응/정리** - 워크플로우 세팅, 중국/북미 에이전시, 사업지원 체계 (5회+ 반복, 12월~) #VD #BIZ {{https://www.notion.so/2fcba9422534809d9ccaf1a39cbeac12}}
  - [ ] 퍼블리셔 체크리스트 만들기
  - [ ] 에이전시 PR 대응 (중국편, 북미, 로드컴플릿)
  - [ ] 사업쪽 지원 어떻게 받는가 구조화
- [ ] **중국 시장 대응** - 계약, QQ그룹, 빌리빌리 마케팅, 중문 스토어 최적화 (5회+ 반복, 12월~) #VD
  - [ ] 중국 퍼블리셔 추가 계약 알아보기
  - [ ] QQ 그룹 세팅
  - [ ] 빌리빌리→Heybox→Steam 위시 퍼널 구축
  - [ ] Sologame 스토어 페이지 중문 설명 퀄리티 점검
- [ ] **게임 지표 기준 설립** - 선제지표, 위시리스트 기준, Retention DD, 게임애널리틱스 (5회+ 반복) #VD #CQ {{https://www.notion.so/2e7ba942253480dab259d60f0848b998}}
  - [ ] 지표 열어주기 (게임애널)
  - [ ] 간단 리포트 + 복잡 리포트 준비
  - [ ] 데이터팀 결과 공유
- [ ] **AI TF / AI 조직** - AI assist + AI TF 합체, 에이전트 워크플로우, 사업화 오케스트레이션 (4회+) #AI
  - [ ] AI assist조직과 AI TF 합체 방향 결정
  - [ ] 에이전트 리서치 + 파이프라인 자동화 검토
  - [ ] AI 통합 문서 월별 정리
- [ ] **영규님 관련** - GDC 3/16, 양채우기, 커뮤니케이션, 레딧, DM방 (4회+) #VD
  - [ ] GDC 3/16 준비 지원
  - [ ] 영규 DM방 개설
  - [ ] 레딧 커뮤니티 세팅
- [ ] **CQ 방향성 결정** - 스팀 vs 모바일, CQ IP, CQ Town, CQ Rebirth (4회+) #CQ
  - [ ] CQ 스팀이냐 모바일이냐 결론
  - [ ] CQIP 넘기는 문제 정리
  - [ ] CQ Town 넥스트 플랜 + 매출 예상
  - [ ] CQ Rebirth write-up (to 최고)
- [ ] **영상 제작 / 트레일러** - 새 영상, 킥스타터 시너지, Never Way 트레일러 (4회+) #VD
  - [ ] 영상 새로 만들기
  - [ ] Never Way 트레일러
  - [ ] 킥스타터 + 트레일러 시너지 검토 (INARI 참고)
- [ ] **벨브(Valve) 콘택** - 스팀 직접 콘택 (3회, 2월부터) #VD
- [ ] **캐주얼 게임 방향** - 프로토 그만, 한국만 할수있는것, 콜라보 (3회) #BIZ
- [ ] **학교/인재원 알리기** - 청강, 게임인재원, 교수님 연락 (3회) #BIZ
- [ ] **차상훈 관련** - 모닝커피, 일정, CQ 관련 (3회) #CQ
- [ ] **회사 브리프 자료** - 수정대표 피드, 에이전트 학습용 자료 (3회) #BIZ

## Active
- [ ] **넥페(Next Fest) 전략** - 2월 vs 6월 장단점, 프롤로그 vs demo2.0 #VD {{https://www.notion.so/2fdba942253480bb89c2f3ee31326d47}}
  - [ ] 넥페 참가 여부 결정
  - [ ] 얼리엑세스 여부 결정
  - [ ] 2~6월 프롤로그때 다양한 피처 실험
- [ ] **그린라이트 회의 팔로업** - 선언 + 인원지원 + 체크리스트 #TEAM {{https://www.notion.so/2efba94225348121a70dfd1629210e83}}
- [ ] **스팀덱 지원** - 넥페 이전 구현 필요, Deck Verified 마케팅 효과 큼 #VD {{https://loadcomplete.slack.com/archives/C06CWM6AQJY/p1769481369847959}}
- [ ] **마이크로인플루언서 전략** - 스트리머 캠페인 #VD
- [ ] **에이전시 PR 대응** - 기초 PR 중국편, 북미, 대행사 #VD #BIZ
- [ ] **캡슐 이미지 리프레시** - Search Suggestions CTR 하락, 새 캐릭터 추가시 동시 교체 #VD {{https://loadcomplete.slack.com/archives/C05ML4UR7GE/p1769476733236209}}
- [ ] **팀 구조 안정화** - 기획보강, 핵심멤버 리스트업 #TEAM
  - [ ] 애니메이터 포트폴리오 (예쓸님)
  - [ ] 이펙트 쿼터뷰
  - [ ] 크퀘 리버스 단계별 핵심멤버 정리
- [ ] **벨류에이션 / 투자** - 디벨류에이션, 한투파 설득, 유상증자 #BIZ
  - [ ] 투자사 미팅 팔로업 (12월, 2월, 5월)
- [ ] **호영 아젠다 정리** - 인턴, 중헌, 피드백채널, Ice, 업데이트, 크래프톤, 데모, KV, 로드맵 #VD #TEAM
- [ ] **세이브 데이터 정책** - 보상 연동 방식, 유저 기대 관리 #VD
- [ ] **유저 유지 콘텐츠** - 무한모드? 뱀서같은? #VD
- [ ] **중국 카피 대응** - 시범런치 후 선빵 전략 #VD
- [ ] **DRG 자료 공개** - 매출 시뮬레이션, 생존자 편향 방어 #VD #BIZ
- [ ] **마솽 콘택** - 다녀와서 미팅 세팅 #BIZ
- [ ] **미니테일즈 미팅** - #BIZ
- [ ] **인포그래픽 통합 관리** - MM트래킹 + seed/alpha/beta 프로덕션 상태 통합 #TEAM {{https://loadcomplete.slack.com/archives/C07UE1WCZHD/p1767938589887059}}
- [ ] **25년 소재 제작 리뷰** - 총 263개, 풀AI 7개, 캠페인 투입 0 #AI {{https://loadcomplete.slack.com/archives/C09EBJWV4GL/p1768210365055669}}
- [ ] **시드 프로세스** - 유닛 검증 방식 (메카닉 or 아트 KPI) #TEAM {{https://loadcomplete.slack.com/archives/C09FPR1C8HZ/p1768298780340749}}
- [ ] **CQ-TOWN 26.03 출시 스펙** - 연출 추가, 폴리싱 #CQ {{https://loadcomplete.slack.com/archives/C09TVNKV8M8/p1768543008953159}}
- [ ] **커스텀 케이크 / 런칭격려금** - 정책 디테일 논의 #TEAM
- [ ] **부동산 공부** - #PERSONAL
- [ ] **데스크 구매** - 메이우드, 칙칙한 느낌 탈피 #PERSONAL
- [ ] **디자인 레퍼런스 수집** - awwwards.com 등에서 UI/UX 디자인 참고 가져오기 #PERSONAL

## Waiting On
- [ ] **성은 - 신작 프로젝트 현황/월별 보고** - 쓰레드 참고 (since 01-16) #TEAM {{https://loadcomplete.slack.com/archives/C07UE1WCZHD/p1768530619236049}}
- [ ] **최고 - CQ 스팀 vs 모바일 괌 숙제** - 답변 대기 (since 02-10) #CQ
- [ ] **호영 - 보고 체계** - 요청은 너가 (since 02-13) #VD #TEAM
- [ ] **찬솔 - CQ Town 매출 예상** - 정기회의 세팅 (since 02-10) #CQ
- [ ] **수정대표 - 회사 자료 피드** - transform, 청강, 중헌 (since 02-10) #BIZ

## Ideas
- [ ] **웹툰 제작** - 울트라미디어 (모기전쟁, 더복서) 참고 #VD
- [ ] **CQ Reimagined for Steam** - DQ7 리이매진드 참고, 스팀 맞춤 리메이크 #CQ
- [ ] **나홍진 스타일 영상** - AI 아닌 한국적 영상 방향 #VD
- [ ] **킥스타터 INARI** - 넥페 직전 홍보수단 #VD
- [ ] **원버튼 게임 코어 메카닉 검증** - Claude로 빠르게, 직군 무관 검증 #AI {{https://loadcomplete.slack.com/archives/C09FPR1C8HZ/p1767922524038429}}
- [ ] **AI 에이전트 공정 자동화** - 아이디어→영상→배포→리포트 전체 파이프라인 #AI
- [ ] **DE NEXT** - 기다릴 필요? 우리도 뭔가 보여주자 #BIZ
- [ ] **슬랙 UX봇 / 파이어베이스** - 프로젝트 후보 #AI
- [ ] **인터랙티브 게임 프로젝트** - 프로젝트 아이디어 #BIZ
- [ ] **Deferred Server Integration** - Agile Dev 서버 통합 #VD

## References
- [ ] **Cast n Chill (Steam)** - 낚시 게임, 압긍! #VD {{https://store.steampowered.com/app/3261020/Cast_n_Chill/}}
- [ ] **GamesBeat Summit - Jenova Chen** - Thatgamecompany 감성 게임 강연 #VD {{https://www.notion.so/2fbba9422534800aaf58c53945380b9f}}
- [ ] **한국 모바일 게임 시장 트렌드** - mmorpg 매출50%, 한국 신작 부재 #BIZ {{https://loadcomplete.slack.com/archives/CG5G13YCX/p1768968069019129}}
- [ ] **멀티플레이어 픽셀 탈출류 UX** - 현진2 분석, 숙련도 시스템 제안 #VD {{https://loadcomplete.slack.com/archives/C05ML4UR7GE/p1770864287819849}}
- [ ] **Void Diver 투자자 관점** - 데모 1주 위시20K, 리뷰90%+, PR미사용 #VD #BIZ {{https://www.notion.so/2f5ba942253480d598f1ce88a7bc55e3}}
- [ ] **성공 레퍼런스들** - 펍지+림버스, 블랙서바이벌, 데이브더다이버, Shape of Dream #VD
- [ ] **DRG 분석** - 매출 시뮬레이션, 소규모팀 효율 #VD
- [ ] **일정 관리툴** - loadcomplete-scheduler.web.app (진평) #TEAM {{https://loadcomplete.slack.com/archives/C0A79SLGBGQ/p1769561508755129}}
- [ ] **비교군 소스** - gamecompany.co 스팀 데이터 #VD {{https://loadcomplete.slack.com/archives/C06DPD4985N/p1769740421972289}}
- [ ] **애나 렘키 - 도파민 중독 탈출** - 균형잡힌 삶 #PERSONAL
- [ ] **곽근봉 원지랩스** - AI는 HR이다, AX=HR #AI {{https://www.notion.so/1ecba9422534802db3abee069d7f2f9e}}
- [ ] **덕코프 스팀페이지 운영 조사** - 빌리빌리 산하 팀소다 벤치마크 #VD {{https://www.notion.so/2f0ba942253480cdb87cf1a3f87f93e1}}

## STEAM TODO (Notion)
- [ ] **출시전략 정하기** - 6월 넥페 확정, 2~5월 PR+스트리머 위시 확보, 디스코드 플레이테스트 #VD {{https://www.notion.so/2fdba942253480bb89c2f3ee31326d47}}
  - [ ] 세이브 데이터 이전/보상 정책 결정
  - [ ] 플레이테스트 빈도/콘텐츠 계획
  - [ ] Early Access 여부 최종 결정
- [ ] **지표툴 팔로업** - 게임애널리틱스 트래킹 구조 변경, 튜토리얼 퍼널 #VD #CQ {{https://www.notion.so/2e7ba942253480dab259d60f0848b998}}
- [ ] **데모 버전 2 제안** - To 개발팀 #VD {{https://www.notion.so/2f4ba9422534801c8592de1b2943c310}}
- [ ] **스케일 업 단계 고민** - 개발 10%, Demo1 완료 후 방향 #VD {{https://www.notion.so/2fbba94225348048aaeadb798ed34a14}}
- [ ] **유명 게임 대표 레퍼런스 부탁** - 림버스, 펍지, 데더다, 타파스, 마녀의샘 #VD #BIZ

## SecondBrain TODO (Notion)
- [ ] **퍼블리셔 확정** - 명료화: 일정 (3/12) #BIZ [[schedule]] {{https://www.notion.so/1a5ba942-2534-81a2-9a27-c12a1da11faf}}
- [ ] **변호사들한테 30일에** - 명료화: 다음행동 #BIZ [[asap]] {{https://www.notion.so/1a5ba942-2534-81ed-9ba3-d8adb3327a78}}
- [ ] **온보딩** - 명료화 미지정 {{https://www.notion.so/1a5ba942-2534-81c9-ae3e-d8c72eba0e3e}}
- [ ] **샤론 등록** - 명료화 미지정 {{https://www.notion.so/1a5ba942-2534-8152-9370-c99b9b39a4b2}}
- [ ] **빌드업 해보기 >> 중헌** - 명료화: 위임 #VD {{https://www.notion.so/1a5ba942-2534-8103-b3e1-c1e68f24ddf1}}
- [ ] **네오위즈 콘택** - 명료화 미지정 #BIZ {{https://www.notion.so/1a5ba942-2534-81c7-a4b8-e24f3bec9a44}}
- [ ] **연말정산 마감** - 명료화: 일정 (1/21) #PERSONAL [[schedule]] {{https://www.notion.so/1a5ba942-2534-8185-a7c3-c6e2eaeb14b2}}
- [ ] **다흥님 납치** - 명료화: 일정 (1/6) #BIZ [[schedule]] {{https://www.notion.so/1a5ba942-2534-8183-b4f4-cb33e9e75d99}}
- [ ] **제안서 작성** - 명료화: 일정 (2/28) #BIZ [[schedule]] {{https://www.notion.so/1a5ba942-2534-81a3-95e7-db78e06b498d}}
- [ ] **기존 포폴 검토** - 명료화 미지정 {{https://www.notion.so/1a5ba942-2534-81f5-8d78-f25acd5c2f2b}}
- [ ] **정기 회의 만들기** - 명료화: 일정 (1/8) #TEAM [[schedule]] {{https://www.notion.so/1a5ba942-2534-81d7-bf19-f2b80e1b8af0}}
- [ ] **주간,월간회의 조정** - 명료화: 일정 #TEAM [[schedule]] {{https://www.notion.so/1a5ba942-2534-8161-926e-f3e98ce28aa4}}
- [ ] **호영미팅잡기** - 명료화: 일정 (1/21) #VD [[schedule]] {{https://www.notion.so/1a5ba942-2534-81c5-8a0c-e49ef208e0c4}}
- [ ] **디볼버 피치 준비** - 명료화: Maybe #VD [[maybe]] {{https://www.notion.so/1a5ba942-2534-81db-b04d-c64e66b61d85}}
- [ ] **지표들 확인** - 명료화 미지정 #VD {{https://www.notion.so/1a5ba942-2534-810c-8da6-c11b7e3e7ad1}}
- [ ] **수정 지표 요청 대응** - 명료화 미지정 #BIZ {{https://www.notion.so/1a5ba942-2534-810e-9a0b-eaaab5e9adf6}}
- [ ] **기획자들 역할확인 & 면담** - 명료화: 일정 (1/8) #TEAM [[schedule]] {{https://www.notion.so/1a5ba942-2534-81a1-b3f1-e58ceea1113b}}
- [ ] **ai 공부하자 n8n부터!** - 명료화: 일정 #AI [[schedule]] {{https://www.notion.so/1a5ba942-2534-817a-a8e2-d1fefc97f6e2}}
- [ ] **피드백 폼 호영 전달** - 명료화 미지정 #VD {{https://www.notion.so/1a5ba942-2534-8180-9e8e-e2ec2e0f6f89}}
- [ ] **ai de 요청** - 명료화 미지정 #AI {{https://www.notion.so/1a5ba942-2534-816c-8aff-ed4f61e63dc3}}
- [ ] **게임 소개 자료 만들기 보이드 다이버** - 명료화 미지정 #VD {{https://www.notion.so/1a5ba942-2534-8117-816c-ea2e8b67f7b1}}
- [x] **리뷰어500확보** {{https://www.notion.so/1a5ba942-2534-8130-8917-cc4b1fa8bbc3}}
- [x] **후원** {{https://www.notion.so/1a5ba942-2534-81db-a80a-c2d8e4e06f3e}}
- [x] **TGS신청** {{https://www.notion.so/1a5ba942-2534-81cd-a178-e3a2f3be4840}}
- [x] **클로드코워크** {{https://www.notion.so/1a5ba942-2534-81ab-b8f8-d94e67e7a1d5}}
- [x] **습관화** {{https://www.notion.so/1a5ba942-2534-81aa-b43a-e93f24b8d2f8}}
- [x] **계획서** {{https://www.notion.so/1a5ba942-2534-8122-9f96-c3217e0b7e50}}
- [x] **VD이름확정** {{https://www.notion.so/1a5ba942-2534-819d-ab2e-c2f0a2d6fc54}}
- [x] **포지션확인** {{https://www.notion.so/1a5ba942-2534-8184-a4c1-f7e8b01e97e3}}
- [x] **진성님고민** {{https://www.notion.so/1a5ba942-2534-8154-a43b-c4bce32b52f1}}

## Done
- [x] **커밍아웃 - 퍼블리셔 명 교체** - 완료 (2/23), 스팀 내 공지 후 이름 교체 #VD {{https://www.notion.so/305ba9422534802486c7cc52bc33e86b}}
- [x] **2026 행사 정리** - 아카이브드, INDIE Live Expo 지원완료, 플레이엑스포 신청중, 게임스컴 전시신청 #VD {{https://www.notion.so/2feba942253480e9aa95c4d13ce73f20}}
`;

      const result = parseTaskMarkdown(embeddedContent);
      sections = result.sections;
      tasks = result.tasks;
      taskFileName = 'TASKS.md (임베드)';
      filePathEl.textContent = '3개월 종합 — Slack · NotePlan · Notion (+ SecondBrain TODO)';
      saveToLocalStorage();
      switchTaskView('tags');

      // === AUTO-LOAD MEMORY ===
      const claudeMdContent = `# Memory

## Me
정현 (Junction), CD (Creative Director) at 로드컴플릿 (LoadComplete). 게임 개발사. 스팀/모바일 게임.

## People
| Who | Role |
|-----|------|
| **수정 (soo)** | 배수정, CEO |
| **호영** | 백호영, 핵심 리더 (해외행사, 판단 등) |
| **최고 (go2)** | CQ-TOWN 담당 |
| **영규** | 아트 관련, GDC 3/16, 커뮤니티 |
| **찬솔** | CQ Town 경제/매출 담당 |
| **형기 (hyungkee)** | HR/Chief 관련 |
| **성은 (seongeun)** | 경영지원실, 월별현황보고 |
| **진평 (jinpyoung)** | F1팀, 일정관리툴 제작 |
| **현진2 (hyeonjin2)** | UX 분석 담당 |
| **해찬 (haechan)** | 개발 (ClaudeCode, 도구 추천) |
| **건희 (geonhui)** | 개발 (코어 메카닉 검증 아이디어) |
| **상훈2 (sanghoon2)** | 사업/소재 제작 담당 |
| **경묵 (kyeongmook)** | AI assist |
| **다은 (daeun)** | Void Diver 팀 |
| **차상훈** | 외부, CQ 관련 인물 |
| **경재** | 크퀘/AI 관련 논의 상대 |
| **강안, 임형준** | 부자형들 - 외부 콘택 |

## Terms
| Term | Meaning |
|------|---------|
| CQ | 크퀘 (ConquestQuest?) - 주력 게임 IP |
| CQ Town | CQ 기반 타운 빌딩 게임, 26.03 출시 목표 |
| DE | 다른 게임 프로젝트 (피봇 논의중) |
| 넥페 | Steam Next Fest |
| 그린라이트 | 프로젝트 승인/Go 결정 |
| Void Diver | 신작 스팀 게임 (데모 성과 우수) |
| 로컴 | 로드컴플릿 (회사 약칭) |
| 네모 (NEMO) | 사내 조직/팀명 |
| 픽트 | 관련 회사/조직 (IR, 투자유치) |
| MM트래킹 | 매출/마케팅 트래킹 |
| 시드 | Seed stage 프로젝트 |
| mema | 메마 - 프로젝트 시드 채널 |
| AI TF | AI 태스크포스 |
| 미니테일즈 | 게임 프로젝트 |
| 레오슬 | 게임 프로젝트 |
| 가오 | 가디스오더 (게임) |
| HQ TF | 본사 태스크포스 |
| 바이위클리 | 격주 리더 미팅 |

## Projects
| Name | What |
|------|------|
| **Void Diver** | 스팀 신작. 데모 1주 위시20K, 리뷰90%+. 현재 최우선 프로젝트 |
| **CQ Town** | CQ IP 타운빌딩. 26.03 출시. 연출/폴리싱 단계 |
| **CQ Rebirth/Reverse** | CQ IP 리부트 구상 (스팀 or 모바일 미결정) |
| **미니테일즈** | 모바일 게임. 소재 91개/년 |
| **레오슬** | 모바일 게임. 소재 132개/년 |
| **DE** | 게임 프로젝트 (피봇/인원 이슈) |

## Preferences
- 한국어로 대화
- 짧고 직관적인 메모 스타일
- 통합 관리/인포그래픽 선호
- AI 활용에 적극적 (Claude, n8n, 에이전트)
`;

      memoryData = { claudeMd: { content: claudeMdContent, fileHandle: null }, memoryFiles: [], memoryDirs: {} };
      memoryEmptyState.style.display = 'none';
      memoryMainContent.style.display = 'flex';
      renderMemory();
    })();

    // ============================================================
    // ===== QUICK ADD TASK (Global) =====
    // ============================================================

    const QUICK_ADD_GLOSSARY = {
      tags: {
        'AI': ['ai', 'AI', '인공지능'],
        'VD': ['vd', 'VD', 'void', 'voiddiver', '보이드'],
        'CQ': ['cq', 'CQ'],
        'BIZ': ['biz', 'BIZ', '비즈', '사업', '비즈니스'],
        'TEAM': ['team', 'TEAM', '팀'],
        'PERSONAL': ['personal', 'PERSONAL', '개인'],
      },
      buckets: {
        'asap': ['급해', '급함', '긴급', '중요', 'urgent', 'asap', 'ASAP', '지금'],
        'schedule': ['예정', '계획', 'schedule', '스케줄', '일정'],
        'someday': ['언젠가', 'someday', '나중에'],
        'maybe': ['아마', 'maybe', '고민', '검토'],
      },
      dates: {
        'today': ['오늘', 'today'],
        'tomorrow': ['내일', 'tomorrow'],
      }
    };

    const qaPanel = document.getElementById('quickAddPanel');
    const qaOverlay = document.getElementById('quickAddOverlay');
    const qaTextarea = document.getElementById('quickAddText');
    const qaPreview = document.getElementById('quickAddPreview');
    const qaSubmitBtn = document.getElementById('quickAddSubmitBtn');
    const qaCancelBtn = document.getElementById('quickAddCancelBtn');
    const qaCloseBtn = document.getElementById('quickAddClose');
    const qaSuccessMsg = document.getElementById('quickAddSuccessMsg');
    const qaTagBtns = document.getElementById('quickAddTagBtns');
    const qaBucketBtns = document.getElementById('quickAddBucketBtns');
    const qaDateBtns = document.getElementById('quickAddDateBtns');

    let qaParsed = { title: '', tags: [], bucket: null, date: null };
    let qaManualTags = new Set();
    let qaManualBucket = null;
    let qaManualDate = null;
    let qaStarred = false;
    const qaStarBtn = document.getElementById('quickAddStar');

    qaStarBtn.addEventListener('click', () => {
      qaStarred = !qaStarred;
      qaStarBtn.classList.toggle('starred', qaStarred);
      qaStarBtn.innerHTML = qaStarred ? '★' : '☆';
    });

    // --- Parse engine ---
    function parseQuickAddText(text) {
      let tags = [];
      let bucket = null;
      let date = null;
      let remaining = text;

      // Step 1: Extract explicit syntax (#tag, !bucket, @date)
      // Tags: #AI, #VD etc.
      remaining = remaining.replace(/#(\S+)/g, (match, token) => {
        const upper = token.toUpperCase();
        for (const [tag, aliases] of Object.entries(QUICK_ADD_GLOSSARY.tags)) {
          if (tag === upper || aliases.some(a => a.toLowerCase() === token.toLowerCase())) {
            if (!tags.includes(tag)) tags.push(tag);
            return '';
          }
        }
        return match; // keep if not recognized
      });

      // Buckets: !asap, !schedule etc.
      remaining = remaining.replace(/!(\S+)/g, (match, token) => {
        for (const [bkt, aliases] of Object.entries(QUICK_ADD_GLOSSARY.buckets)) {
          if (bkt === token.toLowerCase() || aliases.some(a => a.toLowerCase() === token.toLowerCase())) {
            bucket = bkt;
            return '';
          }
        }
        return match;
      });

      // Dates: @today, @tomorrow
      remaining = remaining.replace(/@(\S+)/g, (match, token) => {
        for (const [dt, aliases] of Object.entries(QUICK_ADD_GLOSSARY.dates)) {
          if (dt === token.toLowerCase() || aliases.some(a => a.toLowerCase() === token.toLowerCase())) {
            date = dt;
            return '';
          }
        }
        return match;
      });

      // Step 2: Glossary matching on remaining text (scan from end)
      const words = remaining.trim().split(/\s+/).filter(Boolean);
      const consumed = new Set();

      // Scan from end for better accuracy (modifiers tend to be at the end)
      for (let i = words.length - 1; i >= 0; i--) {
        const w = words[i];
        const wLower = w.toLowerCase();

        // Match tags
        if (!tags.length || tags.length < 3) {
          for (const [tag, aliases] of Object.entries(QUICK_ADD_GLOSSARY.tags)) {
            if (aliases.some(a => a.toLowerCase() === wLower) && !tags.includes(tag)) {
              tags.push(tag);
              consumed.add(i);
              break;
            }
          }
        }

        // Match buckets
        if (!bucket && !consumed.has(i)) {
          for (const [bkt, aliases] of Object.entries(QUICK_ADD_GLOSSARY.buckets)) {
            if (aliases.some(a => a.toLowerCase() === wLower)) {
              bucket = bkt;
              consumed.add(i);
              break;
            }
          }
        }

        // Match dates
        if (!date && !consumed.has(i)) {
          for (const [dt, aliases] of Object.entries(QUICK_ADD_GLOSSARY.dates)) {
            if (aliases.some(a => a.toLowerCase() === wLower)) {
              date = dt;
              consumed.add(i);
              break;
            }
          }
        }
      }

      // Step 3: remaining words = title
      const titleWords = words.filter((_, i) => !consumed.has(i));
      const title = titleWords.join(' ').replace(/\s+/g, ' ').trim();

      return { title, tags, bucket, date };
    }

    function resolveDate(dateKey) {
      const today = new Date();
      if (dateKey === 'today') return formatDateStr(today);
      if (dateKey === 'tomorrow') {
        const tmr = new Date(today);
        tmr.setDate(tmr.getDate() + 1);
        return formatDateStr(tmr);
      }
      return null;
    }

    // --- Merge parsed + manual selections ---
    function getMergedResult() {
      const merged = {
        title: qaParsed.title,
        tags: [...new Set([...qaParsed.tags, ...qaManualTags])],
        bucket: qaManualBucket || qaParsed.bucket,
        date: qaManualDate || qaParsed.date,
      };
      return merged;
    }

    // --- Render preview ---
    function renderQAPreview() {
      const m = getMergedResult();
      qaSubmitBtn.disabled = !m.title;

      if (!m.title && !m.tags.length && !m.bucket && !m.date) {
        qaPreview.innerHTML = '<div class="quick-add-preview-empty">텍스트를 입력하면 자동으로 파싱됩니다</div>';
        return;
      }

      let html = '';

      // Title
      if (m.title) {
        html += `<div class="quick-add-preview-row"><span class="label">제목</span><span class="value">${escapeHtml(m.title)}</span></div>`;
      }

      // Tags
      if (m.tags.length > 0) {
        const chips = m.tags.map(tag => {
          const tc = tagColors[tag] || { bg: '#F3F4F6', color: '#6B7280', label: tag };
          return `<span class="quick-add-chip" style="background:${tc.bg};color:${tc.color};" data-remove-tag="${tag}">${tc.label}<span class="chip-remove">&times;</span></span>`;
        }).join('');
        html += `<div class="quick-add-preview-row"><span class="label">태그</span><div class="quick-add-preview-chips">${chips}</div></div>`;
      }

      // Bucket
      if (m.bucket) {
        const bucketLabels = { asap: '⚡ ASAP', schedule: '📋 Schedule', someday: '💭 Someday', maybe: '🤔 Maybe' };
        html += `<div class="quick-add-preview-row"><span class="label">버킷</span><span class="quick-add-chip" style="background:var(--bg-card);border:1px solid var(--border);" data-remove-bucket="1">${bucketLabels[m.bucket] || m.bucket}<span class="chip-remove">&times;</span></span></div>`;
      }

      // Date
      if (m.date) {
        const dateLabels = { today: '📅 오늘', tomorrow: '📅 내일' };
        html += `<div class="quick-add-preview-row"><span class="label">날짜</span><span class="quick-add-chip" style="background:var(--bg-card);border:1px solid var(--border);" data-remove-date="1">${dateLabels[m.date] || m.date}<span class="chip-remove">&times;</span></span></div>`;
      }

      qaPreview.innerHTML = html;

      // Chip remove handlers
      qaPreview.querySelectorAll('[data-remove-tag]').forEach(el => {
        el.addEventListener('click', () => {
          const tag = el.dataset.removeTag;
          qaManualTags.delete(tag);
          // Remove from parsed too
          qaParsed.tags = qaParsed.tags.filter(t => t !== tag);
          renderQAPreview();
          renderManualBtns();
        });
      });
      qaPreview.querySelectorAll('[data-remove-bucket]').forEach(el => {
        el.addEventListener('click', () => {
          qaManualBucket = null;
          qaParsed.bucket = null;
          renderQAPreview();
          renderManualBtns();
        });
      });
      qaPreview.querySelectorAll('[data-remove-date]').forEach(el => {
        el.addEventListener('click', () => {
          qaManualDate = null;
          qaParsed.date = null;
          renderQAPreview();
          renderManualBtns();
        });
      });
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML;
    }

    // --- Manual selection buttons ---
    function renderManualBtns() {
      const m = getMergedResult();

      // Tags
      qaTagBtns.innerHTML = Object.entries(tagColors).map(([tag, tc]) => {
        const selected = m.tags.includes(tag) ? ' selected' : '';
        return `<button class="quick-add-manual-btn${selected}" data-qa-tag="${tag}" style="${selected ? `background:${tc.bg};color:${tc.color};border-color:${tc.color};` : ''}">${tc.label}</button>`;
      }).join('');

      // Buckets
      const bucketList = { asap: '⚡ ASAP', schedule: '📋 Schedule', someday: '💭 Someday', maybe: '🤔 Maybe' };
      qaBucketBtns.innerHTML = Object.entries(bucketList).map(([bkt, label]) => {
        const selected = m.bucket === bkt ? ' selected' : '';
        return `<button class="quick-add-manual-btn${selected}" data-qa-bucket="${bkt}">${label}</button>`;
      }).join('');

      // Dates
      const dateList = { today: '오늘', tomorrow: '내일' };
      qaDateBtns.innerHTML = Object.entries(dateList).map(([dt, label]) => {
        const selected = m.date === dt ? ' selected' : '';
        return `<button class="quick-add-manual-btn${selected}" data-qa-date="${dt}">${label}</button>`;
      }).join('');

      // Event listeners
      qaTagBtns.querySelectorAll('[data-qa-tag]').forEach(btn => {
        btn.addEventListener('click', () => {
          const tag = btn.dataset.qaTag;
          if (qaManualTags.has(tag)) {
            qaManualTags.delete(tag);
            // Also remove from parsed
            qaParsed.tags = qaParsed.tags.filter(t => t !== tag);
          } else {
            qaManualTags.add(tag);
          }
          renderQAPreview();
          renderManualBtns();
        });
      });

      qaBucketBtns.querySelectorAll('[data-qa-bucket]').forEach(btn => {
        btn.addEventListener('click', () => {
          const bkt = btn.dataset.qaBucket;
          qaManualBucket = qaManualBucket === bkt ? null : bkt;
          renderQAPreview();
          renderManualBtns();
        });
      });

      qaDateBtns.querySelectorAll('[data-qa-date]').forEach(btn => {
        btn.addEventListener('click', () => {
          const dt = btn.dataset.qaDate;
          qaManualDate = qaManualDate === dt ? null : dt;
          renderQAPreview();
          renderManualBtns();
        });
      });
    }

    // --- Panel open/close ---
    function openQuickAdd() {
      qaOverlay.classList.add('show');
      qaPanel.classList.add('show');
      resetQuickAddForm();
      renderManualBtns();
      setTimeout(() => qaTextarea.focus(), 50);
    }

    function closeQuickAdd() {
      qaPanel.classList.remove('show');
      qaOverlay.classList.remove('show');
    }

    function resetQuickAddForm() {
      qaTextarea.value = '';
      qaParsed = { title: '', tags: [], bucket: null, date: null };
      qaManualTags = new Set();
      qaManualBucket = null;
      qaManualDate = null;
      qaStarred = false;
      qaStarBtn.classList.remove('starred');
      qaStarBtn.innerHTML = '☆';
      qaSuccessMsg.innerHTML = '';
      qaSubmitBtn.disabled = true;
      renderQAPreview();
    }

    // --- Task creation ---
    function submitQuickAdd() {
      const m = getMergedResult();
      if (!m.title) return;

      // Determine target section
      const targetSectionId = quickAddSection || (sections.length > 0 ? sections[0].id : null);
      if (!targetSectionId) return;

      if (!tasks[targetSectionId]) tasks[targetSectionId] = [];

      const newTask = {
        id: Date.now() + Math.random(),
        title: m.title,
        note: '',
        checked: false,
        subtasks: [],
        section: targetSectionId,
      };

      if (m.tags.length > 0) newTask.tags = m.tags;
      if (m.bucket) newTask.planBucket = m.bucket;
      if (m.date) newTask.scheduledDate = resolveDate(m.date);
      if (qaStarred) newTask.starred = true;

      tasks[targetSectionId].unshift(newTask);
      markChanged();
      renderTasks();

      // Show success message
      qaSuccessMsg.innerHTML = `<div class="quick-add-success">✓ "${escapeHtml(m.title)}" 추가됨</div>`;
      setTimeout(() => { qaSuccessMsg.innerHTML = ''; }, 2000);

      // Reset form for continuous add
      qaTextarea.value = '';
      qaParsed = { title: '', tags: [], bucket: null, date: null };
      qaManualTags = new Set();
      qaManualBucket = null;
      qaManualDate = null;
      qaStarred = false;
      qaStarBtn.classList.remove('starred');
      qaStarBtn.innerHTML = '☆';
      qaSubmitBtn.disabled = true;
      renderQAPreview();
      renderManualBtns();
      qaTextarea.focus();
    }

    // --- Event listeners ---
    qaOverlay.addEventListener('click', closeQuickAdd);
    qaCloseBtn.addEventListener('click', closeQuickAdd);
    qaCancelBtn.addEventListener('click', closeQuickAdd);
    qaSubmitBtn.addEventListener('click', submitQuickAdd);

    qaTextarea.addEventListener('input', () => {
      qaParsed = parseQuickAddText(qaTextarea.value);
      renderQAPreview();
      renderManualBtns();
    });

    qaTextarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!qaSubmitBtn.disabled) submitQuickAdd();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        closeQuickAdd();
      }
    });

    // Global shortcut: Q (when not typing) or Cmd+Enter / Ctrl+Enter
    document.addEventListener('keydown', (e) => {
      const active = document.activeElement;
      const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable);

      // Q key shortcut (when not typing in an input)
      if (e.key === 'q' && !e.metaKey && !e.ctrlKey && !e.altKey && !isTyping) {
        e.preventDefault();
        if (qaPanel.classList.contains('show')) {
          closeQuickAdd();
        } else {
          openQuickAdd();
        }
        return;
      }

      // Cmd+Enter / Ctrl+Enter
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        const isOurTextarea = active === qaTextarea;
        if (!isOurTextarea && isTyping) return;
        e.preventDefault();
        if (qaPanel.classList.contains('show')) {
          closeQuickAdd();
        } else {
          openQuickAdd();
        }
      }
    });

    // Header + button
    document.getElementById('quickAddOpenBtn').addEventListener('click', openQuickAdd);

    console.log('[Quick Add] initialized successfully');

    // ============================================================
    // ===== FOCUS MODE =====
    // ============================================================

    function loadWeeklyNotes() {
      try {
        const saved = localStorage.getItem(LS_KEY_WEEKLY_NOTES);
        if (saved) weeklyNotes = JSON.parse(saved);
      } catch(e) { console.log('Weekly notes load error:', e); }
    }

    function saveWeeklyNotes() {
      try {
        localStorage.setItem(LS_KEY_WEEKLY_NOTES, JSON.stringify(weeklyNotes));
      } catch(e) { console.log('Weekly notes save error:', e); }
    }

    // Migrate old object-format weekly notes to string format
    function migrateWeeklyNotes() {
      const dayOrder = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const dayLabels = { sun: 'Sun', mon: 'Mon', tue: 'Tue', wed: 'Wed', thu: 'Thu', fri: 'Fri', sat: 'Sat' };
      let changed = false;
      Object.keys(weeklyNotes).forEach(key => {
        const val = weeklyNotes[key];
        if (val && typeof val === 'object' && !Array.isArray(val)) {
          const lines = [];
          dayOrder.forEach(d => {
            lines.push(`## ${dayLabels[d]}`);
            if (val[d]) lines.push(val[d]);
            lines.push('');
          });
          weeklyNotes[key] = lines.join('\n');
          changed = true;
        }
      });
      if (changed) saveWeeklyNotes();
    }

    function generateWeeklyTemplate(days) {
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const lines = [];
      days.forEach((d, i) => {
        lines.push(`## ${dayNames[i]} (${d.getMonth()+1}/${d.getDate()})`);
        lines.push('');
        if (i < days.length - 1) lines.push('');
      });
      return lines.join('\n');
    }

    function getWeekKey(offset) {
      const days = getWeekDays(offset);
      const d = days[1]; // Monday
      const year = d.getFullYear();
      const jan1 = new Date(year, 0, 1);
      const dayOfYear = Math.floor((d - jan1) / 86400000) + 1;
      const weekNum = Math.ceil((dayOfYear + jan1.getDay()) / 7);
      return `${year}-W${String(weekNum).padStart(2,'0')}`;
    }

    // Simple markdown → HTML renderer
    function renderMarkdown(md) {
      let html = '';
      const lines = md.split('\n');
      let inCodeBlock = false;
      let codeContent = '';
      let inList = false;
      let listType = 'ul';

      function closeList() {
        if (inList) { html += `</${listType}>`; inList = false; }
      }

      function inline(text) {
        return text
          .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
          .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;border-radius:4px;">')
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.+?)__/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/_(.+?)_/g, '<em>$1</em>')
          .replace(/~~(.+?)~~/g, '<del>$1</del>');
      }

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Code block
        if (line.trimStart().startsWith('```')) {
          if (inCodeBlock) {
            html += `<pre><code>${codeContent.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
            codeContent = '';
            inCodeBlock = false;
          } else {
            closeList();
            inCodeBlock = true;
          }
          continue;
        }
        if (inCodeBlock) { codeContent += (codeContent ? '\n' : '') + line; continue; }

        // Blank line
        if (line.trim() === '') { closeList(); continue; }

        // Headings
        const hMatch = line.match(/^(#{1,3})\s+(.+)/);
        if (hMatch) {
          closeList();
          const level = hMatch[1].length;
          html += `<h${level}>${inline(hMatch[2])}</h${level}>`;
          continue;
        }

        // Horizontal rule
        if (/^(-{3,}|_{3,}|\*{3,})$/.test(line.trim())) { closeList(); html += '<hr>'; continue; }

        // Blockquote
        if (line.trimStart().startsWith('> ')) {
          closeList();
          html += `<blockquote>${inline(line.replace(/^>\s*/, ''))}</blockquote>`;
          continue;
        }

        // Task list item: - [ ] , - [x] , - [] , [] , [ ]
        const taskMatch = line.match(/^[\s]*(?:[-*]\s+)?\[([ xX]?)\]\s+(.*)/);
        if (taskMatch) {
          if (!inList) { html += '<ul>'; inList = true; listType = 'ul'; }
          const checked = /[xX]/.test(taskMatch[1]) ? ' checked disabled' : ' disabled';
          html += `<li class="md-task"><input type="checkbox"${checked}>${inline(taskMatch[2])}</li>`;
          continue;
        }

        // Unordered list
        const ulMatch = line.match(/^[\s]*[-*+]\s+(.*)/);
        if (ulMatch) {
          if (!inList || listType !== 'ul') { closeList(); html += '<ul>'; inList = true; listType = 'ul'; }
          html += `<li>${inline(ulMatch[1])}</li>`;
          continue;
        }

        // Ordered list
        const olMatch = line.match(/^[\s]*\d+[.)]\s+(.*)/);
        if (olMatch) {
          if (!inList || listType !== 'ol') { closeList(); html += '<ol>'; inList = true; listType = 'ol'; }
          html += `<li>${inline(olMatch[1])}</li>`;
          continue;
        }

        // Paragraph
        closeList();
        html += `<p>${inline(line)}</p>`;
      }
      closeList();
      if (inCodeBlock) {
        html += `<pre><code>${codeContent.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
      }
      return html;
    }


    async function renderFocusView() {
      loadWeeklyNotes();
      const focusView = document.getElementById('focusView');
      const days = getWeekDays(focusWeekOffset);
      const todayStr = dateStr(new Date());
      const selectedStr = focusSelectedDate || todayStr;

      // Fetch gcal events for this week if connected
      if (isGcalConnected()) {
        await fetchGoogleCalendarEvents(days);
      }

      // Build all tasks for counting
      const allTasks = getAllTasks();
      const tasksByDate = {};
      allTasks.forEach(t => {
        if (t.scheduledDate) {
          if (!tasksByDate[t.scheduledDate]) tasksByDate[t.scheduledDate] = [];
          tasksByDate[t.scheduledDate].push(t);
        }
      });

      // Week label
      const weekStart = days[1]; // Monday
      const weekEnd = days[5]; // Friday
      const weekLabel = `${weekStart.getMonth()+1}/${weekStart.getDate()} ~ ${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;

      // Selected day's tasks & events
      const dayTasks = (tasksByDate[selectedStr] || []).sort((a, b) => {
        if (a.starred && !b.starred) return -1;
        if (!a.starred && b.starred) return 1;
        if (a.checked && !b.checked) return 1;
        if (!a.checked && b.checked) return -1;
        return 0;
      });

      const dayEvents = gcalEvents[selectedStr] || [];
      const allDayEvents = dayEvents.filter(e => e.isAllDay);
      const timedEvents = dayEvents.filter(e => !e.isAllDay).sort((a, b) => {
        const aTime = a.start?.dateTime || '';
        const bTime = b.start?.dateTime || '';
        return aTime.localeCompare(bTime);
      });

      // Selected date display
      const selDate = new Date(selectedStr + 'T00:00:00');
      const dayNamesFull_kr = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
      const selectedLabel = `${selDate.getMonth()+1}월 ${selDate.getDate()}일 (${dayNamesFull_kr[selDate.getDay()]})`;

      // Week note key
      const weekKey = getWeekKey(focusWeekOffset);
      migrateWeeklyNotes();
      if (!weeklyNotes[weekKey] || typeof weeklyNotes[weekKey] !== 'string' || weeklyNotes[weekKey].trim() === '') {
        weeklyNotes[weekKey] = generateWeeklyTemplate(days);
        saveWeeklyNotes();
      }
      const currentNoteText = weeklyNotes[weekKey];

      focusView.innerHTML = `
        <div class="focus-left">
          <div class="focus-week-bar">
            <div class="week-nav">
              <button id="focusPrevWeek">◀</button>
              <span class="focus-week-label">${weekLabel}</span>
              <button id="focusNextWeek">▶</button>
            </div>
            <div class="focus-days">
              ${days.map((d, i) => {
                const ds = dateStr(d);
                const count = (tasksByDate[ds] || []).length;
                const isToday = ds === todayStr;
                const isSelected = ds === selectedStr;
                return `<div class="focus-day${isToday ? ' is-today' : ''}${isSelected ? ' is-selected' : ''}" data-date="${ds}">
                  <div class="focus-day-name">${dayNames[i]}</div>
                  <div class="focus-day-date">${d.getDate()}</div>
                  <div class="focus-day-dots">${count > 0 ? (count > 3 ? count : '●'.repeat(count)) : ''}</div>
                </div>`;
              }).join('')}
            </div>
          </div>

          <div class="focus-section-title">${selectedLabel} - 이벤트 <span class="count">${dayEvents.length}</span></div>
          ${allDayEvents.length > 0 ? `<div style="margin-bottom: 8px;">${allDayEvents.map(e => `<span class="focus-event-allday">${e.summary}</span> `).join('')}</div>` : ''}
          ${timedEvents.length > 0 ? `<ul class="focus-event-list">
            ${timedEvents.map(e => {
              const st = e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false}) : '';
              const en = e.end?.dateTime ? new Date(e.end.dateTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false}) : '';
              return `<li class="focus-event-item"${e.htmlLink ? ` style="cursor:pointer" data-href="${e.htmlLink}"` : ''}>
              <span class="focus-event-time">${st} - ${en}</span>
              <span class="focus-event-title">${e.summary}</span>
            </li>`;
            }).join('')}
          </ul>` : ''}
          ${dayEvents.length === 0 ? `<div class="focus-no-data">${isGcalConnected() ? '이벤트가 없습니다' : '캘린더를 연결하세요'}</div>` : ''}

          <div class="focus-section-title">${selectedLabel} - 태스크 <span class="count">${dayTasks.length}</span></div>
          ${dayTasks.length > 0 ? `<ul class="focus-task-list">
            ${dayTasks.map(t => `<li class="focus-task-item${t.checked ? ' is-checked' : ''}" data-task-id="${t.id}">
              <span class="focus-task-star${t.starred ? ' starred' : ''}" data-task-id="${t.id}">${t.starred ? '★' : '☆'}</span>
              <span class="checkbox${t.checked ? ' checked' : ''}" data-task-id="${t.id}"></span>
              <span class="focus-task-title">${t.title}</span>
              <span class="focus-task-tags">${(t.tags || []).map(tag => `<span class="tag-badge tag-${tag}" style="font-size:10px; padding:1px 6px;">${tag}</span>`).join('')}</span>
            </li>`).join('')}
          </ul>` : `<div class="focus-no-data">예정된 태스크가 없습니다</div>`}
        </div>

        <div class="focus-divider" id="focusDivider"></div>
        <div class="focus-right">
          <div class="weekly-notes-title">주간 노트</div>
          <textarea class="weekly-note-textarea" id="weeklyNoteTextarea" data-week="${weekKey}" style="display:none;">${currentNoteText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
          <div class="weekly-note-preview" id="weeklyNotePreview" data-week="${weekKey}">${renderMarkdown(currentNoteText)}</div>
        </div>
      `;

      // Event listeners
      document.getElementById('focusPrevWeek')?.addEventListener('click', () => { focusWeekOffset--; renderFocusView(); });
      document.getElementById('focusNextWeek')?.addEventListener('click', () => { focusWeekOffset++; renderFocusView(); });
      // Event click → open in Google Calendar
      focusView.querySelectorAll('.focus-event-item[data-href]').forEach(el => {
        el.addEventListener('click', () => window.open(el.dataset.href, '_blank'));
      });

      // Day click
      focusView.querySelectorAll('.focus-day').forEach(el => {
        el.addEventListener('click', () => {
          focusSelectedDate = el.dataset.date;
          renderFocusView();
        });
      });

      // Task checkbox toggle
      focusView.querySelectorAll('.focus-task-item .checkbox').forEach(cb => {
        cb.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskId = cb.dataset.taskId;
          const ref = findTaskRef(taskId);
          if (ref) { ref.checked = !ref.checked; markChanged(); renderFocusView(); }
        });
      });

      // Star toggle
      focusView.querySelectorAll('.focus-task-star').forEach(star => {
        star.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskId = star.dataset.taskId;
          const ref = findTaskRef(taskId);
          if (ref) { ref.starred = !ref.starred; markChanged(); renderFocusView(); }
        });
      });

      // Task click -> detail
      focusView.querySelectorAll('.focus-task-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.checkbox') || e.target.closest('.focus-task-star')) return;
          const taskId = item.dataset.taskId;
          openTaskDetail(taskId);
        });
      });

      // Weekly note: textarea + preview (click-to-edit, blur-to-preview)
      const noteTextarea = document.getElementById('weeklyNoteTextarea');
      const notePreview = document.getElementById('weeklyNotePreview');
      if (noteTextarea && notePreview) {
        const wk = noteTextarea.dataset.week;

        // Save on input
        noteTextarea.addEventListener('input', () => {
          weeklyNotes[wk] = noteTextarea.value;
          saveWeeklyNotes();
        });

        // Esc → blur (back to preview)
        noteTextarea.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') { noteTextarea.blur(); }
        });

        // Blur → switch back to preview
        noteTextarea.addEventListener('blur', () => {
          weeklyNotes[wk] = noteTextarea.value;
          saveWeeklyNotes();
          notePreview.innerHTML = renderMarkdown(noteTextarea.value);
          noteTextarea.style.display = 'none';
          notePreview.style.display = '';
        });

        // Click preview → switch to edit (textarea)
        notePreview.addEventListener('click', (e) => {
          // Handle checkbox click in preview
          if (e.target.matches('input[type="checkbox"]')) {
            setTimeout(() => {
              // Toggle checkbox in raw markdown
              const lines = noteTextarea.value.split('\n');
              let checkboxIdx = 0;
              const allCheckboxes = notePreview.querySelectorAll('input[type="checkbox"]');
              for (let i = 0; i < allCheckboxes.length; i++) {
                if (allCheckboxes[i] === e.target) { checkboxIdx = i; break; }
              }
              let found = 0;
              for (let i = 0; i < lines.length; i++) {
                const m = lines[i].match(/^(\s*-\s*)\[([xX ]?)\](\s.*)/);
                if (m) {
                  if (found === checkboxIdx) {
                    const wasChecked = /[xX]/.test(m[2]);
                    lines[i] = `${m[1]}[${wasChecked ? ' ' : 'x'}]${m[3]}`;
                    break;
                  }
                  found++;
                }
              }
              noteTextarea.value = lines.join('\n');
              weeklyNotes[wk] = noteTextarea.value;
              saveWeeklyNotes();
              notePreview.innerHTML = renderMarkdown(noteTextarea.value);
            }, 0);
            return;
          }

          // Find which section was clicked (by closest h2)
          const clickedH2 = e.target.closest('h2') || (() => {
            let el = e.target;
            while (el && el !== notePreview) {
              let prev = el.previousElementSibling;
              while (prev) {
                if (prev.tagName === 'H2') return prev;
                prev = prev.previousElementSibling;
              }
              el = el.parentElement;
            }
            return null;
          })();

          notePreview.style.display = 'none';
          noteTextarea.style.display = '';
          noteTextarea.focus();

          // Try to position cursor at the clicked section
          if (clickedH2) {
            const headerText = clickedH2.textContent.trim();
            const lines = noteTextarea.value.split('\n');
            let pos = 0;
            for (let i = 0; i < lines.length; i++) {
              if (lines[i].replace(/^##\s*/, '').trim().startsWith(headerText.split(' ')[0])) {
                // Move to end of this section (before next ## or end)
                let endPos = pos + lines[i].length + 1;
                for (let j = i + 1; j < lines.length; j++) {
                  if (lines[j].startsWith('## ')) break;
                  endPos += lines[j].length + 1;
                }
                noteTextarea.setSelectionRange(endPos - 1, endPos - 1);
                // Scroll to cursor position
                const lineHeight = 21; // ~13px * 1.6 line-height
                const lineNum = noteTextarea.value.substring(0, endPos).split('\n').length;
                noteTextarea.scrollTop = Math.max(0, (lineNum - 5) * lineHeight);
                return;
              }
              pos += lines[i].length + 1;
            }
          }
        });

        // Auto-enter edit mode and scroll to today's section
        const todayIdx = new Date().getDay();
        const dayNamesH = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const todayName = dayNamesH[todayIdx];
        const lines = noteTextarea.value.split('\n');
        let cursorPos = 0;
        let foundToday = false;
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('## ' + todayName)) {
            // Find end of today's section
            let endPos = cursorPos + lines[i].length + 1;
            for (let j = i + 1; j < lines.length; j++) {
              if (lines[j].startsWith('## ')) break;
              endPos += lines[j].length + 1;
            }
            // Show textarea, focus, set cursor
            notePreview.style.display = 'none';
            noteTextarea.style.display = '';
            noteTextarea.focus();
            noteTextarea.setSelectionRange(endPos - 1, endPos - 1);
            const lineHeight = 21;
            const lineNum = noteTextarea.value.substring(0, endPos).split('\n').length;
            noteTextarea.scrollTop = Math.max(0, (lineNum - 5) * lineHeight);
            foundToday = true;
            break;
          }
          cursorPos += lines[i].length + 1;
        }
        if (!foundToday) {
          // Default: show preview
          noteTextarea.style.display = 'none';
          notePreview.style.display = '';
        }
      }

      // Focus divider drag logic
      const focusDivider = document.getElementById('focusDivider');
      const focusRight = focusView.querySelector('.focus-right');
      if (focusDivider && focusRight) {
        let isFocusDragging = false;
        focusDivider.addEventListener('mousedown', (e) => {
          isFocusDragging = true;
          focusDivider.classList.add('dragging');
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';
          e.preventDefault();
        });
        document.addEventListener('mousemove', (e) => {
          if (!isFocusDragging) return;
          const rect = focusView.getBoundingClientRect();
          const rightWidth = rect.right - e.clientX;
          const clamped = Math.max(280, Math.min(rect.width * 0.7, rightWidth));
          focusRight.style.width = clamped + 'px';
        });
        document.addEventListener('mouseup', () => {
          if (isFocusDragging) {
            isFocusDragging = false;
            focusDivider.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
          }
        });
      }
    }

    // ============================================================
    // ===== COMPASS MODE =====
    // ============================================================

    const LS_KEY_COMPASS_MILESTONES = 'dashboard_compass_milestones';
    const LS_KEY_COMPASS_GOALS = 'dashboard_compass_goals';
    let compassHalfOffset = 0; // 0 = current half-year

    let compassMilestones = [
      { id: 'm1', project: 'VD', title: 'GDC 참가', date: '2025-03-16', color: '#7C3AED' },
      { id: 'm2', project: 'VD', title: '넥페 출품', date: '2025-05-10', color: '#7C3AED' },
      { id: 'm3', project: 'VD', title: '출시', date: '2025-06-30', color: '#7C3AED' },
      { id: 'm4', project: 'CQ', title: '출시', date: '2025-03-01', color: '#D97706' },
      { id: 'm5', project: 'BIZ', title: '투자 미팅', date: '2025-02-15', color: '#DC2626' },
      { id: 'm6', project: 'BIZ', title: 'IR', date: '2025-05-20', color: '#DC2626' },
      { id: 'm7', project: 'TEAM', title: '온보딩', date: '2025-02-28', color: '#059669' },
    ];

    let compassGoals = {
      categories: [
        { id: 'mastery', icon: '\uD83E\uDDE0', name: 'Mastery (장인)', goals: [
          { id: 'g1', text: 'VD 크리에이티브 디렉션 완성', checked: false },
          { id: 'g2', text: 'AI/ML 실무 역량 강화', checked: false },
          { id: 'g3', text: '레퍼런스 게임 월 2개 플레이', checked: false },
          { id: 'g4', text: '분기 3권 독서', checked: false },
        ]},
        { id: 'venture', icon: '\uD83D\uDE80', name: 'Venture (사업)', goals: [
          { id: 'g5', text: 'VD 출시 + 초기 KPI 달성', checked: false },
          { id: 'g6', text: '투자 라운드 클로징', checked: false },
          { id: 'g7', text: '핵심 인재 채용', checked: false },
        ]},
        { id: 'family', icon: '\uD83D\uDC68\u200D\uD83D\uDC69\u200D\uD83D\uDC66', name: 'Family (가족)', goals: [
          { id: 'g8', text: '주 3회 저녁 같이 먹기', checked: false },
          { id: 'g9', text: '아들과 주말 1:1 시간', checked: false },
          { id: 'g10', text: '와이프와 월 1회 데이트', checked: false },
          { id: 'g11', text: '가족 여행 계획', checked: false },
        ]},
        { id: 'body', icon: '\uD83D\uDCAA', name: 'Body (몸)', goals: [
          { id: 'g12', text: '주 3회 운동 루틴', checked: false },
          { id: 'g13', text: '수면 7시간 확보', checked: false },
          { id: 'g14', text: '건강검진', checked: false },
        ]},
        { id: 'soul', icon: '\uD83D\uDE4F', name: 'Soul (내면)', goals: [
          { id: 'g15', text: '아침 10분 명상/저널링', checked: false },
          { id: 'g16', text: '분기 1회 혼자만의 시간', checked: false },
          { id: 'g17', text: '미션 스테이트먼트 점검', checked: false },
        ]},
        { id: 'circle', icon: '\uD83E\uDD1D', name: 'Circle (관계)', goals: [
          { id: 'g18', text: '멘토/동료 founder 월 1회 만남', checked: false },
          { id: 'g19', text: '팀원 1on1 정기화', checked: false },
          { id: 'g20', text: '오래된 친구 연락', checked: false },
        ]},
      ],
      okrs: [
        { quarter: 'Q1', collapsed: false, objectives: [
          { title: 'VD 출시 준비', keyResults: [
            { id: 'kr1', text: '넥페 참가', checked: false },
            { id: 'kr2', text: '위시리스트 50K', checked: false },
          ]}
        ]},
        { quarter: 'Q2', collapsed: true, objectives: [
          { title: '성장 가속', keyResults: [
            { id: 'kr3', text: '매출 목표 달성', checked: false },
          ]}
        ]},
      ]
    };

    function loadCompassData() {
      try {
        const ms = localStorage.getItem(LS_KEY_COMPASS_MILESTONES);
        if (ms) compassMilestones = JSON.parse(ms);
        const gs = localStorage.getItem(LS_KEY_COMPASS_GOALS);
        if (gs) compassGoals = JSON.parse(gs);
      } catch(e) { console.log('Compass data load error:', e); }
    }

    function saveCompassData() {
      try {
        localStorage.setItem(LS_KEY_COMPASS_MILESTONES, JSON.stringify(compassMilestones));
        localStorage.setItem(LS_KEY_COMPASS_GOALS, JSON.stringify(compassGoals));
      } catch(e) { console.log('Compass data save error:', e); }
    }

    function renderCompassView() {
      loadCompassData();
      const compassView = document.getElementById('compassView');
      const now = new Date();
      const currentYear = now.getFullYear();

      // Determine which half-year to show
      const currentHalf = now.getMonth() < 6 ? 0 : 1;
      const displayHalf = currentHalf + compassHalfOffset;
      const displayYear = currentYear + Math.floor(displayHalf / 2);
      const halfIndex = ((displayHalf % 2) + 2) % 2; // 0 = H1, 1 = H2
      const startMonth = halfIndex * 6; // 0 or 6
      const monthLabels = [];
      for (let i = 0; i < 6; i++) {
        monthLabels.push(monthNames[startMonth + i]);
      }
      const halfLabel = `${displayYear} ${halfIndex === 0 ? 'H1' : 'H2'}`;

      // Build project lanes
      const projects = [];
      const projectSet = new Set();
      compassMilestones.forEach(m => {
        if (!projectSet.has(m.project)) {
          projectSet.add(m.project);
          projects.push(m.project);
        }
      });
      // Ensure at least some default projects
      ['VD', 'CQ', 'BIZ', 'TEAM'].forEach(p => {
        if (!projectSet.has(p)) { projectSet.add(p); projects.push(p); }
      });

      // Date range for this half
      const rangeStart = new Date(displayYear, startMonth, 1);
      const rangeEnd = new Date(displayYear, startMonth + 6, 0); // last day of last month
      const rangeDuration = rangeEnd - rangeStart;

      // Today line position
      const todayPos = rangeDuration > 0 ? Math.max(0, Math.min(100, ((now - rangeStart) / rangeDuration) * 100)) : -1;
      const showTodayLine = now >= rangeStart && now <= rangeEnd;

      // Current month index within this half
      const currentMonthInHalf = (now.getMonth() - startMonth);

      // Milestone positions
      function milestonePos(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        return Math.max(0, Math.min(100, ((d - rangeStart) / rangeDuration) * 100));
      }

      // Goals HTML
      const collapsedCats = {};
      const goalsHTML = compassGoals.categories.map(cat => {
        const isCollapsed = collapsedCats[cat.id];
        return `<div class="compass-category" data-cat-id="${cat.id}">
          <div class="compass-category-header" data-cat-id="${cat.id}">
            <span class="toggle-icon${isCollapsed ? ' collapsed' : ''}">▼</span>
            ${cat.icon} ${cat.name}
          </div>
          <div class="compass-category-goals" style="${isCollapsed ? 'display:none' : ''}">
            ${cat.goals.map(g => `<div class="compass-goal-item" data-goal-id="${g.id}" data-cat-id="${cat.id}">
              <span class="checkbox${g.checked ? ' checked' : ''}" data-goal-id="${g.id}" data-cat-id="${cat.id}"></span>
              <input class="compass-goal-text" value="${g.text.replace(/"/g, '&quot;')}" data-goal-id="${g.id}" data-cat-id="${cat.id}">
            </div>`).join('')}
            <div class="compass-add-goal">
              <button data-cat-id="${cat.id}">+ 목표 추가</button>
            </div>
          </div>
        </div>`;
      }).join('');

      // OKR HTML
      const okrsHTML = compassGoals.okrs.map((okr, oi) => {
        return `<div class="compass-okr-section">
          <div class="compass-okr-header" data-okr-idx="${oi}">
            <span class="toggle-icon${okr.collapsed ? ' collapsed' : ''}">▼</span>
            ${okr.quarter} OKR
          </div>
          <div class="compass-okr-body" style="${okr.collapsed ? 'display:none' : ''}">
            ${okr.objectives.map((obj, objI) => `<div class="compass-okr-objective">
              <div class="compass-okr-objective-title">O: ${obj.title}</div>
              ${obj.keyResults.map(kr => `<div class="compass-okr-kr">
                <span class="checkbox${kr.checked ? ' checked' : ''}" data-kr-id="${kr.id}" data-okr-idx="${oi}" data-obj-idx="${objI}"></span>
                <input value="${kr.text.replace(/"/g, '&quot;')}" data-kr-id="${kr.id}" data-okr-idx="${oi}" data-obj-idx="${objI}">
              </div>`).join('')}
            </div>`).join('')}
          </div>
        </div>`;
      }).join('');

      compassView.innerHTML = `
        <div class="compass-left">
          <div class="compass-header">
            <button id="compassPrevHalf">◀</button>
            <h2>${halfLabel} 로드맵</h2>
            <button id="compassNextHalf">▶</button>
          </div>
          <div class="compass-timeline">
            <div class="compass-months">
              ${monthLabels.map((m, i) => `<div class="compass-month${i === currentMonthInHalf && showTodayLine ? ' is-current' : ''}">${m}</div>`).join('')}
            </div>
            ${projects.map(proj => {
              const projMilestones = compassMilestones.filter(m => m.project === proj);
              const projColor = projMilestones[0]?.color || '#888';
              return `<div class="compass-lane">
                <div class="compass-lane-label">${proj}</div>
                <div class="compass-lane-track">
                  ${showTodayLine ? `<div class="compass-today-line" style="left: ${todayPos}%"></div>` : ''}
                  ${projMilestones.map(m => {
                    const mDate = new Date(m.date + 'T00:00:00');
                    const inRange = mDate >= rangeStart && mDate <= rangeEnd;
                    if (!inRange) return '';
                    const pos = milestonePos(m.date);
                    return `<div class="compass-milestone" style="left: ${pos}%; background: ${m.color || projColor};" data-milestone-id="${m.id}" title="${m.title} (${m.date})">
                      <span class="compass-milestone-label">${m.title}</span>
                    </div>`;
                  }).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
          <div class="compass-add-milestone">
            <button id="compassAddMilestone">+ 마일스톤 추가</button>
          </div>
        </div>

        <div class="compass-right">
          <div class="compass-goals-title">${displayYear}년 목표</div>
          ${goalsHTML}
          ${okrsHTML}
        </div>
      `;

      // Event listeners
      document.getElementById('compassPrevHalf')?.addEventListener('click', () => { compassHalfOffset--; renderCompassView(); });
      document.getElementById('compassNextHalf')?.addEventListener('click', () => { compassHalfOffset++; renderCompassView(); });

      // Add milestone
      document.getElementById('compassAddMilestone')?.addEventListener('click', () => {
        showMilestoneEditModal(null);
      });

      // Milestone click -> edit
      compassView.querySelectorAll('.compass-milestone').forEach(el => {
        el.addEventListener('click', () => {
          showMilestoneEditModal(el.dataset.milestoneId);
        });
      });

      // Category toggle
      compassView.querySelectorAll('.compass-category-header').forEach(hdr => {
        hdr.addEventListener('click', () => {
          const goalsDiv = hdr.nextElementSibling;
          const icon = hdr.querySelector('.toggle-icon');
          if (goalsDiv.style.display === 'none') {
            goalsDiv.style.display = '';
            icon.classList.remove('collapsed');
          } else {
            goalsDiv.style.display = 'none';
            icon.classList.add('collapsed');
          }
        });
      });

      // OKR toggle
      compassView.querySelectorAll('.compass-okr-header').forEach(hdr => {
        hdr.addEventListener('click', () => {
          const idx = parseInt(hdr.dataset.okrIdx);
          compassGoals.okrs[idx].collapsed = !compassGoals.okrs[idx].collapsed;
          saveCompassData();
          renderCompassView();
        });
      });

      // Goal checkbox
      compassView.querySelectorAll('.compass-goal-item .checkbox').forEach(cb => {
        cb.addEventListener('click', () => {
          const catId = cb.dataset.catId;
          const goalId = cb.dataset.goalId;
          const cat = compassGoals.categories.find(c => c.id === catId);
          if (cat) {
            const goal = cat.goals.find(g => g.id === goalId);
            if (goal) { goal.checked = !goal.checked; saveCompassData(); renderCompassView(); }
          }
        });
      });

      // Goal text edit
      compassView.querySelectorAll('.compass-goal-text').forEach(input => {
        input.addEventListener('change', () => {
          const catId = input.dataset.catId;
          const goalId = input.dataset.goalId;
          const cat = compassGoals.categories.find(c => c.id === catId);
          if (cat) {
            const goal = cat.goals.find(g => g.id === goalId);
            if (goal) { goal.text = input.value; saveCompassData(); }
          }
        });
      });

      // Add goal
      compassView.querySelectorAll('.compass-add-goal button').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.dataset.catId;
          const cat = compassGoals.categories.find(c => c.id === catId);
          if (cat) {
            cat.goals.push({ id: 'g' + Date.now(), text: '새 목표', checked: false });
            saveCompassData();
            renderCompassView();
          }
        });
      });

      // KR checkbox
      compassView.querySelectorAll('.compass-okr-kr .checkbox').forEach(cb => {
        cb.addEventListener('click', () => {
          const okrIdx = parseInt(cb.dataset.okrIdx);
          const objIdx = parseInt(cb.dataset.objIdx);
          const krId = cb.dataset.krId;
          const obj = compassGoals.okrs[okrIdx]?.objectives[objIdx];
          if (obj) {
            const kr = obj.keyResults.find(k => k.id === krId);
            if (kr) { kr.checked = !kr.checked; saveCompassData(); renderCompassView(); }
          }
        });
      });

      // KR text edit
      compassView.querySelectorAll('.compass-okr-kr input').forEach(input => {
        input.addEventListener('change', () => {
          const okrIdx = parseInt(input.dataset.okrIdx);
          const objIdx = parseInt(input.dataset.objIdx);
          const krId = input.dataset.krId;
          const obj = compassGoals.okrs[okrIdx]?.objectives[objIdx];
          if (obj) {
            const kr = obj.keyResults.find(k => k.id === krId);
            if (kr) { kr.text = input.value; saveCompassData(); }
          }
        });
      });
    }

    function showMilestoneEditModal(milestoneId) {
      const existing = milestoneId ? compassMilestones.find(m => m.id === milestoneId) : null;

      const overlay = document.createElement('div');
      overlay.className = 'compass-edit-overlay';

      const projectOptions = ['VD', 'CQ', 'AI', 'BIZ', 'TEAM', 'PERSONAL'];
      const colorOptions = [
        { label: 'Purple', value: '#7C3AED' },
        { label: 'Orange', value: '#D97706' },
        { label: 'Blue', value: '#2563EB' },
        { label: 'Red', value: '#DC2626' },
        { label: 'Green', value: '#059669' },
        { label: 'Gray', value: '#6B7280' },
      ];

      const modal = document.createElement('div');
      modal.className = 'compass-edit-modal';
      modal.innerHTML = `
        <h3>${existing ? '마일스톤 편집' : '새 마일스톤'}</h3>
        <label>프로젝트</label>
        <select id="msEditProject">
          ${projectOptions.map(p => `<option value="${p}"${existing?.project === p ? ' selected' : ''}>${p}</option>`).join('')}
        </select>
        <label>제목</label>
        <input id="msEditTitle" value="${existing ? existing.title.replace(/"/g, '&quot;') : ''}" placeholder="마일스톤 제목">
        <label>날짜</label>
        <input type="date" id="msEditDate" value="${existing?.date || dateStr(new Date())}">
        <label>색상</label>
        <select id="msEditColor">
          ${colorOptions.map(c => `<option value="${c.value}"${existing?.color === c.value ? ' selected' : ''} style="color:${c.value}">${c.label}</option>`).join('')}
        </select>
        <div class="modal-actions">
          ${existing ? '<button id="msEditDelete" style="margin-right:auto; color:#DC2626; border-color:#DC2626;">삭제</button>' : ''}
          <button id="msEditCancel">취소</button>
          <button id="msEditSave" class="primary">저장</button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(modal);

      overlay.addEventListener('click', () => { overlay.remove(); modal.remove(); });
      document.getElementById('msEditCancel').addEventListener('click', () => { overlay.remove(); modal.remove(); });

      document.getElementById('msEditSave').addEventListener('click', () => {
        const project = document.getElementById('msEditProject').value;
        const title = document.getElementById('msEditTitle').value.trim();
        const date = document.getElementById('msEditDate').value;
        const color = document.getElementById('msEditColor').value;
        if (!title) return;

        if (existing) {
          existing.project = project;
          existing.title = title;
          existing.date = date;
          existing.color = color;
        } else {
          compassMilestones.push({ id: 'm' + Date.now(), project, title, date, color });
        }
        saveCompassData();
        overlay.remove();
        modal.remove();
        renderCompassView();
      });

      if (existing) {
        document.getElementById('msEditDelete').addEventListener('click', () => {
          compassMilestones = compassMilestones.filter(m => m.id !== milestoneId);
          saveCompassData();
          overlay.remove();
          modal.remove();
          renderCompassView();
        });
      }
    }

    // Load compass data on startup
    loadCompassData();
    loadWeeklyNotes();

    // ============================================================
    // ===== ROUTINE & HABIT NOTIFICATIONS =====
    // ============================================================

    const LS_KEY_ROUTINES = 'dashboard_routines';
    const LS_KEY_ROUTINE_FIRED = 'dashboard_routine_fired';
    const LS_KEY_REVIEW = 'dashboard_review';

    const DEFAULT_ROUTINES = [
      { id: 'morning', emoji: '🌅', name: '아침 계획', type: 'daily', time: '09:00', tab: 'focus', enabled: true, message: '오늘의 계획을 세워볼까요?' },
      { id: 'evening', emoji: '🌆', name: '저녁 마감', type: 'daily', time: '18:00', tab: 'focus', enabled: false, message: '오늘 하루를 마무리합시다.' },
      { id: 'weekly-review', emoji: '🌙', name: '주간 회고', type: 'weekly', dayOfWeek: 0, time: '22:00', tab: 'review', enabled: false, message: '이번 주를 돌아봅시다.' },
      { id: 'goal-check', emoji: '🧭', name: '목표 점검', type: 'monthly', dayOfMonth: 1, time: '10:00', tab: 'compass', enabled: false, message: '월간 목표를 점검합시다.' },
      { id: 'inbox-cleanup', emoji: '📥', name: '수집함 정리', type: 'weekly', dayOfWeek: 5, time: '17:00', tab: 'tasks', enabled: false, message: '수집함을 정리합시다.' },
    ];

    function loadRoutines() {
      try {
        const stored = localStorage.getItem(LS_KEY_ROUTINES);
        if (stored) return JSON.parse(stored);
      } catch(e) {}
      const defaults = JSON.parse(JSON.stringify(DEFAULT_ROUTINES));
      saveRoutines(defaults);
      return defaults;
    }

    function saveRoutines(routines) {
      try { localStorage.setItem(LS_KEY_ROUTINES, JSON.stringify(routines)); } catch(e) {}
    }

    let routines = loadRoutines();

    // --- Schedule Check ---
    function getRoutineSlotKey(routine, now) {
      const dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
      return routine.id + '-' + dateStr + '-' + routine.time;
    }

    function loadFiredKeys() {
      try {
        const stored = localStorage.getItem(LS_KEY_ROUTINE_FIRED);
        return stored ? JSON.parse(stored) : {};
      } catch(e) { return {}; }
    }

    function saveFiredKey(key) {
      const fired = loadFiredKeys();
      fired[key] = Date.now();
      // Clean old entries (> 7 days)
      const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000;
      for (const k in fired) { if (fired[k] < cutoff) delete fired[k]; }
      try { localStorage.setItem(LS_KEY_ROUTINE_FIRED, JSON.stringify(fired)); } catch(e) {}
    }

    function isRoutineDue(routine, now) {
      if (!routine.enabled) return false;
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const currentTime = hh + ':' + mm;
      if (currentTime !== routine.time) return false;

      if (routine.type === 'weekly' && now.getDay() !== routine.dayOfWeek) return false;
      if (routine.type === 'monthly' && now.getDate() !== routine.dayOfMonth) return false;

      const slotKey = getRoutineSlotKey(routine, now);
      const fired = loadFiredKeys();
      return !fired[slotKey];
    }

    function checkRoutines() {
      const now = new Date();
      routines.forEach(r => {
        if (isRoutineDue(r, now)) {
          fireRoutineNotification(r);
          saveFiredKey(getRoutineSlotKey(r, now));
        }
      });
    }

    let routineInterval = null;
    function startRoutineCheck() {
      if (routineInterval) clearInterval(routineInterval);
      checkRoutines();
      routineInterval = setInterval(checkRoutines, 60000);
    }

    // --- Service Worker + Notifications ---
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          await navigator.serviceWorker.register('./sw.js');
        } catch(e) { console.log('SW registration failed:', e); }
      }
    }

    function getNotifPermission() {
      if (!('Notification' in window)) return 'unsupported';
      return Notification.permission;
    }

    async function requestNotifPermission() {
      if (!('Notification' in window)) return 'unsupported';
      const result = await Notification.requestPermission();
      if (result === 'granted') startRoutineCheck();
      return result;
    }

    async function fireRoutineNotification(routine) {
      const options = {
        body: routine.message || routine.name,
        tag: 'routine-' + routine.id,
        data: { tab: routine.tab },
        icon: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect x="4" y="2" width="24" height="28" rx="4" fill="#faf9f5" stroke="#D97757" stroke-width="2"/></svg>'),
      };
      try {
        const reg = await navigator.serviceWorker?.ready;
        if (reg) {
          await reg.showNotification(routine.emoji + ' ' + routine.name, options);
          return;
        }
      } catch(e) {}
      // Fallback
      try { new Notification(routine.emoji + ' ' + routine.name, options); } catch(e) {}
    }

    // --- SW message listener ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data?.type === 'ROUTINE_TAB_SWITCH' && event.data.tab) {
          switchMainTab(event.data.tab);
        }
      });
    }

    // --- URL hash navigation ---
    function handleHashNavigation() {
      const hash = window.location.hash;
      const match = hash.match(/tab=(\w+)/);
      if (match) {
        const tab = match[1];
        if (['tasks', 'focus', 'compass', 'memory', 'review', 'settings'].includes(tab)) {
          switchMainTab(tab);
        }
        history.replaceState(null, '', window.location.pathname);
      }
    }
    handleHashNavigation();

    // ============================================================
    // ===== REVIEW TAB =====
    // ============================================================

    let reviewWeekOffset = 0;

    function loadReviewData(weekKey) {
      try {
        const all = JSON.parse(localStorage.getItem(LS_KEY_REVIEW) || '{}');
        return all[weekKey] || {};
      } catch(e) { return {}; }
    }

    function saveReviewData(weekKey, data) {
      try {
        const all = JSON.parse(localStorage.getItem(LS_KEY_REVIEW) || '{}');
        all[weekKey] = data;
        localStorage.setItem(LS_KEY_REVIEW, JSON.stringify(all));
      } catch(e) {}
    }

    function getReviewWeekStats(weekOffset) {
      // Count completed tasks for the week
      const days = getWeekDays(weekOffset);
      let completed = 0;
      let total = 0;
      for (const section of sections) {
        const sectionTasks = tasks[section.id] || [];
        for (const t of sectionTasks) {
          total++;
          if (t.done) completed++;
        }
      }
      return { completed, total };
    }

    let reviewSaveTimers = {};

    function renderReviewView() {
      const container = document.getElementById('reviewView');
      const weekKey = getWeekKey(reviewWeekOffset);
      const days = getWeekDays(reviewWeekOffset);
      const startDate = days[0];
      const endDate = days[6];
      const fmt = (d) => (d.getMonth()+1) + '/' + d.getDate();

      const data = loadReviewData(weekKey);
      const stats = getReviewWeekStats(reviewWeekOffset);

      const prompts = [
        { key: 'good', title: '잘한 것', placeholder: '이번 주 잘한 일을 적어보세요...' },
        { key: 'hard', title: '어려웠던 점', placeholder: '어려움이나 장애물을 적어보세요...' },
        { key: 'learn', title: '배운 것', placeholder: '이번 주 배운 것을 적어보세요...' },
        { key: 'next', title: '다음 주 집중 포인트', placeholder: '다음 주 집중할 영역을 적어보세요...' },
      ];

      const energyEmojis = ['😴', '😐', '🙂', '😊', '🔥'];

      container.innerHTML = `
        <div class="review-week-nav">
          <button id="reviewPrevWeek">◀</button>
          <span class="review-week-label">${weekKey} (${fmt(startDate)} ~ ${fmt(endDate)})</span>
          <button id="reviewNextWeek">▶</button>
        </div>

        <div class="review-summary-stats">
          <div class="review-stat">
            <div class="stat-value">${stats.completed}</div>
            <div class="stat-label">완료한 태스크</div>
          </div>
          <div class="review-stat">
            <div class="stat-value">${stats.total}</div>
            <div class="stat-label">전체 태스크</div>
          </div>
          <div class="review-stat">
            <div class="stat-value">${stats.total > 0 ? Math.round(stats.completed / stats.total * 100) : 0}%</div>
            <div class="stat-label">완료율</div>
          </div>
        </div>

        <div class="review-section">
          <div class="review-section-title">에너지 레벨</div>
          <div class="review-score-row">
            ${energyEmojis.map((e, i) => `<button class="review-score-btn${(data.energy === i+1) ? ' active' : ''}" data-score="${i+1}">${e}</button>`).join('')}
          </div>
        </div>

        ${prompts.map(p => `
          <div class="review-section">
            <div class="review-section-title">${p.title}</div>
            <textarea class="review-textarea" data-key="${p.key}" placeholder="${p.placeholder}">${data[p.key] || ''}</textarea>
          </div>
        `).join('')}
      `;

      // Week navigation
      document.getElementById('reviewPrevWeek').addEventListener('click', () => { reviewWeekOffset--; renderReviewView(); });
      document.getElementById('reviewNextWeek').addEventListener('click', () => { reviewWeekOffset++; renderReviewView(); });

      // Energy score
      container.querySelectorAll('.review-score-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const score = parseInt(btn.dataset.score);
          const d = loadReviewData(weekKey);
          d.energy = score;
          saveReviewData(weekKey, d);
          container.querySelectorAll('.review-score-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.score) === score));
        });
      });

      // Textarea auto-save with debounce
      container.querySelectorAll('.review-textarea').forEach(ta => {
        ta.addEventListener('input', () => {
          const key = ta.dataset.key;
          if (reviewSaveTimers[key]) clearTimeout(reviewSaveTimers[key]);
          reviewSaveTimers[key] = setTimeout(() => {
            const d = loadReviewData(weekKey);
            d[key] = ta.value;
            saveReviewData(weekKey, d);
          }, 500);
        });
      });
    }

    // ============================================================
    // ===== SETTINGS TAB =====
    // ============================================================

    function getScheduleDescription(r) {
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      if (r.type === 'daily') return '매일 ' + r.time;
      if (r.type === 'weekly') return '매주 ' + dayNames[r.dayOfWeek] + '요일 ' + r.time;
      if (r.type === 'monthly') return '매월 ' + r.dayOfMonth + '일 ' + r.time;
      return r.time;
    }

    const TAB_LABELS = { tasks: 'Clarify & Plan', focus: 'Weekly Focus', compass: 'Compass', memory: 'Memory', review: '회고', settings: '설정' };

    function renderSettingsView() {
      const container = document.getElementById('settingsView');
      const perm = getNotifPermission();

      let bannerHtml = '';
      if (perm === 'granted') {
        bannerHtml = '<div class="notif-permission-banner granted">✅ 알림이 허용되었습니다.</div>';
      } else if (perm === 'denied') {
        bannerHtml = '<div class="notif-permission-banner denied">🚫 알림이 차단되었습니다. 브라우저 설정에서 변경해주세요.</div>';
      } else if (perm === 'unsupported') {
        bannerHtml = '<div class="notif-permission-banner denied">이 브라우저는 알림을 지원하지 않습니다.</div>';
      } else {
        bannerHtml = '<div class="notif-permission-banner default">🔔 알림을 허용하면 루틴 시간에 알림을 받을 수 있습니다. <button id="reqNotifBtn">알림 허용</button></div>';
      }

      container.innerHTML = `
        <div class="settings-section-header">알림 권한</div>
        ${bannerHtml}

        <div class="settings-section-header">루틴 관리</div>
        <div class="routine-list" id="routineList">
          ${routines.map(r => `
            <div class="routine-row" data-id="${r.id}">
              <span class="routine-emoji">${r.emoji}</span>
              <div class="routine-info">
                <div class="routine-name">${r.name}</div>
                <div class="routine-schedule">${getScheduleDescription(r)}</div>
              </div>
              <span class="routine-tab-badge">${TAB_LABELS[r.tab] || r.tab}</span>
              <label class="routine-toggle">
                <input type="checkbox" ${r.enabled ? 'checked' : ''} data-routine-id="${r.id}">
                <span class="routine-toggle-track"></span>
                <span class="routine-toggle-thumb"></span>
              </label>
              <button class="routine-edit-btn" data-routine-id="${r.id}">편집</button>
            </div>
          `).join('')}
        </div>
        <button id="addRoutineBtn" style="margin-top: 12px; width: 100%; padding: 10px; font-size: 13px; border: 1px dashed var(--border); border-radius: 10px; background: transparent; color: var(--text-muted); cursor: pointer;">+ 새 루틴 추가</button>
      `;

      // Notification permission button
      const reqBtn = document.getElementById('reqNotifBtn');
      if (reqBtn) {
        reqBtn.addEventListener('click', async () => {
          await requestNotifPermission();
          renderSettingsView();
        });
      }

      // Toggle switches
      container.querySelectorAll('.routine-toggle input').forEach(input => {
        input.addEventListener('change', () => {
          const id = input.dataset.routineId;
          const r = routines.find(x => x.id === id);
          if (r) { r.enabled = input.checked; saveRoutines(routines); }
        });
      });

      // Edit buttons
      container.querySelectorAll('.routine-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => openRoutineEditModal(btn.dataset.routineId));
      });

      // Add new routine
      document.getElementById('addRoutineBtn').addEventListener('click', () => openRoutineEditModal(null));
    }

    // ============================================================
    // ===== ROUTINE EDIT MODAL =====
    // ============================================================

    function openRoutineEditModal(routineId) {
      const existing = routineId ? routines.find(r => r.id === routineId) : null;

      const overlay = document.createElement('div');
      overlay.className = 'compass-edit-overlay';

      const modal = document.createElement('div');
      modal.className = 'compass-edit-modal';
      modal.style.minWidth = '360px';

      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const tabOptions = ['tasks', 'focus', 'compass', 'memory', 'review', 'settings'];

      modal.innerHTML = `
        <h3>${existing ? '루틴 편집' : '새 루틴'}</h3>
        <label>이모지 + 이름</label>
        <div style="display: flex; gap: 8px;">
          <input id="reEditEmoji" value="${existing ? existing.emoji : '⏰'}" style="width: 50px; text-align: center; font-size: 18px;">
          <input id="reEditName" value="${existing ? existing.name.replace(/"/g, '&quot;') : ''}" placeholder="루틴 이름" style="flex: 1;">
        </div>
        <label>반복 타입</label>
        <select id="reEditType">
          <option value="daily"${existing?.type === 'daily' ? ' selected' : ''}>매일</option>
          <option value="weekly"${existing?.type === 'weekly' ? ' selected' : ''}>매주</option>
          <option value="monthly"${existing?.type === 'monthly' ? ' selected' : ''}>매월</option>
        </select>
        <div id="reEditDayOfWeekRow" style="display: none;">
          <label>요일</label>
          <select id="reEditDayOfWeek">
            ${dayNames.map((d, i) => `<option value="${i}"${existing?.dayOfWeek === i ? ' selected' : ''}>${d}요일</option>`).join('')}
          </select>
        </div>
        <div id="reEditDayOfMonthRow" style="display: none;">
          <label>날짜</label>
          <input type="number" id="reEditDayOfMonth" min="1" max="31" value="${existing?.dayOfMonth || 1}">
        </div>
        <label>시간</label>
        <input type="time" id="reEditTime" value="${existing?.time || '09:00'}">
        <label>이동 탭</label>
        <select id="reEditTab">
          ${tabOptions.map(t => `<option value="${t}"${existing?.tab === t ? ' selected' : ''}>${TAB_LABELS[t] || t}</option>`).join('')}
        </select>
        <label>알림 문구</label>
        <input id="reEditMessage" value="${existing?.message?.replace(/"/g, '&quot;') || ''}" placeholder="알림에 표시될 문구">
        <div class="modal-actions">
          ${existing ? '<button id="reEditDelete" style="margin-right:auto; color:#DC2626; border-color:#DC2626;">삭제</button>' : ''}
          <button id="reEditCancel">취소</button>
          <button id="reEditSave" class="primary">저장</button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(modal);

      // Show/hide conditional fields
      function updateTypeFields() {
        const type = document.getElementById('reEditType').value;
        document.getElementById('reEditDayOfWeekRow').style.display = type === 'weekly' ? 'block' : 'none';
        document.getElementById('reEditDayOfMonthRow').style.display = type === 'monthly' ? 'block' : 'none';
      }
      updateTypeFields();
      document.getElementById('reEditType').addEventListener('change', updateTypeFields);

      const closeModal = () => { overlay.remove(); modal.remove(); };
      overlay.addEventListener('click', closeModal);
      document.getElementById('reEditCancel').addEventListener('click', closeModal);

      document.getElementById('reEditSave').addEventListener('click', () => {
        const emoji = document.getElementById('reEditEmoji').value.trim() || '⏰';
        const name = document.getElementById('reEditName').value.trim();
        if (!name) return;
        const type = document.getElementById('reEditType').value;
        const time = document.getElementById('reEditTime').value || '09:00';
        const tab = document.getElementById('reEditTab').value;
        const message = document.getElementById('reEditMessage').value.trim();
        const dayOfWeek = parseInt(document.getElementById('reEditDayOfWeek').value);
        const dayOfMonth = parseInt(document.getElementById('reEditDayOfMonth').value) || 1;

        if (existing) {
          existing.emoji = emoji;
          existing.name = name;
          existing.type = type;
          existing.time = time;
          existing.tab = tab;
          existing.message = message;
          if (type === 'weekly') existing.dayOfWeek = dayOfWeek;
          if (type === 'monthly') existing.dayOfMonth = dayOfMonth;
        } else {
          const newRoutine = {
            id: 'r' + Date.now(),
            emoji, name, type, time, tab, message, enabled: true,
          };
          if (type === 'weekly') newRoutine.dayOfWeek = dayOfWeek;
          if (type === 'monthly') newRoutine.dayOfMonth = dayOfMonth;
          routines.push(newRoutine);
        }
        saveRoutines(routines);
        closeModal();
        renderSettingsView();
      });

      if (existing) {
        document.getElementById('reEditDelete').addEventListener('click', () => {
          routines = routines.filter(r => r.id !== routineId);
          saveRoutines(routines);
          closeModal();
          renderSettingsView();
        });
      }
    }

    // ============================================================
    // ===== INITIALIZATION (Routines & SW) =====
    // ============================================================
    registerServiceWorker();
    if (getNotifPermission() === 'granted') startRoutineCheck();

  </script>
</body>
</html>
